<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Legacy Platform — Enterprise Edition</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&family=Inter:wght@300;400;500;600&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg-dark: #020617;
      --text-white: #ffffff;
      --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.15);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      --primary: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'Poppins', 'Inter', sans-serif;
      background: var(--bg-dark);
      color: var(--text-white);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* ================= HEADER ================= */
    header {
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 48px;
      background: rgba(2, 6, 23, 0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      transition: all 0.3s ease;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 18px;
      flex-shrink: 0;
    }

    .brand-text strong {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 22px;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .brand-text span {
      font-size: 11px;
      letter-spacing: 3px;
      color: var(--primary);
      display: block;
    }

    /* Navegação Topo */
    .header-nav {
      display: flex;
      gap: 30px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .header-nav::-webkit-scrollbar { display: none; }

    .nav-link {
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 5px;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
    }

    .nav-link:hover, .nav-link.active {
      color: #fff;
      border-bottom-color: var(--primary);
    }

    .header-spacer { width: 50px; }

    /* ================= MAIN STRUCTURE ================= */
    main {
      padding-top: 110px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      padding-bottom: 100px;
    }

    /* Blobs de Fundo */
    .background-blobs {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 0; pointer-events: none; overflow: hidden;
      position: fixed;
    }

    .blob {
      position: absolute; border-radius: 50%;
      filter: blur(80px); opacity: 0.6;
    }
    .blob-1 {
      width: 500px; height: 500px; background: #ff007a;
      top: 20%; left: 20%; animation: float 6s ease-in-out infinite;
    }
    .blob-2 {
      width: 400px; height: 400px; background: #3b82f6;
      bottom: 10%; right: 20%; animation: float 8s ease-in-out infinite reverse;
    }

    @keyframes float {
      0% { transform: translate(0, 0); }
      50% { transform: translate(30px, -30px); }
      100% { transform: translate(0, 0); }
    }

    /* ================= GLASS CARDS (DASHBOARD) ================= */
    .glass-slider-container {
      position: relative; z-index: 10;
      display: flex; gap: 30px; padding: 20px;
      width: 100%; max-width: 1200px;
      justify-content: center; 
      flex-wrap: wrap;
      margin-bottom: 80px;
    }

    .glass-card {
      width: 300px; height: 420px;
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 30px;
      display: flex; flex-direction: column;
      align-items: center; text-align: center;
      box-shadow: var(--glass-shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      color: #fff;
      flex-shrink: 0;
    }
    .glass-card:hover {
      transform: translateY(-10px);
      background: rgba(255, 255, 255, 0.12);
    }

    .card-img-wrapper {
      width: 100px; height: 100px;
      border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.3);
      margin-bottom: 20px;
      overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.2);
    }
    .card-img-wrapper i { font-size: 40px; color: #fff; }

    .card-title { font-size: 22px; font-weight: 600; margin-bottom: 5px; }
    .card-role { font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 30px; }

    .btn-glass {
      margin-top: auto;
      background: #ffffff; color: #020617;
      border: none; padding: 12px 30px;
      border-radius: 8px; font-weight: 600;
      cursor: pointer; transition: 0.3s;
      text-transform: uppercase; font-size: 13px; letter-spacing: 1px;
    }
    .btn-glass:hover {
      background: var(--primary); color: white;
      box-shadow: 0 0 15px var(--primary);
    }

    /* ================= PRICING SECTION ================= */
    #planos {
      width: 100%; text-align: center; padding: 40px 20px;
      z-index: 10; position: relative;
    }
    #planos h2 { font-size: 2.8rem; font-weight: 800; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); line-height: 1.2; }
    #planos p { max-width: 800px; margin: 0 auto 50px; color: rgba(255,255,255,0.8); font-size: 1.1rem; }

    .pricing-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
      gap: 20px;
      max-width: 1300px;
      margin: 0 auto;
      padding: 0 10px;
      align-items: stretch;
    }

    .price-card {
      position: relative;
      background: rgba(15, 23, 42, 0.6); 
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 30px 25px;
      backdrop-filter: blur(12px);
      transition: .3s;
      display: flex; flex-direction: column;
      text-align: left;
    }

    .price-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px -10px rgba(0,0,0,.6); }
    
    .price-card.featured {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.08);
      box-shadow: 0 0 30px rgba(59,130,246,.2);
      transform: scale(1.02);
      z-index: 11;
    }
    .price-card.featured:hover { transform: scale(1.02) translateY(-8px); }

    .badge-best {
      position: absolute; top: -14px; left: 50%; transform: translateX(-50%);
      background: var(--primary); color: #fff; padding: 6px 20px; border-radius: 20px;
      font-size: .75rem; font-weight: 700; text-transform: uppercase;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }

    .plan-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 5px; }
    .plan-desc { font-size: .85rem; color: rgba(255,255,255,.6); margin-bottom: 20px; min-height: 40px; }

    .price-box { margin-bottom: 5px; }
    .price-value { font-size: 2.2rem; font-weight: 800; color: #fff; }
    .price-suffix { font-size: 1rem; color: rgba(255,255,255,0.6); font-weight: 400; }
    
    .billing-note {
        font-size: 0.8rem;
        color: var(--success);
        font-weight: 500;
        margin-bottom: 25px;
        display: block;
        min-height: 20px;
    }

    .feature-list { list-style: none; padding: 0; margin-bottom: 30px; text-align: left; margin-top: auto; }
    .feature-list li { display: flex; gap: 10px; margin-bottom: 12px; font-size: .85rem; align-items: flex-start; line-height: 1.4; color: rgba(255,255,255,0.85); }
    .feature-list li i { color: var(--primary); margin-top: 3px; font-size: 0.9rem; flex-shrink: 0; }
    .feature-list li.disabled { color: rgba(255,255,255,0.4); }
    .feature-list li.disabled i { color: rgba(255,255,255,0.3); }

    .btn-select-plan {
      width: 100%;
      padding: 12px; border-radius: 10px;
      background: transparent; color: #fff;
      border: 1px solid rgba(255,255,255,.2); cursor: pointer;
      transition: 0.3s; font-weight: 600; font-size: 0.9rem;
    }
    .btn-select-plan:hover { background: rgba(255,255,255,0.1); border-color: #fff; }
    
    .price-card.featured .btn-select-plan { background: var(--primary); border-color: var(--primary); }
    .price-card.featured .btn-select-plan:hover { background: #2563eb; }

    /* ================= MODAL ================= */
    #paymentModal {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.9); z-index: 3000;
      align-items: center; justify-content: center;
      backdrop-filter: blur(5px);
    }
    #paymentModal .modal-box {
      background: #0f172a; padding: 30px; border-radius: 20px;
      max-width: 420px; width: 90%; text-align: center;
      border: 1px solid var(--glass-border);
      box-shadow: 0 0 50px rgba(59,130,246,0.3);
    }
    #paymentModal button {
      margin-top: 20px; padding: 12px 24px; border-radius: 10px;
      border: none; background: var(--primary); color: #fff; cursor: pointer;
      font-weight: bold; transition: 0.3s;
    }
    #paymentModal button:hover { transform: scale(1.05); }

    /* CUBE & ANIMATIONS */
    .cube-header-wrapper { width: 50px; height: 50px; perspective: 800px; }
    .cube-header { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; animation: rotateCube 12s linear infinite; }
    .cube-face { position: absolute; width: 50px; height: 50px; background: rgba(59,130,246,0.2); border: 1px solid rgba(147,197,253,0.8); display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .face-front { transform: rotateY(0deg) translateZ(25px); } .face-back { transform: rotateY(180deg) translateZ(25px); }
    .face-right { transform: rotateY(90deg) translateZ(25px); } .face-left { transform: rotateY(-90deg) translateZ(25px); }
    .face-top { transform: rotateX(90deg) translateZ(25px); } .face-bottom { transform: rotateX(-90deg) translateZ(25px); }
    @keyframes rotateCube { 0% { transform: rotateX(22deg) rotateY(0deg); } 100% { transform: rotateX(22deg) rotateY(360deg); } }
    
    .slider-arrow { color: rgba(255,255,255,0.5); font-size: 2rem; cursor: pointer; padding: 0 20px; transition: 0.3s; }
    .slider-arrow:hover { color: #fff; transform: scale(1.1); }

    /* ================= PORTAL DO CLIENTE (ATUALIZADO) ================= */
    #plataforma_overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 4000;
      backdrop-filter: blur(10px);
    }

    #plataforma_admin_modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 5000;
      align-items: center;
      justify-content: center;
    }

    .plataforma_container {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--bg-dark);
      z-index: 4001;
      overflow-y: auto;
    }

    .plataforma_modal_box {
      background: #0f172a;
      border-radius: 20px;
      border: 1px solid var(--glass-border);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      position: relative;
      max-width: 500px;
      width: 90%;
      margin: 50px auto;
      padding: 40px;
    }

    .plataforma_header {
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 30px;
      background: rgba(2, 6, 23, 0.95);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .plataforma_header_brand {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .plataforma_header_brand strong {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 18px;
      color: #fff;
    }

    .plataforma_header_brand span {
      font-size: 10px;
      color: var(--primary);
      display: block;
    }

    .plataforma_card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
    }

    .plataforma_card_title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .plataforma_status {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: auto;
    }

    .plataforma_status.pendente { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .plataforma_status.andamento { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
    .plataforma_status.concluido { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .plataforma_status.aguardando { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }

    .plataforma_timeline {
      position: relative;
      padding-left: 30px;
      margin: 20px 0;
    }

    .plataforma_timeline::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: rgba(59, 130, 246, 0.3);
    }

    .plataforma_timeline_item {
      position: relative;
      margin-bottom: 25px;
    }

    .plataforma_timeline_item::before {
      content: '';
      position: absolute;
      left: -20px;
      top: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
    }

    .plataforma_timeline_date {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 5px;
    }

    .plataforma_link_list {
      list-style: none;
      padding: 0;
    }

    .plataforma_link_item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      margin-bottom: 10px;
      transition: 0.3s;
      text-decoration: none;
      color: inherit;
    }

    .plataforma_link_item:hover {
      background: rgba(59, 130, 246, 0.1);
      transform: translateX(5px);
    }

    .plataforma_input_group {
      margin-bottom: 20px;
    }

    .plataforma_label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
    }

    .plataforma_input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: #fff;
      font-family: 'Poppins', sans-serif;
    }

    .plataforma_input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .plataforma_textarea {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: #fff;
      font-family: 'Poppins', sans-serif;
      min-height: 120px;
      resize: vertical;
    }

    .plataforma_btn {
      padding: 12px 24px;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
      font-family: 'Poppins', sans-serif;
    }

    .plataforma_btn_primary {
      background: var(--primary);
      color: white;
    }

    .plataforma_btn_primary:hover {
      background: #2563eb;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
    }

    .plataforma_btn_secondary {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .plataforma_btn_secondary:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .plataforma_btn_small {
      padding: 8px 16px;
      font-size: 0.85rem;
    }

    .plataforma_btn_danger {
      background: var(--danger);
      color: white;
    }

    .plataforma_btn_danger:hover {
      background: #dc2626;
    }

    .plataforma_btn_success {
      background: var(--success);
      color: white;
    }

    .plataforma_btn_success:hover {
      background: #059669;
    }

    .plataforma_btn_warning {
      background: var(--warning);
      color: white;
    }

    .plataforma_btn_warning:hover {
      background: #d97706;
    }

    .plataforma_admin_grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .plataforma_table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    .plataforma_table th,
    .plataforma_table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .plataforma_table th {
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      background: rgba(255, 255, 255, 0.03);
    }

    .plataforma_table tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .plataforma_badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .plataforma_badge.success { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .plataforma_badge.warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
    .plataforma_badge.danger { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .plataforma_badge.info { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }

    .plataforma_alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .plataforma_alert.info {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--primary);
    }

    .plataforma_alert.warning {
      background: rgba(245, 158, 11, 0.1);
      border-left: 4px solid #f59e0b;
    }

    .plataforma_alert.danger {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid #ef4444;
    }

    .plataforma_alert.success {
      background: rgba(34, 197, 94, 0.1);
      border-left: 4px solid #10b981;
    }

    #plataforma_admin_access {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.5);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      opacity: 0.3;
      transition: 0.3s;
    }

    #plataforma_admin_access:hover {
      opacity: 1;
      background: rgba(59, 130, 246, 0.3);
      transform: scale(1.1);
    }

    /* NOVOS ESTILOS PARA ALERTAS E NOTIFICAÇÕES */
    .alerta-whatsapp-btn {
      background: #25D366;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85rem;
      transition: 0.3s;
    }

    .alerta-whatsapp-btn:hover {
      background: #128C7E;
      transform: scale(1.05);
    }

    .alerta-config-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .alerta-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .alerta-status.pendente { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .alerta-status.enviado { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .alerta-status.agendado { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }

    .vencimento-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 4px solid transparent;
    }

    .vencimento-item.vencido {
      border-left-color: var(--danger);
      background: rgba(239, 68, 68, 0.05);
    }

    .vencimento-item.proximo {
      border-left-color: var(--warning);
      background: rgba(245, 158, 11, 0.05);
    }

    .vencimento-item.ok {
      border-left-color: var(--success);
    }

    .lembrete-item {
      background: rgba(59, 130, 246, 0.05);
      border-left: 4px solid var(--primary);
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    /* Área de Notificações Administrativas */
    .notificacoes-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--danger);
      color: white;
      font-size: 0.7rem;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .notificacao-item {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid var(--danger);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notificacao-item .info {
      flex: 1;
    }

    .notificacao-item .acoes {
      display: flex;
      gap: 10px;
    }

    /* CPF Input Styles */
    .cpf-input {
      font-family: monospace;
      letter-spacing: 1px;
    }

    /* MEDIA QUERIES */
    @media (max-width: 1000px) {
      header { padding: 15px 20px; height: auto; flex-direction: column; gap: 20px; }
      .header-nav { width: 100%; justify-content: center; padding-bottom: 5px; gap: 20px; }
      .header-spacer { display: none; }
      
      .glass-slider-container {
        flex-wrap: nowrap; justify-content: flex-start; overflow-x: auto;
        scroll-snap-type: x mandatory; padding: 20px 20px 60px 20px; width: 100%;
      }
      .glass-card { min-width: 85vw; margin-right: 15px; scroll-snap-align: center; }
      .slider-arrow { display: none; }
      main { padding-top: 160px; }
      
      .pricing-grid { grid-template-columns: 1fr; max-width: 400px; }

      .plataforma_modal_box {
        width: 95%;
        padding: 25px;
        margin: 20px auto;
      }

      .plataforma_header {
        padding: 0 20px;
        height: 70px;
      }

      .plataforma_admin_grid {
        grid-template-columns: 1fr;
      }

      .notificacao-item {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }

      .notificacao-item .acoes {
        width: 100%;
        justify-content: flex-end;
      }
    }

    @keyframes plataforma_fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .plataforma_fade_in {
      animation: plataforma_fadeIn 0.5s ease-out;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .pulse {
      animation: pulse 2s infinite;
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="cube-header-wrapper">
      <div class="cube-header">
        <div class="cube-face face-front"><i class="fas fa-chart-line"></i></div>
        <div class="cube-face face-back"><i class="fas fa-users"></i></div>
        <div class="cube-face face-right"><i class="fas fa-project-diagram"></i></div>
        <div class="cube-face face-left"><i class="fas fa-wallet"></i></div>
        <div class="cube-face face-top"><i class="fas fa-cube"></i></div>
        <div class="cube-face face-bottom"><i class="fas fa-database"></i></div>
      </div>
    </div>
    <div class="brand-text">
      <strong>Legacy Platform</strong>
      <span>ENTERPRISE <i class="fas fa-cloud"></i> CLOUD</span>
    </div>
  </div>

  <nav class="header-nav">
    <a href="#" class="nav-link active"><i class="fas fa-chart-pie"></i> Dashboard</a>
    <a href="#planos" class="nav-link"><i class="fas fa-layer-group"></i> Planos</a>
    <a href="#" class="nav-link"><i class="fas fa-book"></i> Base/KB</a>
    <a href="https://wa.me/5522992497662" target="_blank" class="nav-link"><i class="fas fa-headset"></i> Suporte</a>
    <!-- NOVO BOTÃO: ACESSO DE CLIENTES -->
    <a href="#cliente" class="nav-link" onclick="plataforma_showLoginModal()">
      <i class="fas fa-user-tie"></i> Clientes
    </a>
  </nav>
  
  <div class="header-spacer"></div>
</header>
<main>
  <div class="background-blobs">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
  </div>
<div class="glass-slider-container">
    <div class="slider-arrow">
      <i class="fas fa-chevron-left"></i>
    </div>

    <div class="glass-card">
      <div class="card-img-wrapper">
        <i class="fas fa-users"></i>
      </div>
      <h3 class="card-title">Legacy Cloud CRM</h3>
      <p class="card-role">Enterprise Edition</p>
      <button class="btn-glass" onclick="abrirPopup('https://legacycrm.netlify.app/')">
        Acessar Sistema
      </button>
    </div>

    <div class="glass-card">
      <div class="card-img-wrapper">
        <i class="fas fa-file-signature"></i>
      </div>
      <h3 class="card-title">Legacy Contracts</h3>
      <p class="card-role">Gestão de Contratos</p>
      <button class="btn-glass" onclick="abrirPopup('https://legacycontratos.netlify.app')">
        Acessar Sistema
      </button>
    </div>

    <div class="glass-card">
      <div class="card-img-wrapper">
        <i class="fas fa-clipboard-check"></i>
      </div>
      <h3 class="card-title">Legacy Forms</h3>
      <p class="card-role">Gestão de Formulários</p>
      <button class="btn-glass" onclick="abrirPopup('https://legacyforms.netlify.app')">
        Acessar Sistema
      </button>
    </div>

    <div class="slider-arrow">
      <i class="fas fa-chevron-right"></i>
    </div>
  </div>

  <section id="planos">
    <h2>Seu negócio não pode viver preso no WhatsApp.<br>Nem desaparecer quando você troca de celular.</h2>
    <p>Com a Legacy você organiza clientes, conversas, financeiro, agenda e contratos em um sistema em nuvem seguro, para você nunca mais perder informações ou oportunidades.</p>
    
    <div class="pricing-grid">
      <div class="price-card">
        <h3 class="plan-title">SaaS Flex</h3>
        <p class="plan-desc">Para quem busca liberdade sem fidelidade longa.</p>
        <div class="price-box">
          <span class="price-value">R$ 60</span><span class="price-suffix">/mês</span>
        </div>
        <span class="billing-note">Cobrança recorrente mensal</span>
        <ul class="feature-list">
          <li><i class="fas fa-check-circle"></i> Acesso Multi-device Android e Pc</li>
          <li><i class="fas fa-rocket"></i> Implantação guiada</li>
          <li><i class="fas fa-clock"></i> 3 Tickets Suporte/mês</li>
          <li class="disabled"><i class="fas fa-ban"></i> Sem fidelidade</li>
        </ul>
        <button class="btn-select-plan" onclick="openPayment('SaaS Flex Mensal', 60)">Assinar Mensal</button>
      </div>

      <div class="price-card">
        <h3 class="plan-title">Starter</h3>
        <p class="plan-desc">O pacote inicial ideal para organizar a casa.</p>
        <div class="price-box">
          <span class="price-value">R$150</span><span class="price-suffix">Pgto único</span>
        </div>
        <span class="billing-note">Equivalente a R$50/mês</span>
        <ul class="feature-list">
          <li><i class="fas fa-check-circle"></i> Acesso Multi-device Android e Pc</li>
          <li><i class="fas fa-laptop-code"></i> Implantação Guiada</li>
          <li><i class="fas fa-ticket-alt"></i> 5 Tickets Suporte/mês</li>
        </ul>
        <button class="btn-select-plan" onclick="openPayment('Starter Trimestral', 150)">Assinar Trimestral</button>
      </div>

      <div class="price-card featured">
        <div class="badge-best">MAIS POPULAR</div>
        <h3 class="plan-title">Manager <i class="fas fa-crown" style="color: #facc15;"></i></h3>
        <p class="plan-desc">Gestão completa e suporte estendido.</p>
        <div class="price-box">
          <span class="price-value">R$600</span><span class="price-suffix">Pgto único</span>
        </div>
        <span class="billing-note">Equivalente a R$50/mês</span>
        <ul class="feature-list">
        <li><i class="fas fa-check-circle"></i> Acesso Multi-device Android e Pc</li>
          <li><i class="fas fa-laptop-code"></i> Implantação com o usuário</li>
          <li><i class="fas fa-ticket-alt"></i> 8 Tickets Suporte/mês</li>
        </ul>
        <button class="btn-select-plan" onclick="openPayment('Manager Anual', 600)">Assinar Anual</button>
      </div>

      <div class="price-card">
        <h3 class="plan-title">Controller</h3>
        <p class="plan-desc">Equilíbrio perfeito entre custo e prazo.</p>
        <div class="price-box">
          <span class="price-value">R$300</span><span class="price-suffix">Pgto único</span>
        </div>
        <span class="billing-note">Equivalente a R$50/mês</span>
        <ul class="feature-list">
          <li><i class="fas fa-check-circle"></i> Acesso Multi-device Android e Pc</li>
          <li><i class="fas fa-laptop-code"></i> Implantação Guiada</li>
          <li><i class="fas fa-ticket-alt"></i> 5 Tickets Suporte/mês</li>
        </ul>
        <button class="btn-select-plan" onclick="openPayment('Controller Semestral', 300)">Assinar Semestral</button>
      </div>
    </div>
  </section>
</main>

<!-- Botão de acesso administrativo (oculto) -->
<div id="plataforma_admin_access" title="Acesso Administrativo">
  <i class="fas fa-cogs"></i>
</div>

<!-- Overlay do Portal -->
<div id="plataforma_overlay"></div>

<!-- Portal do Cliente -->
<div id="plataforma_client_portal" class="plataforma_container">
  <div class="plataforma_header">
    <div class="plataforma_header_brand">
      <div style="width: 40px; height: 40px; background: rgba(59, 130, 246, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
        <i class="fas fa-user-tie" style="color: var(--primary);"></i>
      </div>
      <div>
        <strong>Portal do Cliente</strong>
        <span>LEGACY PLATFORM</span>
      </div>
    </div>
    <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="plataforma_logout()">
      <i class="fas fa-sign-out-alt"></i> Sair
    </button>
  </div>

  <div style="max-width: 1200px; margin: 0 auto; padding: 30px;">
    <!-- Informações do Cliente -->
    <div class="plataforma_card plataforma_fade_in">
      <h2 class="plataforma_card_title" id="plataforma_client_name">
        <i class="fas fa-user-circle"></i> Carregando...
      </h2>
      <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px;">
        <div>
          <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.6);">Status</div>
          <div class="plataforma_badge success" id="plataforma_client_status">Ativo</div>
        </div>
        <div>
          <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.6);">Último acesso</div>
          <div id="plataforma_last_access">-</div>
        </div>
        <div>
          <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.6);">CPF</div>
          <div id="plataforma_client_cpf">•••••••••••</div>
        </div>
      </div>
    </div>

    <!-- Projeto Atual -->
    <div class="plataforma_card plataforma_fade_in">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <h2 class="plataforma_card_title">
          <i class="fas fa-project-diagram"></i> Projeto Atual
        </h2>
        <span class="plataforma_status andamento" id="plataforma_project_status">Em andamento</span>
      </div>
      
      <h3 style="margin-bottom: 10px; color: #fff;" id="plataforma_project_title">Carregando projeto...</h3>
      <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 20px;" id="plataforma_project_desc"></p>
      
      <!-- Progresso -->
      <div style="margin-bottom: 25px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">Progresso</span>
          <span style="font-size: 0.9rem; font-weight: 600;" id="plataforma_progress_text">0%</span>
        </div>
        <div style="height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
          <div id="plataforma_progress_bar" style="height: 100%; background: linear-gradient(90deg, var(--primary), #60a5fa); width: 0%; transition: width 0.5s ease;"></div>
        </div>
      </div>

      <!-- Timeline -->
      <h3 style="margin: 25px 0 15px; color: #fff; font-size: 1.1rem;">
        <i class="fas fa-history"></i> Linha do Tempo
      </h3>
      <div class="plataforma_timeline" id="plataforma_timeline">
        <div class="plataforma_timeline_item">
          <div class="plataforma_timeline_date">Carregando...</div>
          <div style="color: rgba(255, 255, 255, 0.9);">Aguardando dados</div>
        </div>
      </div>
    </div>

    <!-- Links Importantes -->
    <div class="plataforma_card plataforma_fade_in">
      <h2 class="plataforma_card_title">
        <i class="fas fa-link"></i> Links Importantes
      </h2>
      <ul class="plataforma_link_list" id="plataforma_links_list">
        <li>
          <a href="#" class="plataforma_link_item">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Carregando links...</span>
          </a>
        </li>
      </ul>
    </div>

    <!-- Orientações -->
    <div class="plataforma_card plataforma_fade_in">
      <h2 class="plataforma_card_title">
        <i class="fas fa-graduation-cap"></i> Orientações
      </h2>
      <div id="plataforma_orientacoes">
        <div class="plataforma_alert info">
          <i class="fas fa-info-circle"></i>
          <div>Carregando orientações...</div>
        </div>
      </div>
    </div>

    <!-- Prazos e Datas -->
    <div class="plataforma_card plataforma_fade_in">
      <h2 class="plataforma_card_title">
        <i class="fas fa-calendar-alt"></i> Prazos e Datas
      </h2>
      <div id="plataforma_prazos">
        <div class="plataforma_alert warning">
          <i class="fas fa-clock"></i>
          <div>Carregando prazos...</div>
        </div>
      </div>
    </div>

    <!-- Lembretes -->
    <div class="plataforma_card plataforma_fade_in">
      <h2 class="plataforma_card_title">
        <i class="fas fa-bell"></i> Lembretes
      </h2>
      <div id="plataforma_lembretes">
        <div class="plataforma_alert info">
          <i class="fas fa-info-circle"></i>
          <div>Carregando lembretes...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Área Administrativa -->
<div id="plataforma_admin_portal" class="plataforma_container">
  <div class="plataforma_header">
    <div class="plataforma_header_brand">
      <div style="width: 40px; height: 40px; background: rgba(239, 68, 68, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
        <i class="fas fa-user-shield" style="color: #ef4444;"></i>
      </div>
      <div>
        <strong>Área Administrativa</strong>
        <span>PORTAL DO CLIENTE</span>
      </div>
    </div>
    <div style="display: flex; gap: 10px;">
      <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="plataforma_admin_showDashboard()">
        <i class="fas fa-tachometer-alt"></i> Dashboard
      </button>
      <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="plataforma_admin_showSection('notificacoes')" id="plataforma_notificacoes_btn">
        <i class="fas fa-bell"></i> Notificações
        <span class="notificacoes-badge" id="plataforma_notificacoes_count" style="display: none;">0</span>
      </button>
      <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="plataforma_admin_logout()">
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>
    </div>
  </div>

  <div style="max-width: 1400px; margin: 0 auto; padding: 30px;">
    <!-- Dashboard Admin -->
    <div id="plataforma_admin_dashboard">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="font-size: 1.8rem; color: #fff;">Dashboard Administrativo</h1>
        <button class="plataforma_btn plataforma_btn_primary" onclick="plataforma_admin_showSection('clientes')">
          <i class="fas fa-plus"></i> Novo Cliente
        </button>
      </div>

      <!-- Cards de Resumo -->
      <div class="plataforma_admin_grid">
        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-users"></i> Clientes
          </h3>
          <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary); margin: 10px 0;" id="plataforma_admin_total_clientes">0</div>
          <div style="color: rgba(255, 255, 255, 0.6);">Clientes cadastrados</div>
        </div>

        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-project-diagram"></i> Projetos
          </h3>
          <div style="font-size: 2.5rem; font-weight: 800; color: #10b981; margin: 10px 0;" id="plataforma_admin_total_projetos">0</div>
          <div style="color: rgba(255, 255, 255, 0.6);">Projetos ativos</div>
        </div>

        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-bell"></i> Alertas Pendentes
          </h3>
          <div style="font-size: 2.5rem; font-weight: 800; color: #f59e0b; margin: 10px 0;" id="plataforma_admin_total_alertas">0</div>
          <div style="color: rgba(255, 255, 255, 0.6);">Notificações a enviar</div>
        </div>

        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-clock"></i> Vencimentos Hoje
          </h3>
          <div style="font-size: 2.5rem; font-weight: 800; color: #ef4444; margin: 10px 0;" id="plataforma_admin_total_vencimentos">0</div>
          <div style="color: rgba(255, 255, 255, 0.6);">Prazos a vencer</div>
        </div>
      </div>

      <!-- Lista de Clientes -->
      <div class="plataforma_card" style="margin-top: 30px;">
        <h3 class="plataforma_card_title">
          <i class="fas fa-list"></i> Lista de Clientes
        </h3>
        <div style="overflow-x: auto;">
          <table class="plataforma_table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>CPF</th>
                <th>WhatsApp</th>
                <th>Status</th>
                <th>Projeto</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="plataforma_admin_clientes_list">
              <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">
                  <i class="fas fa-spinner fa-spin"></i> Carregando clientes...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Gestão de Clientes -->
    <div id="plataforma_admin_clientes" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="font-size: 1.8rem; color: #fff;">
          <i class="fas fa-user-plus"></i> Gestão de Clientes
        </h1>
        <button class="plataforma_btn plataforma_btn_secondary" onclick="plataforma_admin_showDashboard()">
          <i class="fas fa-arrow-left"></i> Voltar
        </button>
      </div>

      <div class="plataforma_admin_grid">
        <!-- Formulário de Cadastro -->
        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-plus-circle"></i> Novo Cliente
          </h3>
          <div class="plataforma_input_group">
            <label class="plataforma_label">Nome Completo *</label>
            <input type="text" class="plataforma_input" id="plataforma_novo_nome" placeholder="Nome do cliente">
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Email *</label>
            <input type="email" class="plataforma_input" id="plataforma_novo_email" placeholder="email@cliente.com">
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">CPF (Será a senha) *</label>
            <input type="text" class="plataforma_input cpf-input" id="plataforma_novo_cpf" placeholder="000.000.000-00" maxlength="14">
            <small style="color: rgba(255,255,255,0.5); font-size: 0.8rem; display: block; margin-top: 5px;">
              O CPF será usado como senha de acesso do cliente
            </small>
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Telefone WhatsApp *</label>
            <input type="text" class="plataforma_input" id="plataforma_novo_whatsapp" placeholder="(00) 00000-0000">
          </div>

          <div class="plataforma_input_group">
            <label class="plataforma_label">Status</label>
            <select class="plataforma_input" id="plataforma_novo_status">
              <option value="ativo">Ativo</option>
              <option value="inativo">Inativo</option>
              <option value="pendente">Pendente</option>
            </select>
          </div>

          <button class="plataforma_btn plataforma_btn_primary" style="width: 100%;" onclick="plataforma_admin_salvarCliente()">
            <i class="fas fa-save"></i> Salvar Cliente
          </button>
        </div>

        <!-- Formulário de Projeto -->
        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-project-diagram"></i> Projeto do Cliente
          </h3>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Cliente</label>
            <select class="plataforma_input" id="plataforma_projeto_cliente" onchange="plataforma_admin_carregarProjetoCliente()">
              <option value="">Selecione um cliente</option>
            </select>
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Título do Projeto *</label>
            <input type="text" class="plataforma_input" id="plataforma_projeto_titulo" placeholder="Nome do projeto">
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Descrição</label>
            <textarea class="plataforma_textarea" id="plataforma_projeto_desc" placeholder="Descreva o projeto..."></textarea>
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Status do Projeto</label>
            <select class="plataforma_input" id="plataforma_projeto_status">
              <option value="pendente">Pendente</option>
              <option value="andamento">Em andamento</option>
              <option value="concluido">Concluído</option>
              <option value="aguardando">Aguardando</option>
            </select>
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Progresso (%)</label>
            <input type="range" class="plataforma_input" id="plataforma_projeto_progresso" min="0" max="100" step="5" value="0">
            <div style="text-align: center; margin-top: 5px;">
              <span id="plataforma_projeto_progresso_text">0%</span>
            </div>
          </div>

          <button class="plataforma_btn plataforma_btn_primary" style="width: 100%;" onclick="plataforma_admin_salvarProjeto()">
            <i class="fas fa-save"></i> Salvar Projeto
          </button>
        </div>

        <!-- Gestão de Conteúdo -->
        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-cog"></i> Conteúdo do Portal
          </h3>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Cliente</label>
            <select class="plataforma_input" id="plataforma_conteudo_cliente" onchange="plataforma_admin_carregarConteudoCliente()">
              <option value="">Selecione um cliente</option>
            </select>
          </div>

          <div class="plataforma_input_group">
            <label class="plataforma_label">Adicionar Link</label>
            <input type="text" class="plataforma_input" id="plataforma_novo_link_nome" placeholder="Nome do link">
            <input type="text" class="plataforma_input" style="margin-top: 8px;" id="plataforma_novo_link_url" placeholder="https://exemplo.com">
            <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" style="width: 100%; margin-top: 10px;" onclick="plataforma_admin_adicionarLink()">
              <i class="fas fa-plus"></i> Adicionar Link
            </button>
          </div>

          <div class="plataforma_input_group">
            <label class="plataforma_label">Adicionar Orientação</label>
            <textarea class="plataforma_textarea" id="plataforma_nova_orientacao" placeholder="Digite uma orientação..."></textarea>
            <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" style="width: 100%; margin-top: 10px;" onclick="plataforma_admin_adicionarOrientacao()">
              <i class="fas fa-plus"></i> Adicionar
            </button>
          </div>

          <div class="plataforma_input_group">
            <label class="plataforma_label">Adicionar Prazo</label>
            <input type="text" class="plataforma_input" id="plataforma_novo_prazo_titulo" placeholder="Título do prazo">
            <input type="date" class="plataforma_input" style="margin-top: 8px;" id="plataforma_novo_prazo_data">
            <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" style="width: 100%; margin-top: 10px;" onclick="plataforma_admin_adicionarPrazo()">
              <i class="fas fa-plus"></i> Adicionar Prazo
            </button>
          </div>

          <div class="plataforma_input_group">
            <label class="plataforma_label">Adicionar Lembrete</label>
            <textarea class="plataforma_textarea" id="plataforma_novo_lembrete" placeholder="Digite um lembrete..."></textarea>
            <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" style="width: 100%; margin-top: 10px;" onclick="plataforma_admin_adicionarLembrete()">
              <i class="fas fa-plus"></i> Adicionar Lembrete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notificações de Vencimentos -->
    <div id="plataforma_admin_notificacoes" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="font-size: 1.8rem; color: #fff;">
          <i class="fas fa-bell"></i> Notificações de Vencimentos
        </h1>
        <button class="plataforma_btn plataforma_btn_secondary" onclick="plataforma_admin_showDashboard()">
          <i class="fas fa-arrow-left"></i> Voltar
        </button>
      </div>

      <div class="plataforma_card">
        <h3 class="plataforma_card_title">
          <i class="fas fa-exclamation-triangle"></i> Alertas Pendentes
        </h3>
        <div id="plataforma_admin_alertas_lista">
          <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">
            <i class="fas fa-spinner fa-spin"></i> Carregando alertas...
          </div>
        </div>
      </div>

      <div class="plataforma_card" style="margin-top: 30px;">
        <h3 class="plataforma_card_title">
          <i class="fas fa-sliders-h"></i> Configuração de Alertas
        </h3>
        
        <div class="alerta-config-container">
          <div class="plataforma_input_group">
            <label class="plataforma_label">Dias para alerta antecipado</label>
            <input type="number" class="plataforma_input" id="plataforma_alerta_dias" min="1" max="30" value="3">
            <small style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">
              Número de dias antes do vencimento para enviar alerta
            </small>
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Mensagem padrão de alerta</label>
            <textarea class="plataforma_textarea" id="plataforma_alerta_mensagem" placeholder="Digite a mensagem padrão para alertas..." rows="4">
Olá {nome}! Este é um lembrete sobre o prazo: {titulo}
Vencimento: {data}
Acesse seu portal para mais detalhes: {link_portal}
            </textarea>
            <small style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">
              Variáveis disponíveis: {nome}, {titulo}, {data}, {link_portal}
            </small>
          </div>
          
          <button class="plataforma_btn plataforma_btn_primary" onclick="plataforma_admin_salvarConfigAlertas()">
            <i class="fas fa-save"></i> Salvar Configurações
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Login do Cliente (ATUALIZADO PARA CPF) -->
<div id="plataforma_login_modal" class="plataforma_container">
  <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;">
    <div class="plataforma_modal_box plataforma_fade_in">
      <div style="text-align: center; margin-bottom: 30px;">
        <div style="width: 80px; height: 80px; background: rgba(59, 130, 246, 0.2); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
          <i class="fas fa-user-tie" style="font-size: 2rem; color: var(--primary);"></i>
        </div>
        <h2 style="color: #fff; margin-bottom: 10px;">Portal do Cliente</h2>
        <p style="color: rgba(255, 255, 255, 0.7);">Acesse com seu CPF cadastrado</p>
      </div>

      <div class="plataforma_input_group">
        <label class="plataforma_label">CPF (Somente números)</label>
        <input type="text" class="plataforma_input cpf-input" id="plataforma_input_cpf" placeholder="000.000.000-00" maxlength="14">
        <small style="color: rgba(255,255,255,0.5); font-size: 0.8rem; display: block; margin-top: 5px;">
          Digite seu CPF no formato: 000.000.000-00
        </small>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 25px;">
        <button class="plataforma_btn plataforma_btn_secondary" style="flex: 1;" onclick="plataforma_fecharLoginModal()">
          <i class="fas fa-arrow-left"></i> Voltar
        </button>
        <button class="plataforma_btn plataforma_btn_primary" style="flex: 2;" onclick="plataforma_login()">
          <i class="fas fa-sign-in-alt"></i> Entrar
        </button>
      </div>

      <div style="text-align: center; margin-top: 20px; color: rgba(255, 255, 255, 0.5); font-size: 0.85rem;">
        <i class="fas fa-info-circle"></i> Acesso exclusivo para clientes Legacy Platform
      </div>
    </div>
  </div>
</div>

<!-- Modal de Login Admin -->
<div id="plataforma_admin_modal">
  <div class="plataforma_modal_box plataforma_fade_in">
    <div style="text-align: center; margin-bottom: 30px;">
      <div style="width: 80px; height: 80px; background: rgba(239, 68, 68, 0.2); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
        <i class="fas fa-user-shield" style="font-size: 2rem; color: #ef4444;"></i>
      </div>
      <h2 style="color: #fff; margin-bottom: 10px;">Acesso Administrativo</h2>
      <p style="color: rgba(255, 255, 255, 0.7);">Área restrita para administradores</p>
    </div>

    <div class="plataforma_input_group">
      <label class="plataforma_label">Senha de Administrador</label>
      <input type="password" class="plataforma_input" id="plataforma_admin_senha" placeholder="Digite a senha administrativa">
    </div>

    <button class="plataforma_btn plataforma_btn_primary" style="width: 100%; background: #ef4444;" onclick="plataforma_admin_login()">
      <i class="fas fa-lock"></i> Acessar
    </button>

    <div style="text-align: center; margin-top: 20px;">
      <button class="plataforma_btn plataforma_btn_secondary" onclick="plataforma_admin_fecharModal()">
        <i class="fas fa-times"></i> Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal de Pagamento Original -->
<div id="paymentModal">
  <div class="modal-box">
    <div style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;">
      <i class="fas fa-shopping-cart"></i>
    </div>
    <h3>Confirmar Assinatura</h3>
    <p style="margin: 10px 0; color: rgba(255,255,255,0.7);">Você selecionou o plano:</p>
    <h2 id="modalPlanName" style="color: #fff; margin-bottom: 5px;"></h2>
    <strong id="modalPrice" style="font-size: 1.5rem; color: var(--success); display: block; margin-bottom: 20px;"></strong>
    <p style="font-size: 0.8rem; margin-bottom: 20px;">Você será redirecionado para finalizar a contratação via WhatsApp.</p>
    <div style="display: flex; gap: 10px; justify-content: center;">
      <button onclick="closePayment()" style="background: transparent; border: 1px solid rgba(255,255,255,0.3);">Cancelar</button>
      <button onclick="confirmarAssinatura()">Confirmar</button>
    </div>
  </div>
</div>

<script>
  // ==================== SISTEMA EXISTENTE (NÃO ALTERAR) ====================
  let planoSelecionado = "";
  let valorSelecionado = "";

  function abrirPopup(url) {
    const width = window.innerWidth * 0.9;
    const height = window.innerHeight * 0.9;
    const left = (window.innerWidth - width) / 2;
    const top = (window.innerHeight - height) / 2;
    const features = `width=${width},height=${height},top=${top},left=${left},resizable=yes,scrollbars=yes`;
    window.open(url, 'LegacySystemPopup', features);
  }

  const modal = document.getElementById('paymentModal');
  const modalName = document.getElementById('modalPlanName');
  const modalPrice = document.getElementById('modalPrice');

  function openPayment(name, price) {
    planoSelecionado = name;
    valorSelecionado = price;
    modalName.innerText = name;
    modalPrice.innerText = 'Total: R$ ' + price + ',00';
    modal.style.display = 'flex';
  }

  function closePayment() {
    modal.style.display = 'none';
  }

  function confirmarAssinatura() {
    const telefone = "5522992497662";
    const mensagem = encodeURIComponent(`Olá! Gostaria de assinar o plano ${planoSelecionado} no valor de R$ ${valorSelecionado},00.`);
    window.open(`https://wa.me/${telefone}?text=${mensagem}`, '_blank');
    closePayment();
  }

  window.onclick = function(event) {
    if (event.target == modal) closePayment();
  }

  // ==================== PORTAL DO CLIENTE (CORRIGIDO PARA USAR TEMPLATES SIMPLES) ====================
  const plataforma = {
    db: null,
    adminPassword: 'admin@legacy2024',
    currentUser: null,
    isAdmin: false,
    configAlertas: {
      diasAntecedencia: 3,
      mensagemPadrao: `Olá {nome}! Este é um lembrete sobre o prazo: {titulo}\nVencimento: {data}\nAcesse seu portal para mais detalhes: {link_portal}`
    }
  };

  // Máscara para CPF
  function formatarCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
    cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
    cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    return cpf;
  }

  // Aplicar máscara de CPF nos inputs
  document.addEventListener('DOMContentLoaded', function() {
    const cpfInputs = document.querySelectorAll('.cpf-input');
    cpfInputs.forEach(input => {
      input.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 11) value = value.substring(0, 11);
        e.target.value = formatarCPF(value);
      });
    });
  });

  // Inicialização do IndexedDB (CORRIGIDA - USANDO TEMPLATES SIMPLES)
  function plataforma_initDB() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('lg_crmDB', 9); // Versão existente
      
      request.onerror = (event) => {
        console.error('Erro ao abrir o banco de dados:', event.target.error);
        reject(event.target.error);
      };
      
      request.onsuccess = (event) => {
        plataforma.db = event.target.result;
        console.log('Banco de dados aberto com sucesso');
        
        // Carregar configurações de alertas
        plataforma_carregarConfigAlertas();
        
        resolve(plataforma.db);
      };
      
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        const oldVersion = event.oldVersion;
        
        // ObjectStores da Plataforma (templates simples sem sufixo _plataforma)
        // Usando apenas o nome base do sistema + "plataforma"
        const templates = [
          'clientesplataforma',
          'projetosplataforma',
          'etapasplataforma',
          'linksplataforma',
          'orientacoesplataforma',
          'prazosplataforma',
          'lembretesplataforma',
          'alertasplataforma',
          'configplataforma',
          'usuariosplataforma'
        ];
        
        templates.forEach(templateName => {
          if (!db.objectStoreNames.contains(templateName)) {
            const store = db.createObjectStore(templateName, { keyPath: 'id', autoIncrement: true });
            
            // Adicionar índices básicos baseados no tipo de template
            if (templateName === 'clientesplataforma') {
              store.createIndex('cpf', 'cpf', { unique: true });
              store.createIndex('status', 'status', { unique: false });
            }
            
            if (templateName === 'projetosplataforma') {
              store.createIndex('clienteId', 'clienteId', { unique: false });
              store.createIndex('status', 'status', { unique: false });
            }
            
            if (templateName === 'prazosplataforma') {
              store.createIndex('clienteId', 'clienteId', { unique: false });
              store.createIndex('data', 'data', { unique: false });
              store.createIndex('statusAlerta', 'statusAlerta', { unique: false });
            }
            
            if (templateName === 'configplataforma') {
              store.createIndex('chave', 'chave', { unique: true });
            }
          }
        });
        
        // Adicionar cliente demo padrão se não existir
        const transaction = event.target.transaction;
        const clientesStore = transaction.objectStore('clientesplataforma');
        const configStore = transaction.objectStore('configplataforma');
        
        const demoRequest = clientesStore.get(1);
        demoRequest.onsuccess = () => {
          if (!demoRequest.result) {
            clientesStore.add({
              id: 1,
              nome: 'Cliente Demonstração',
              email: 'demo@legacyplatform.com',
              cpf: '123.456.789-00',
              whatsapp: '5522999999999',
              status: 'ativo',
              dataCadastro: new Date().toISOString(),
              ultimoAcesso: null
            });
          }
        };
        
        // Adicionar configuração padrão
        const configRequest = configStore.get(1);
        configRequest.onsuccess = () => {
          if (!configRequest.result) {
            configStore.add({
              id: 1,
              chave: 'alertas_config',
              valor: JSON.stringify(plataforma.configAlertas)
            });
          }
        };
      };
    });
  }

  // Carregar configurações de alertas
  async function plataforma_carregarConfigAlertas() {
    try {
      const transaction = plataforma.db.transaction(['configplataforma'], 'readonly');
      const store = transaction.objectStore('configplataforma');
      const index = store.index('chave');
      const request = index.get('alertas_config');
      
      request.onsuccess = (event) => {
        const config = event.target.result;
        if (config && config.valor) {
          plataforma.configAlertas = JSON.parse(config.valor);
          
          // Atualizar inputs se estiverem na tela
          const diasInput = document.getElementById('plataforma_alerta_dias');
          const mensagemInput = document.getElementById('plataforma_alerta_mensagem');
          
          if (diasInput) diasInput.value = plataforma.configAlertas.diasAntecedencia;
          if (mensagemInput) mensagemInput.value = plataforma.configAlertas.mensagemPadrao;
        }
      };
    } catch (error) {
      console.error('Erro ao carregar configurações:', error);
    }
  }

  // Salvar configurações de alertas
  async function plataforma_admin_salvarConfigAlertas() {
    const dias = parseInt(document.getElementById('plataforma_alerta_dias').value);
    const mensagem = document.getElementById('plataforma_alerta_mensagem').value.trim();
    
    if (!mensagem || dias < 1) {
      alert('Por favor, preencha uma mensagem válida e dias positivos');
      return;
    }
    
    plataforma.configAlertas.diasAntecedencia = dias;
    plataforma.configAlertas.mensagemPadrao = mensagem;
    
    try {
      const transaction = plataforma.db.transaction(['configplataforma'], 'readwrite');
      const store = transaction.objectStore('configplataforma');
      const index = store.index('chave');
      const request = index.get('alertas_config');
      
      request.onsuccess = (event) => {
        const config = event.target.result;
        const configData = {
          chave: 'alertas_config',
          valor: JSON.stringify(plataforma.configAlertas)
        };
        
        if (config) {
          configData.id = config.id;
          store.put(configData);
        } else {
          store.add(configData);
        }
        
        alert('Configurações salvas com sucesso!');
        plataforma_admin_verificarVencimentos();
      };
    } catch (error) {
      console.error('Erro ao salvar configurações:', error);
      alert('Erro ao salvar configurações');
    }
  }

  // Login do cliente via CPF
  async function plataforma_login() {
    let cpf = document.getElementById('plataforma_input_cpf').value.trim();
    cpf = cpf.replace(/\D/g, ''); // Remover formatação
    
    if (!cpf || cpf.length !== 11) {
      alert('Por favor, digite um CPF válido (11 dígitos)');
      return;
    }
    
    try {
      const transaction = plataforma.db.transaction(['clientesplataforma'], 'readonly');
      const store = transaction.objectStore('clientesplataforma');
      const index = store.index('cpf');
      const request = index.get(cpf);
      
      request.onsuccess = async (event) => {
        const cliente = event.target.result;
        
        if (!cliente) {
          alert('CPF não encontrado. Entre em contato com o suporte.');
          return;
        }
        
        if (cliente.status !== 'ativo') {
          alert('Conta inativa. Entre em contato com o suporte.');
          return;
        }
        
        // CPF válido, fazer login
        plataforma.currentUser = cliente;
        plataforma.currentUser.ultimoAcesso = new Date().toISOString();
        
        // Atualizar último acesso
        const updateTransaction = plataforma.db.transaction(['clientesplataforma'], 'readwrite');
        const updateStore = updateTransaction.objectStore('clientesplataforma');
        updateStore.put(plataforma.currentUser);
        
        plataforma_showClientPortal();
      };
      
      request.onerror = () => {
        alert('Erro ao realizar login');
      };
    } catch (error) {
      console.error('Erro no login:', error);
      alert('Erro ao realizar login');
    }
  }

  // Logout
  function plataforma_logout() {
    plataforma.currentUser = null;
    plataforma.isAdmin = false;
    plataforma_showLoginModal();
  }

  // Mostrar portal do cliente
  function plataforma_showClientPortal() {
    document.getElementById('plataforma_overlay').style.display = 'block';
    document.getElementById('plataforma_client_portal').style.display = 'block';
    document.getElementById('plataforma_login_modal').style.display = 'none';
    
    plataforma_carregarDadosCliente();
  }

  // Carregar dados do cliente
  async function plataforma_carregarDadosCliente() {
    if (!plataforma.currentUser) return;
    
    // Atualizar nome do cliente
    document.getElementById('plataforma_client_name').innerHTML = 
      `<i class="fas fa-user-circle"></i> ${plataforma.currentUser.nome}`;
    
    // Atualizar último acesso
    const lastAccess = plataforma.currentUser.ultimoAcesso 
      ? new Date(plataforma.currentUser.ultimoAcesso).toLocaleString('pt-BR')
      : 'Primeiro acesso';
    document.getElementById('plataforma_last_access').textContent = lastAccess;
    
    // Mostrar CPF formatado
    if (plataforma.currentUser.cpf) {
      document.getElementById('plataforma_client_cpf').textContent = 
        formatarCPF(plataforma.currentUser.cpf);
    }
    
    // Carregar dados
    plataforma_carregarProjetoCliente();
    plataforma_carregarLinksCliente();
    plataforma_carregarOrientacoesCliente();
    plataforma_carregarPrazosCliente();
    plataforma_carregarLembretesCliente();
  }

  // Carregar projeto do cliente
  async function plataforma_carregarProjetoCliente() {
    if (!plataforma.currentUser) return;
    
    try {
      const transaction = plataforma.db.transaction(['projetosplataforma'], 'readonly');
      const store = transaction.objectStore('projetosplataforma');
      const index = store.index('clienteId');
      const request = index.getAll(plataforma.currentUser.id);
      
      request.onsuccess = (event) => {
        const projetos = event.target.result;
        
        if (projetos && projetos.length > 0) {
          const projeto = projetos[0];
          
          document.getElementById('plataforma_project_title').textContent = projeto.titulo;
          document.getElementById('plataforma_project_desc').textContent = projeto.descricao || 'Sem descrição';
          document.getElementById('plataforma_project_status').textContent = projeto.status;
          document.getElementById('plataforma_project_status').className = `plataforma_status ${projeto.status}`;
          
          const progresso = projeto.progresso || 0;
          document.getElementById('plataforma_progress_text').textContent = `${progresso}%`;
          document.getElementById('plataforma_progress_bar').style.width = `${progresso}%`;
          
          plataforma_carregarEtapasProjeto(projeto.id);
        } else {
          document.getElementById('plataforma_project_title').textContent = 'Nenhum projeto encontrado';
          document.getElementById('plataforma_project_desc').textContent = 'Entre em contato com o administrador';
          document.getElementById('plataforma_project_status').textContent = 'Não iniciado';
        }
      };
    } catch (error) {
      console.error('Erro ao carregar projeto:', error);
    }
  }

  // Carregar etapas do projeto
  async function plataforma_carregarEtapasProjeto(projetoId) {
    try {
      const transaction = plataforma.db.transaction(['etapasplataforma'], 'readonly');
      const store = transaction.objectStore('etapasplataforma');
      const index = store.index('projetoId');
      const request = index.getAll(projetoId);
      
      request.onsuccess = (event) => {
        const etapas = event.target.result;
        const timeline = document.getElementById('plataforma_timeline');
        timeline.innerHTML = '';
        
        if (etapas && etapas.length > 0) {
          etapas.sort((a, b) => new Date(a.data) - new Date(b.data)).forEach(etapa => {
            const item = document.createElement('div');
            item.className = 'plataforma_timeline_item';
            
            const date = new Date(etapa.data).toLocaleDateString('pt-BR');
            item.innerHTML = `
              <div class="plataforma_timeline_date">${date}</div>
              <div style="color: rgba(255, 255, 255, 0.9);">${etapa.titulo}</div>
              <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.9rem; margin-top: 5px;">${etapa.descricao || ''}</div>
            `;
            
            timeline.appendChild(item);
          });
        } else {
          timeline.innerHTML = `
            <div class="plataforma_timeline_item">
              <div class="plataforma_timeline_date">${new Date().toLocaleDateString('pt-BR')}</div>
              <div style="color: rgba(255, 255, 255, 0.9);">Projeto iniciado</div>
            </div>
          `;
        }
      };
    } catch (error) {
      console.error('Erro ao carregar etapas:', error);
    }
  }

  // Carregar links do cliente
  async function plataforma_carregarLinksCliente() {
    if (!plataforma.currentUser) return;
    
    try {
      const transaction = plataforma.db.transaction(['linksplataforma'], 'readonly');
      const store = transaction.objectStore('linksplataforma');
      const index = store.index('clienteId');
      const request = index.getAll(plataforma.currentUser.id);
      
      request.onsuccess = (event) => {
        const links = event.target.result;
        const linksList = document.getElementById('plataforma_links_list');
        linksList.innerHTML = '';
        
        if (links && links.length > 0) {
          links.forEach(link => {
            const li = document.createElement('li');
            li.innerHTML = `
              <a href="${link.url}" target="_blank" class="plataforma_link_item">
                <i class="fas fa-external-link-alt"></i>
                <span>${link.nome}</span>
              </a>
            `;
            linksList.appendChild(li);
          });
        } else {
          linksList.innerHTML = `
            <li>
              <div class="plataforma_link_item" style="opacity: 0.7;">
                <i class="fas fa-info-circle"></i>
                <span>Nenhum link disponível no momento</span>
              </div>
            </li>
          `;
        }
      };
    } catch (error) {
      console.error('Erro ao carregar links:', error);
    }
  }

  // Carregar orientações do cliente
  async function plataforma_carregarOrientacoesCliente() {
    if (!plataforma.currentUser) return;
    
    try {
      const transaction = plataforma.db.transaction(['orientacoesplataforma'], 'readonly');
      const store = transaction.objectStore('orientacoesplataforma');
      const index = store.index('clienteId');
      const request = index.getAll(plataforma.currentUser.id);
      
      request.onsuccess = (event) => {
        const orientacoes = event.target.result;
        const container = document.getElementById('plataforma_orientacoes');
        container.innerHTML = '';
        
        if (orientacoes && orientacoes.length > 0) {
          orientacoes.forEach(orientacao => {
            const alert = document.createElement('div');
            alert.className = 'plataforma_alert info';
            alert.innerHTML = `
              <i class="fas fa-info-circle"></i>
              <div>${orientacao.texto}</div>
            `;
            container.appendChild(alert);
          });
        } else {
          container.innerHTML = `
            <div class="plataforma_alert info">
              <i class="fas fa-info-circle"></i>
              <div>Nenhuma orientação disponível no momento.</div>
            </div>
          `;
        }
      };
    } catch (error) {
      console.error('Erro ao carregar orientações:', error);
    }
  }

  // Carregar prazos do cliente
  async function plataforma_carregarPrazosCliente() {
    if (!plataforma.currentUser) return;
    
    try {
      const transaction = plataforma.db.transaction(['prazosplataforma'], 'readonly');
      const store = transaction.objectStore('prazosplataforma');
      const index = store.index('clienteId');
      const request = index.getAll(plataforma.currentUser.id);
      
      request.onsuccess = (event) => {
        const prazos = event.target.result;
        const container = document.getElementById('plataforma_prazos');
        container.innerHTML = '';
        
        if (prazos && prazos.length > 0) {
          prazos.sort((a, b) => new Date(a.data) - new Date(b.data)).forEach(prazo => {
            const date = new Date(prazo.data).toLocaleDateString('pt-BR');
            const today = new Date();
            const prazoDate = new Date(prazo.data);
            const diffTime = prazoDate - today;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let statusClass = 'ok';
            let vencimentoClass = 'ok';
            if (diffDays < 0) {
              statusClass = 'danger';
              vencimentoClass = 'vencido';
            } else if (diffDays <= 3) {
              statusClass = 'warning';
              vencimentoClass = 'proximo';
            }
            
            const item = document.createElement('div');
            item.className = `vencimento-item ${vencimentoClass}`;
            item.innerHTML = `
              <div>
                <strong>${prazo.titulo}</strong><br>
                <small>Vencimento: ${date} (${diffDays >= 0 ? `${diffDays} dias restantes` : 'VENCIDO'})</small>
              </div>
              <span class="alerta-status ${prazo.statusAlerta || 'pendente'}">
                ${prazo.statusAlerta === 'enviado' ? '✔️ Enviado' : '⏳ Pendente'}
              </span>
            `;
            container.appendChild(item);
          });
        } else {
          container.innerHTML = `
            <div class="plataforma_alert info">
              <i class="fas fa-info-circle"></i>
              <div>Nenhum prazo definido no momento.</div>
            </div>
          `;
        }
      };
    } catch (error) {
      console.error('Erro ao carregar prazos:', error);
    }
  }

  // Carregar lembretes do cliente
  async function plataforma_carregarLembretesCliente() {
    if (!plataforma.currentUser) return;
    
    try {
      const transaction = plataforma.db.transaction(['lembretesplataforma'], 'readonly');
      const store = transaction.objectStore('lembretesplataforma');
      const index = store.index('clienteId');
      const request = index.getAll(plataforma.currentUser.id);
      
      request.onsuccess = (event) => {
        const lembretes = event.target.result;
        const container = document.getElementById('plataforma_lembretes');
        container.innerHTML = '';
        
        if (lembretes && lembretes.length > 0) {
          lembretes.forEach(lembrete => {
            const item = document.createElement('div');
            item.className = 'lembrete-item';
            item.innerHTML = `
              <i class="fas fa-sticky-note" style="color: var(--primary);"></i>
              <div style="flex: 1;">
                ${lembrete.texto}
                ${lembrete.data ? `<br><small style="color: rgba(255,255,255,0.5);">${new Date(lembrete.data).toLocaleDateString('pt-BR')}</small>` : ''}
              </div>
            `;
            container.appendChild(item);
          });
        } else {
          container.innerHTML = `
            <div class="plataforma_alert info">
              <i class="fas fa-info-circle"></i>
              <div>Nenhum lembrete disponível no momento.</div>
            </div>
          `;
        }
      };
    } catch (error) {
      console.error('Erro ao carregar lembretes:', error);
    }
  }

  // ==================== ÁREA ADMINISTRATIVA CORRIGIDA ====================
  document.getElementById('plataforma_admin_access').addEventListener('click', () => {
    document.getElementById('plataforma_admin_modal').style.display = 'flex';
  });

  function plataforma_admin_fecharModal() {
    document.getElementById('plataforma_admin_modal').style.display = 'none';
  }

  async function plataforma_admin_login() {
    const senha = document.getElementById('plataforma_admin_senha').value.trim();
    
    if (senha === plataforma.adminPassword) {
      plataforma.isAdmin = true;
      plataforma_admin_fecharModal();
      plataforma_showAdminPortal();
    } else {
      alert('Senha administrativa incorreta');
    }
  }

  function plataforma_showAdminPortal() {
    document.getElementById('plataforma_overlay').style.display = 'block';
    document.getElementById('plataforma_admin_portal').style.display = 'block';
    document.getElementById('plataforma_admin_modal').style.display = 'none';
    
    plataforma_admin_carregarDashboard();
    plataforma_admin_carregarClientesSelect();
    plataforma_admin_verificarVencimentos();
  }

  function plataforma_admin_logout() {
    plataforma.isAdmin = false;
    plataforma.currentUser = null;
    document.getElementById('plataforma_overlay').style.display = 'none';
    document.getElementById('plataforma_admin_portal').style.display = 'none';
  }

  function plataforma_admin_showSection(section) {
    document.getElementById('plataforma_admin_dashboard').style.display = 'none';
    document.getElementById('plataforma_admin_clientes').style.display = 'none';
    document.getElementById('plataforma_admin_notificacoes').style.display = 'none';
    
    if (section === 'clientes') {
      document.getElementById('plataforma_admin_clientes').style.display = 'block';
    } else if (section === 'notificacoes') {
      document.getElementById('plataforma_admin_notificacoes').style.display = 'block';
      plataforma_admin_carregarAlertas();
    } else {
      document.getElementById('plataforma_admin_dashboard').style.display = 'block';
    }
  }

  function plataforma_admin_showDashboard() {
    plataforma_admin_showSection('dashboard');
    plataforma_admin_carregarDashboard();
  }

  async function plataforma_admin_carregarDashboard() {
    try {
      // Contar clientes
      const clientesTransaction = plataforma.db.transaction(['clientesplataforma'], 'readonly');
      const clientesStore = clientesTransaction.objectStore('clientesplataforma');
      const clientesCount = await new Promise((resolve) => {
        const request = clientesStore.count();
        request.onsuccess = () => resolve(request.result);
      });
      
      document.getElementById('plataforma_admin_total_clientes').textContent = clientesCount;
      
      // Contar projetos
      const projetosTransaction = plataforma.db.transaction(['projetosplataforma'], 'readonly');
      const projetosStore = projetosTransaction.objectStore('projetosplataforma');
      const projetosCount = await new Promise((resolve) => {
        const request = projetosStore.count();
        request.onsuccess = () => resolve(request.result);
      });
      
      document.getElementById('plataforma_admin_total_projetos').textContent = projetosCount;
      
      // Contar alertas pendentes
      const alertasTransaction = plataforma.db.transaction(['prazosplataforma'], 'readonly');
      const alertasStore = alertasTransaction.objectStore('prazosplataforma');
      const alertasIndex = alertasStore.index('statusAlerta');
      const alertasCountRequest = alertasIndex.count('pendente');
      alertasCountRequest.onsuccess = () => {
        document.getElementById('plataforma_admin_total_alertas').textContent = alertasCountRequest.result;
      };
      
      // Contar vencimentos hoje
      const hoje = new Date().toISOString().split('T')[0];
      const vencimentosIndex = alertasStore.index('data');
      const vencimentosRequest = vencimentosIndex.getAll(hoje);
      vencimentosRequest.onsuccess = () => {
        document.getElementById('plataforma_admin_total_vencimentos').textContent = vencimentosRequest.result.length;
      };
      
      // Carregar lista de clientes
      plataforma_admin_carregarListaClientes();
      
      // Atualizar badge de notificações
      plataforma_admin_atualizarBadgeNotificacoes();
      
    } catch (error) {
      console.error('Erro ao carregar dashboard:', error);
    }
  }

  async function plataforma_admin_carregarListaClientes() {
    try {
      const transaction = plataforma.db.transaction(['clientesplataforma', 'projetosplataforma'], 'readonly');
      const clientesStore = transaction.objectStore('clientesplataforma');
      const projetosStore = transaction.objectStore('projetosplataforma');
      
      const clientesRequest = clientesStore.getAll();
      
      clientesRequest.onsuccess = async () => {
        const clientes = clientesRequest.result;
        const tbody = document.getElementById('plataforma_admin_clientes_list');
        tbody.innerHTML = '';
        
        for (const cliente of clientes) {
          const projetosIndex = projetosStore.index('clienteId');
          const projetoRequest = projetosIndex.get(cliente.id);
          
          projetoRequest.onsuccess = () => {
            const projeto = projetoRequest.result;
            const projetoNome = projeto ? projeto.titulo : 'Sem projeto';
            
            const statusBadge = cliente.status === 'ativo' 
              ? '<span class="plataforma_badge success">Ativo</span>'
              : cliente.status === 'inativo'
              ? '<span class="plataforma_badge danger">Inativo</span>'
              : '<span class="plataforma_badge warning">Pendente</span>';
            
            const row = document.createElement('tr');
            row.innerHTML = `
              <td><strong>${cliente.nome}</strong><br><small>${cliente.email}</small></td>
              <td>${cliente.cpf ? formatarCPF(cliente.cpf) : 'Não cadastrado'}</td>
              <td>${cliente.whatsapp || 'Não cadastrado'}</td>
              <td>${statusBadge}</td>
              <td>${projetoNome}</td>
              <td>
                <button class="alerta-whatsapp-btn" onclick="plataforma_admin_enviarAlertaCliente(${cliente.id})" title="Enviar alerta por WhatsApp">
                  <i class="fab fa-whatsapp"></i>
                </button>
              </td>
            `;
            
            tbody.appendChild(row);
          };
        }
        
        if (clientes.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="6" style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">
                <i class="fas fa-users-slash"></i> Nenhum cliente cadastrado
              </td>
            </tr>
          `;
        }
      };
    } catch (error) {
      console.error('Erro ao carregar lista de clientes:', error);
    }
  }

  async function plataforma_admin_carregarClientesSelect() {
    try {
      const transaction = plataforma.db.transaction(['clientesplataforma'], 'readonly');
      const store = transaction.objectStore('clientesplataforma');
      const request = store.getAll();
      
      request.onsuccess = () => {
        const clientes = request.result;
        const selects = [
          'plataforma_projeto_cliente',
          'plataforma_conteudo_cliente'
        ];
        
        selects.forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select) {
            select.innerHTML = '<option value="">Selecione um cliente</option>';
            clientes.forEach(cliente => {
              const option = document.createElement('option');
              option.value = cliente.id;
              option.textContent = `${cliente.nome} (${cliente.cpf ? formatarCPF(cliente.cpf) : 'Sem CPF'})`;
              select.appendChild(option.cloneNode(true));
            });
          }
        });
      };
    } catch (error) {
      console.error('Erro ao carregar clientes para select:', error);
    }
  }

  async function plataforma_admin_salvarCliente() {
    const nome = document.getElementById('plataforma_novo_nome').value.trim();
    const email = document.getElementById('plataforma_novo_email').value.trim();
    let cpf = document.getElementById('plataforma_novo_cpf').value.trim();
    const whatsapp = document.getElementById('plataforma_novo_whatsapp').value.trim();
    const status = document.getElementById('plataforma_novo_status').value;
    
    cpf = cpf.replace(/\D/g, '');
    
    if (!nome || !email || !cpf || cpf.length !== 11) {
      alert('Por favor, preencha todos os campos obrigatórios com CPF válido (11 dígitos)');
      return;
    }
    
    try {
      const transaction = plataforma.db.transaction(['clientesplataforma'], 'readwrite');
      const store = transaction.objectStore('clientesplataforma');
      
      const cliente = {
        nome,
        email,
        cpf,
        whatsapp,
        status,
        dataCadastro: new Date().toISOString(),
        ultimoAcesso: null
      };
      
      const request = store.add(cliente);
      
      request.onsuccess = () => {
        alert('Cliente cadastrado com sucesso! CPF será a senha de acesso.');
        document.getElementById('plataforma_novo_nome').value = '';
        document.getElementById('plataforma_novo_email').value = '';
        document.getElementById('plataforma_novo_cpf').value = '';
        document.getElementById('plataforma_novo_whatsapp').value = '';
        
        plataforma_admin_carregarClientesSelect();
        plataforma_admin_carregarListaClientes();
        plataforma_admin_carregarDashboard();
      };
      
      request.onerror = () => {
        alert('Erro ao cadastrar cliente. CPF pode já estar em uso.');
      };
    } catch (error) {
      console.error('Erro ao salvar cliente:', error);
      alert('Erro ao cadastrar cliente');
    }
  }

  async function plataforma_admin_carregarProjetoCliente() {
    const clienteId = parseInt(document.getElementById('plataforma_projeto_cliente').value);
    
    if (!clienteId) return;
    
    try {
      const transaction = plataforma.db.transaction(['projetosplataforma'], 'readonly');
      const store = transaction.objectStore('projetosplataforma');
      const index = store.index('clienteId');
      const request = index.get(clienteId);
      
      request.onsuccess = (event) => {
        const projeto = event.target.result;
        
        if (projeto) {
          document.getElementById('plataforma_projeto_titulo').value = projeto.titulo || '';
          document.getElementById('plataforma_projeto_desc').value = projeto.descricao || '';
          document.getElementById('plataforma_projeto_status').value = projeto.status || 'pendente';
          document.getElementById('plataforma_projeto_progresso').value = projeto.progresso || 0;
          document.getElementById('plataforma_projeto_progresso_text').textContent = `${projeto.progresso || 0}%`;
        } else {
          document.getElementById('plataforma_projeto_titulo').value = '';
          document.getElementById('plataforma_projeto_desc').value = '';
          document.getElementById('plataforma_projeto_status').value = 'pendente';
          document.getElementById('plataforma_projeto_progresso').value = 0;
          document.getElementById('plataforma_projeto_progresso_text').textContent = '0%';
        }
      };
    } catch (error) {
      console.error('Erro ao carregar projeto:', error);
    }
  }

  async function plataforma_admin_salvarProjeto() {
    const clienteId = parseInt(document.getElementById('plataforma_projeto_cliente').value);
    const titulo = document.getElementById('plataforma_projeto_titulo').value.trim();
    const descricao = document.getElementById('plataforma_projeto_desc').value.trim();
    const status = document.getElementById('plataforma_projeto_status').value;
    const progresso = parseInt(document.getElementById('plataforma_projeto_progresso').value);
    
    if (!clienteId || !titulo) {
      alert('Por favor, selecione um cliente e informe o título do projeto');
      return;
    }
    
    try {
      const transaction = plataforma.db.transaction(['projetosplataforma'], 'readwrite');
      const store = transaction.objectStore('projetosplataforma');
      const index = store.index('clienteId');
      const request = index.get(clienteId);
      
      request.onsuccess = (event) => {
        const projetoExistente = event.target.result;
        const projeto = {
          clienteId,
          titulo,
          descricao,
          status,
          progresso,
          dataAtualizacao: new Date().toISOString()
        };
        
        let saveRequest;
        
        if (projetoExistente) {
          projeto.id = projetoExistente.id;
          saveRequest = store.put(projeto);
        } else {
          projeto.dataCriacao = new Date().toISOString();
          saveRequest = store.add(projeto);
        }
        
        saveRequest.onsuccess = () => {
          alert('Projeto salvo com sucesso!');
          if (!projetoExistente || projetoExistente.status !== status) {
            plataforma_admin_adicionarEtapa(projeto.id || saveRequest.result, status);
          }
        };
        
        saveRequest.onerror = () => {
          alert('Erro ao salvar projeto');
        };
      };
    } catch (error) {
      console.error('Erro ao salvar projeto:', error);
      alert('Erro ao salvar projeto');
    }
  }

  async function plataforma_admin_adicionarEtapa(projetoId, status) {
    try {
      const transaction = plataforma.db.transaction(['etapasplataforma'], 'readwrite');
      const store = transaction.objectStore('etapasplataforma');
      
      const statusText = {
        'pendente': 'Projeto criado e aguardando início',
        'andamento': 'Projeto em andamento',
        'concluido': 'Projeto concluído com sucesso',
        'aguardando': 'Aguardando ação do cliente'
      };
      
      const etapa = {
        projetoId,
        titulo: `Status alterado para: ${status}`,
        descricao: statusText[status] || 'Status atualizado',
        data: new Date().toISOString()
      };
      
      store.add(etapa);
    } catch (error) {
      console.error('Erro ao adicionar etapa:', error);
    }
  }

  async function plataforma_admin_carregarConteudoCliente() {
    // Implementação básica
  }

  async function plataforma_admin_adicionarLink() {
    const clienteId = parseInt(document.getElementById('plataforma_conteudo_cliente').value);
    const nome = document.getElementById('plataforma_novo_link_nome').value.trim();
    const url = document.getElementById('plataforma_novo_link_url').value.trim();
    
    if (!clienteId || !nome || !url) {
      alert('Por favor, selecione um cliente e preencha nome e URL do link');
      return;
    }
    
    try {
      const transaction = plataforma.db.transaction(['linksplataforma'], 'readwrite');
      const store = transaction.objectStore('linksplataforma');
      
      const link = {
        clienteId,
        nome,
        url,
        dataCriacao: new Date().toISOString()
      };
      
      const request = store.add(link);
      
      request.onsuccess = () => {
        alert('Link adicionado com sucesso!');
        document.getElementById('plataforma_novo_link_nome').value = '';
        document.getElementById('plataforma_novo_link_url').value = '';
      };
    } catch (error) {
      console.error('Erro ao adicionar link:', error);
      alert('Erro ao adicionar link');
    }
  }

  async function plataforma_admin_adicionarOrientacao() {
    const clienteId = parseInt(document.getElementById('plataforma_conteudo_cliente').value);
    const texto = document.getElementById('plataforma_nova_orientacao').value.trim();
    
    if (!clienteId || !texto) {
      alert('Por favor, selecione um cliente e digite uma orientação');
      return;
    }
    
    try {
      const transaction = plataforma.db.transaction(['orientacoesplataforma'], 'readwrite');
      const store = transaction.objectStore('orientacoesplataforma');
      
      const orientacao = {
        clienteId,
        texto,
        dataCriacao: new Date().toISOString()
      };
      
      const request = store.add(orientacao);
      
      request.onsuccess = () => {
        alert('Orientação adicionada com sucesso!');
        document.getElementById('plataforma_nova_orientacao').value = '';
      };
    } catch (error) {
      console.error('Erro ao adicionar orientação:', error);
      alert('Erro ao adicionar orientação');
    }
  }

  async function plataforma_admin_adicionarPrazo() {
    const clienteId = parseInt(document.getElementById('plataforma_conteudo_cliente').value);
    const titulo = document.getElementById('plataforma_novo_prazo_titulo').value.trim();
    const data = document.getElementById('plataforma_novo_prazo_data').value;
    
    if (!clienteId || !titulo || !data) {
      alert('Por favor, selecione um cliente e preencha título e data');
      return;
    }
    
    try {
      const transaction = plataforma.db.transaction(['prazosplataforma'], 'readwrite');
      const store = transaction.objectStore('prazosplataforma');
      
      const prazo = {
        clienteId,
        titulo,
        data: new Date(data).toISOString(),
        statusAlerta: 'pendente',
        dataCriacao: new Date().toISOString()
      };
      
      const request = store.add(prazo);
      
      request.onsuccess = () => {
        alert('Prazo adicionado com sucesso! O sistema notificará automaticamente.');
        document.getElementById('plataforma_novo_prazo_titulo').value = '';
        document.getElementById('plataforma_novo_prazo_data').value = '';
        plataforma_admin_verificarVencimentos();
      };
    } catch (error) {
      console.error('Erro ao adicionar prazo:', error);
      alert('Erro ao adicionar prazo');
    }
  }

  async function plataforma_admin_adicionarLembrete() {
    const clienteId = parseInt(document.getElementById('plataforma_conteudo_cliente').value);
    const texto = document.getElementById('plataforma_novo_lembrete').value.trim();
    
    if (!clienteId || !texto) {
      alert('Por favor, selecione um cliente e digite um lembrete');
      return;
    }
    
    try {
      const transaction = plataforma.db.transaction(['lembretesplataforma'], 'readwrite');
      const store = transaction.objectStore('lembretesplataforma');
      
      const lembrete = {
        clienteId,
        texto,
        data: new Date().toISOString(),
        dataCriacao: new Date().toISOString()
      };
      
      const request = store.add(lembrete);
      
      request.onsuccess = () => {
        alert('Lembrete adicionado com sucesso!');
        document.getElementById('plataforma_novo_lembrete').value = '';
      };
    } catch (error) {
      console.error('Erro ao adicionar lembrete:', error);
      alert('Erro ao adicionar lembrete');
    }
  }

  // Verificar vencimentos e criar alertas
  async function plataforma_admin_verificarVencimentos() {
    try {
      const hoje = new Date();
      const diasAntecedencia = plataforma.configAlertas.diasAntecedencia;
      const dataLimite = new Date(hoje);
      dataLimite.setDate(dataLimite.getDate() + diasAntecedencia);
      
      const transaction = plataforma.db.transaction(['prazosplataforma', 'clientesplataforma', 'alertasplataforma'], 'readwrite');
      const prazosStore = transaction.objectStore('prazosplataforma');
      const clientesStore = transaction.objectStore('clientesplataforma');
      const alertasStore = transaction.objectStore('alertasplataforma');
      
      const prazosRequest = prazosStore.getAll();
      
      prazosRequest.onsuccess = async () => {
        const prazos = prazosRequest.result;
        let alertasCriados = 0;
        
        for (const prazo of prazos) {
          if (prazo.statusAlerta === 'enviado') continue;
          
          const dataPrazo = new Date(prazo.data);
          const diffDias = Math.ceil((dataPrazo - hoje) / (1000 * 60 * 60 * 24));
          
          // Criar alerta se estiver dentro do período
          if (diffDias <= diasAntecedencia && diffDias >= 0) {
            // Verificar se já existe alerta
            const alertasIndex = alertasStore.index('prazoId');
            const alertaExistente = await new Promise(resolve => {
              const request = alertasIndex.get(prazo.id);
              request.onsuccess = () => resolve(request.result);
              request.onerror = () => resolve(null);
            });
            
            if (!alertaExistente) {
              // Buscar dados do cliente
              const clienteRequest = clientesStore.get(prazo.clienteId);
              clienteRequest.onsuccess = () => {
                const cliente = clienteRequest.result;
                
                const alerta = {
                  prazoId: prazo.id,
                  clienteId: prazo.clienteId,
                  titulo: prazo.titulo,
                  dataPrazo: prazo.data,
                  clienteNome: cliente.nome,
                  clienteWhatsapp: cliente.whatsapp,
                  status: 'pendente',
                  dataCriacao: new Date().toISOString(),
                  tipo: diffDias === 0 ? 'hoje' : diffDias <= 3 ? 'proximo' : 'futuro'
                };
                
                alertasStore.add(alerta);
                alertasCriados++;
                
                // Atualizar status do prazo
                prazo.statusAlerta = 'pendente';
                prazosStore.put(prazo);
              };
            }
          }
        }
        
        if (alertasCriados > 0) {
          console.log(`${alertasCriados} novos alertas criados`);
          plataforma_admin_atualizarBadgeNotificacoes();
        }
      };
    } catch (error) {
      console.error('Erro ao verificar vencimentos:', error);
    }
  }

  // Carregar alertas pendentes
  async function plataforma_admin_carregarAlertas() {
    try {
      const transaction = plataforma.db.transaction(['alertasplataforma'], 'readonly');
      const store = transaction.objectStore('alertasplataforma');
      const index = store.index('status');
      const request = index.getAll('pendente');
      
      request.onsuccess = (event) => {
        const alertas = event.target.result;
        const container = document.getElementById('plataforma_admin_alertas_lista');
        container.innerHTML = '';
        
        if (alertas && alertas.length > 0) {
          alertas.forEach(alerta => {
            const item = document.createElement('div');
            item.className = 'notificacao-item';
            
            const dataPrazo = new Date(alerta.dataPrazo).toLocaleDateString('pt-BR');
            const hoje = new Date();
            const prazoDate = new Date(alerta.dataPrazo);
            const diffDias = Math.ceil((prazoDate - hoje) / (1000 * 60 * 60 * 24));
            
            let urgente = '';
            if (diffDias <= 0) {
              urgente = '<span style="color: #ef4444; font-weight: bold;"> (VENCIDO)</span>';
            } else if (diffDias <= 3) {
              urgente = '<span style="color: #f59e0b; font-weight: bold;"> (PRÓXIMO)</span>';
            }
            
            item.innerHTML = `
              <div class="info">
                <strong>${alerta.clienteNome}</strong><br>
                <small>Prazo: ${alerta.titulo} - Vence: ${dataPrazo} (${diffDias >= 0 ? `${diffDias} dias` : 'Vencido'})${urgente}</small><br>
                <small>WhatsApp: ${alerta.clienteWhatsapp || 'Não cadastrado'}</small>
              </div>
              <div class="acoes">
                <button class="alerta-whatsapp-btn" onclick="plataforma_admin_enviarAlerta(${alerta.id})">
                  <i class="fab fa-whatsapp"></i> Enviar
                </button>
                <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="plataforma_admin_marcarEnviado(${alerta.id})">
                  <i class="fas fa-check"></i> Marcado
                </button>
              </div>
            `;
            container.appendChild(item);
          });
        } else {
          container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">
              <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 15px;"></i><br>
              Nenhum alerta pendente no momento.
            </div>
          `;
        }
      };
    } catch (error) {
      console.error('Erro ao carregar alertas:', error);
    }
  }

  // Enviar alerta específico
  async function plataforma_admin_enviarAlerta(alertaId) {
    try {
      const transaction = plataforma.db.transaction(['alertasplataforma', 'prazosplataforma'], 'readwrite');
      const alertasStore = transaction.objectStore('alertasplataforma');
      const prazosStore = transaction.objectStore('prazosplataforma');
      
      const alertaRequest = alertasStore.get(alertaId);
      
      alertaRequest.onsuccess = (event) => {
        const alerta = event.target.result;
        if (!alerta) return;
        
        // Formatar mensagem
        let mensagem = plataforma.configAlertas.mensagemPadrao;
        mensagem = mensagem.replace(/{nome}/g, alerta.clienteNome);
        mensagem = mensagem.replace(/{titulo}/g, alerta.titulo);
        mensagem = mensagem.replace(/{data}/g, new Date(alerta.dataPrazo).toLocaleDateString('pt-BR'));
        mensagem = mensagem.replace(/{link_portal}/g, window.location.href.split('#')[0]);
        
        // Abrir WhatsApp
        if (alerta.clienteWhatsapp) {
          const telefone = alerta.clienteWhatsapp.replace(/\D/g, '');
          const mensagemCodificada = encodeURIComponent(mensagem);
          window.open(`https://wa.me/${telefone}?text=${mensagemCodificada}`, '_blank');
          
          // Marcar como enviado
          alerta.status = 'enviado';
          alerta.dataEnvio = new Date().toISOString();
          alertasStore.put(alerta);
          
          // Atualizar status do prazo
          const prazoRequest = prazosStore.get(alerta.prazoId);
          prazoRequest.onsuccess = () => {
            const prazo = prazoRequest.result;
            if (prazo) {
              prazo.statusAlerta = 'enviado';
              prazosStore.put(prazo);
            }
          };
          
          // Atualizar interface
          setTimeout(() => {
            plataforma_admin_carregarAlertas();
            plataforma_admin_atualizarBadgeNotificacoes();
            plataforma_admin_carregarDashboard();
          }, 500);
        } else {
          alert('Cliente não tem WhatsApp cadastrado');
        }
      };
    } catch (error) {
      console.error('Erro ao enviar alerta:', error);
      alert('Erro ao enviar alerta');
    }
  }

  // Enviar alerta para cliente específico
  async function plataforma_admin_enviarAlertaCliente(clienteId) {
    try {
      const transaction = plataforma.db.transaction(['clientesplataforma', 'prazosplataforma'], 'readonly');
      const clientesStore = transaction.objectStore('clientesplataforma');
      const prazosStore = transaction.objectStore('prazosplataforma');
      const prazosIndex = prazosStore.index('clienteId');
      
      const clienteRequest = clientesStore.get(clienteId);
      const prazosRequest = prazosIndex.getAll(clienteId);
      
      clienteRequest.onsuccess = () => {
        const cliente = clienteRequest.result;
        if (!cliente || !cliente.whatsapp) {
          alert('Cliente não encontrado ou sem WhatsApp cadastrado');
          return;
        }
        
        prazosRequest.onsuccess = () => {
          const prazos = prazosRequest.result;
          const prazosPendentes = prazos.filter(p => 
            p.statusAlerta !== 'enviado' && new Date(p.data) >= new Date()
          );
          
          if (prazosPendentes.length === 0) {
            alert('Cliente não tem prazos pendentes');
            return;
          }
          
          // Criar mensagem com todos os prazos
          let mensagem = `Olá ${cliente.nome}!\n\n`;
          mensagem += `Lembretes dos seus prazos:\n\n`;
          
          prazosPendentes.forEach((prazo, index) => {
            const data = new Date(prazo.data).toLocaleDateString('pt-BR');
            const diffDias = Math.ceil((new Date(prazo.data) - new Date()) / (1000 * 60 * 60 * 24));
            const status = diffDias <= 0 ? 'VENCIDO' : `${diffDias} dias restantes`;
            
            mensagem += `${index + 1}. ${prazo.titulo}\n`;
            mensagem += `   📅 Vencimento: ${data} (${status})\n\n`;
          });
          
          mensagem += `Acesse seu portal para mais detalhes: ${window.location.href.split('#')[0]}`;
          
          // Abrir WhatsApp
          const telefone = cliente.whatsapp.replace(/\D/g, '');
          const mensagemCodificada = encodeURIComponent(mensagem);
          window.open(`https://wa.me/${telefone}?text=${mensagemCodificada}`, '_blank');
        };
      };
    } catch (error) {
      console.error('Erro ao enviar alerta para cliente:', error);
      alert('Erro ao enviar alerta');
    }
  }

  // Marcar alerta como enviado
  async function plataforma_admin_marcarEnviado(alertaId) {
    try {
      const transaction = plataforma.db.transaction(['alertasplataforma', 'prazosplataforma'], 'readwrite');
      const alertasStore = transaction.objectStore('alertasplataforma');
      const prazosStore = transaction.objectStore('prazosplataforma');
      
      const alertaRequest = alertasStore.get(alertaId);
      
      alertaRequest.onsuccess = (event) => {
        const alerta = event.target.result;
        if (!alerta) return;
        
        alerta.status = 'enviado';
        alerta.dataEnvio = new Date().toISOString();
        alertasStore.put(alerta);
        
        // Atualizar status do prazo
        const prazoRequest = prazosStore.get(alerta.prazoId);
        prazoRequest.onsuccess = () => {
          const prazo = prazoRequest.result;
          if (prazo) {
            prazo.statusAlerta = 'enviado';
            prazosStore.put(prazo);
          }
        };
        
        // Atualizar interface
        setTimeout(() => {
          plataforma_admin_carregarAlertas();
          plataforma_admin_atualizarBadgeNotificacoes();
          plataforma_admin_carregarDashboard();
        }, 500);
      };
    } catch (error) {
      console.error('Erro ao marcar alerta como enviado:', error);
    }
  }

  // Atualizar badge de notificações
  async function plataforma_admin_atualizarBadgeNotificacoes() {
    try {
      const transaction = plataforma.db.transaction(['alertasplataforma'], 'readonly');
      const store = transaction.objectStore('alertasplataforma');
      const index = store.index('status');
      const request = index.count('pendente');
      
      request.onsuccess = () => {
        const count = request.result;
        const badge = document.getElementById('plataforma_notificacoes_count');
        const btn = document.getElementById('plataforma_notificacoes_btn');
        
        if (count > 0) {
          badge.textContent = count;
          badge.style.display = 'flex';
          btn.classList.add('pulse');
        } else {
          badge.style.display = 'none';
          btn.classList.remove('pulse');
        }
      };
    } catch (error) {
      console.error('Erro ao atualizar badge:', error);
    }
  }

  // Mostrar modal de login
  function plataforma_showLoginModal() {
    document.getElementById('plataforma_overlay').style.display = 'block';
    document.getElementById('plataforma_login_modal').style.display = 'block';
    document.getElementById('plataforma_client_portal').style.display = 'none';
    document.getElementById('plataforma_admin_portal').style.display = 'none';
    
    // Limpar campo CPF
    document.getElementById('plataforma_input_cpf').value = '';
  }

  // Fechar modal de login e voltar para a página principal
  function plataforma_fecharLoginModal() {
    document.getElementById('plataforma_overlay').style.display = 'none';
    document.getElementById('plataforma_login_modal').style.display = 'none';
    document.getElementById('plataforma_input_cpf').value = '';
  }

  // Inicialização
  window.addEventListener('DOMContentLoaded', async () => {
    try {
      await plataforma_initDB();
      
      // Configurar slider de progresso
      const progressSlider = document.getElementById('plataforma_projeto_progresso');
      if (progressSlider) {
        progressSlider.addEventListener('input', function() {
          document.getElementById('plataforma_projeto_progresso_text').textContent = `${this.value}%`;
        });
      }
      
      // Verificar vencimentos periodicamente (a cada 5 minutos)
      setInterval(() => {
        if (plataforma.isAdmin) {
          plataforma_admin_verificarVencimentos();
        }
      }, 5 * 60 * 1000);
      
    } catch (error) {
      console.error('Erro na inicialização:', error);
    }
  });

  // Event listener para o overlay
  document.getElementById('plataforma_overlay').addEventListener('click', function(e) {
    if (e.target === this && !plataforma.isAdmin && plataforma.currentUser) {
      plataforma_showClientPortal();
    }
  });
</script>

<!-- ========================================================================= -->
<!-- CÓDIGO SUPABASE & AUTENTICAÇÃO (AJUSTADO PARA TEMPLATES SIMPLES)          -->
<!-- ========================================================================= -->
<script>
  // CONFIGURAÇÃO SUPABASE & AUTENTICAÇÃO
  const SUPABASE_URL = 'https://rjyxkouegrropsarrhje.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqeXhrb3VlZ3Jyb3BzYXJyaGplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NjYxNjcsImV4cCI6MjA4NTE0MjE2N30.UjNPnVBVhQcUSirXeWZ3RmYmAhDMqqbbVUChG_Mv57U';

  // Inicializa Cliente (FORMA CORRETA v2)
  window.supabase = supabase.createClient(
    SUPABASE_URL,
    SUPABASE_KEY
  );

  const authManager = {
    // Verifica sessão atual ao carregar
    init: async () => {
      const { data: { session } } = await window.supabase.auth.getSession();
      authManager.updateUI(session);

      // Escuta mudanças de estado (Login/Logout)
      window.supabase.auth.onAuthStateChange((event, session) => {
        authManager.updateUI(session);
      });
    },

    // Atualiza a interface (Mostra/Esconde Login)
    updateUI: (session) => {
      const body = document.body;
      if (session) {
        body.classList.remove('not-authenticated');
        body.classList.add('authenticated');
        // Inicia o app original se ainda não iniciou
        if (typeof app !== 'undefined' && !app.initialized) {
          app.init(); 
          app.initialized = true;
        }
      } else {
        body.classList.remove('authenticated');
        body.classList.add('not-authenticated');
      }
    },

    // Realiza Login
    login: async () => {
      const email = document.getElementById('login-email').value;
      const password = document.getElementById('login-password').value;
      const errorMsg = document.getElementById('login-error-msg');
      const btn = document.getElementById('btn-do-login');

      if (!email || !password) {
        authManager.showError('Preencha email e senha.');
        return;
      }

      btn.innerText = 'Autenticando...';
      btn.disabled = true;
      errorMsg.style.display = 'none';

      const { data, error } = await window.supabase.auth.signInWithPassword({
        email: email,
        password: password
      });

      btn.innerText = 'Entrar no Sistema';
      btn.disabled = false;

      if (error) {
        authManager.showError('Erro: ' + error.message);
      } else {
        // Sucesso: O listener onAuthStateChange cuidará da UI
      }
    },

    // Logout
    logout: async () => {
      if(confirm("Deseja sair do sistema?")) {
        await window.supabase.auth.signOut();
        // O listener atualiza a UI automaticamente
      }
    },

    showError: (msg) => {
      const el = document.getElementById('login-error-msg');
      el.innerText = msg;
      el.style.display = 'block';
    }
  };

  // Inicia verificação de Auth imediatamente
  authManager.init();
</script>

<script>
  // SISTEMA DE LOGIN SUPABASE PARA ADMINISTRADOR (AJUSTADO)
  const supabase_admin = {
    // Configuração (usando as mesmas credenciais já existentes)
    supabaseUrl: 'https://rjyxkouegrropsarrhje.supabase.co',
    supabaseKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqeXhrb3VlZ3Jyb3BzYXJyaGplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NjYxNjcsImV4cCI6MjA4NTE0MjE2N30.UjNPnVBVhQcUSirXeWZ3RmYmAhDMqqbbVUChG_Mv57U',
    
    // Estado da sessão
    currentSession: null,
    isSupabaseAdmin: false,
    
    // Inicialização segura
    init: function() {
      console.log('Sistema Supabase Admin: Inicializando...');
      
      // Criar modal de login Supabase se não existir
      this.createLoginModal();
      
      // Substituir o botão de acesso administrativo existente
      this.replaceAdminAccessButton();
      
      // Verificar sessão existente
      this.checkExistingSession();
    },
    
    // Criar modal de login Supabase
    createLoginModal: function() {
      // Verificar se já existe modal com ID diferente
      if (document.getElementById('supabase_admin_login_modal')) return;
      
      const modalHTML = `
        <div id="supabase_admin_login_modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 6000; align-items: center; justify-content: center; backdrop-filter: blur(5px);">
          <div class="plataforma_modal_box plataforma_fade_in" style="max-width: 400px; width: 90%;">
            <div style="text-align: center; margin-bottom: 30px;">
              <div style="width: 80px; height: 80px; background: rgba(59, 130, 246, 0.2); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
                <i class="fas fa-user-shield" style="font-size: 2rem; color: var(--primary);"></i>
              </div>
              <h2 style="color: #fff; margin-bottom: 10px;">Admin Supabase</h2>
              <p style="color: rgba(255, 255, 255, 0.7);">Autenticação segura via Supabase</p>
            </div>
            
            <div class="plataforma_input_group">
              <label class="plataforma_label">Email Administrativo</label>
              <input type="email" class="plataforma_input" id="supabase_admin_email" placeholder="admin@legacy.com">
            </div>
            
            <div class="plataforma_input_group">
              <label class="plataforma_label">Senha</label>
              <input type="password" class="plataforma_input" id="supabase_admin_password" placeholder="••••••••">
            </div>
            
            <div id="supabase_admin_error" style="color: #ef4444; font-size: 0.9rem; margin: 10px 0; display: none;"></div>
            
            <button class="plataforma_btn plataforma_btn_primary" style="width: 100%; margin-bottom: 15px;" onclick="supabase_admin.login()" id="supabase_login_btn">
              <i class="fas fa-sign-in-alt"></i> Entrar com Supabase
            </button>
            
            <button class="plataforma_btn plataforma_btn_secondary" style="width: 100%;" onclick="supabase_admin.closeModal()">
              <i class="fas fa-times"></i> Cancelar
            </button>
            
            <div style="text-align: center; margin-top: 20px; color: rgba(255, 255, 255, 0.5); font-size: 0.85rem;">
              <i class="fas fa-info-circle"></i> Acesso administrativo seguro
            </div>
          </div>
        </div>
      `;
      
      // Adicionar modal ao body
      document.body.insertAdjacentHTML('beforeend', modalHTML);
    },
    
    // Substituir botão de acesso administrativo existente
    replaceAdminAccessButton: function() {
      const existingAdminBtn = document.getElementById('plataforma_admin_access');
      if (!existingAdminBtn) return;
      
      // Clonar funcionalidade do botão existente
      const originalClickHandler = existingAdminBtn.onclick;
      
      // Adicionar novo handler que mostra modal Supabase
      existingAdminBtn.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        // Primeiro tentar autenticação Supabase
        document.getElementById('supabase_admin_login_modal').style.display = 'flex';
        
        // Também manter funcionalidade original se existir
        if (originalClickHandler) {
          originalClickHandler.call(this, e);
        }
      });
      
      // Adicionar tooltip informativo
      existingAdminBtn.title = 'Acesso Administrativo (Supabase)';
      
      // Mudar ícone para indicar Supabase
      const icon = existingAdminBtn.querySelector('i');
      if (icon) {
        icon.className = 'fas fa-database';
      }
    },
    
    // Verificar sessão existente
    checkExistingSession: function() {
      // Tentar recuperar sessão do localStorage
      const savedSession = localStorage.getItem('supabase_admin_session');
      if (savedSession) {
        try {
          const session = JSON.parse(savedSession);
          if (session && session.access_token && this.isTokenValid(session.expires_at)) {
            this.currentSession = session;
            this.isSupabaseAdmin = true;
            this.updateUIAfterLogin();
            console.log('Sessão Supabase recuperada');
          } else {
            localStorage.removeItem('supabase_admin_session');
          }
        } catch (e) {
          console.error('Erro ao recuperar sessão:', e);
          localStorage.removeItem('supabase_admin_session');
        }
      }
    },
    
    // Validar token
    isTokenValid: function(expiresAt) {
      if (!expiresAt) return false;
      const now = Math.floor(Date.now() / 1000);
      return expiresAt > now;
    },
    
    // Login via Supabase
    login: function() {
      const email = document.getElementById('supabase_admin_email').value.trim();
      const password = document.getElementById('supabase_admin_password').value;
      const errorEl = document.getElementById('supabase_admin_error');
      const btn = document.getElementById('supabase_login_btn');
      
      // Validação básica
      if (!email || !password) {
        this.showError('Preencha email e senha');
        return;
      }
      
      // Mostrar carregamento
      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Autenticando...';
      btn.disabled = true;
      errorEl.style.display = 'none';
      
      // Usar cliente Supabase existente ou criar um novo isolado
      this.supabaseAuth(email, password)
        .then(session => {
          if (session) {
            this.onLoginSuccess(session);
          } else {
            this.showError('Credenciais inválidas');
          }
        })
        .catch(error => {
          this.showError('Erro na autenticação: ' + error.message);
        })
        .finally(() => {
          btn.innerHTML = originalText;
          btn.disabled = false;
        });
    },
    
    // Autenticação com Supabase (isolada)
    supabaseAuth: async function(email, password) {
      try {
        // Usar o cliente Supabase já configurado globalmente
        if (window.supabase && window.supabase.auth) {
          const { data, error } = await window.supabase.auth.signInWithPassword({
            email: email,
            password: password
          });
          
          if (error) throw error;
          return data.session;
        } else {
          // Fallback: autenticação simulada para desenvolvimento
          console.warn('Cliente Supabase não encontrado, usando autenticação simulada');
          return this.mockAuth(email, password);
        }
      } catch (error) {
        console.error('Erro Supabase:', error);
        throw error;
      }
    },
    
    // Autenticação simulada (apenas para desenvolvimento)
    mockAuth: function(email, password) {
      // APENAS PARA TESTES - remover em produção
      const testEmail = 'admin@legacy.com';
      const testPassword = 'admin123';
      
      if (email === testEmail && password === testPassword) {
        return {
          access_token: 'mock_token_' + Date.now(),
          refresh_token: 'mock_refresh_' + Date.now(),
          expires_at: Math.floor(Date.now() / 1000) + 3600, // 1 hora
          user: {
            id: 'mock_admin_id',
            email: email,
            role: 'admin'
          }
        };
      }
      return null;
    },
    
    // Sucesso no login
    onLoginSuccess: function(session) {
      this.currentSession = session;
      this.isSupabaseAdmin = true;
      
      // Salvar sessão no localStorage
      localStorage.setItem('supabase_admin_session', JSON.stringify({
        access_token: session.access_token,
        refresh_token: session.refresh_token,
        expires_at: session.expires_at,
        user: {
          id: session.user.id,
          email: session.user.email
        }
      }));
      
      // Fechar modal
      this.closeModal();
      
      // Atualizar UI
      this.updateUIAfterLogin();
      
      // Integrar com sistema existente de forma segura
      this.integrateWithExistingSystem();
    },
    
    // Atualizar UI após login
    updateUIAfterLogin: function() {
      const adminBtn = document.getElementById('plataforma_admin_access');
      if (adminBtn) {
        // Mudar aparência do botão
        adminBtn.style.background = 'rgba(34, 197, 94, 0.3)';
        adminBtn.style.borderColor = 'rgba(34, 197, 94, 0.8)';
        adminBtn.style.color = '#4ade80';
        adminBtn.title = 'Admin Supabase (Conectado)';
        
        // Adicionar badge de conectado
        let badge = adminBtn.querySelector('.supabase-connected-badge');
        if (!badge) {
          badge = document.createElement('div');
          badge.className = 'supabase-connected-badge';
          badge.innerHTML = '<i class="fas fa-check-circle"></i>';
          badge.style.position = 'absolute';
          badge.style.top = '-5px';
          badge.style.right = '-5px';
          badge.style.background = '#10b981';
          badge.style.color = 'white';
          badge.style.width = '20px';
          badge.style.height = '20px';
          badge.style.borderRadius = '50%';
          badge.style.display = 'flex';
          badge.style.alignItems = 'center';
          badge.style.justifyContent = 'center';
          badge.style.fontSize = '12px';
          adminBtn.style.position = 'relative';
          adminBtn.appendChild(badge);
        }
      }
    },
    
    // Integrar com sistema existente de forma segura
    integrateWithExistingSystem: function() {
      // Aguardar um momento para garantir que o sistema principal está carregado
      setTimeout(() => {
        // Verificar se o sistema administrativo principal está disponível
        if (typeof plataforma !== 'undefined' && plataforma.isAdmin === false) {
          console.log('Sistema Supabase Admin: Integrando com sistema principal...');
          
          // Abrir portal administrativo existente
          // Isso é feito de forma indireta, sem modificar variáveis existentes
          try {
            // Usar função existente para abrir admin portal
            if (typeof plataforma_showAdminPortal === 'function') {
              // Fechar qualquer modal de login existente primeiro
              const adminModal = document.getElementById('plataforma_admin_modal');
              if (adminModal) {
                adminModal.style.display = 'none';
              }
              
              // Abrir portal administrativo
              plataforma_showAdminPortal();
            }
          } catch (e) {
            console.warn('Não foi possível integrar automaticamente:', e);
            // Fallback: mostrar mensagem
            alert('Autenticação Supabase bem-sucedida! Clique novamente no botão de administração.');
          }
        }
      }, 500);
    },
    
    // Logout
    logout: function() {
      if (confirm('Deseja sair da conta Supabase Admin?')) {
        this.currentSession = null;
        this.isSupabaseAdmin = false;
        localStorage.removeItem('supabase_admin_session');
        
        // Restaurar aparência do botão
        const adminBtn = document.getElementById('plataforma_admin_access');
        if (adminBtn) {
          adminBtn.style.background = '';
          adminBtn.style.borderColor = '';
          adminBtn.style.color = '';
          adminBtn.title = 'Acesso Administrativo (Supabase)';
          
          const badge = adminBtn.querySelector('.supabase-connected-badge');
          if (badge) {
            badge.remove();
          }
        }
        
        // Fazer logout do Supabase se possível
        if (window.supabase && window.supabase.auth) {
          window.supabase.auth.signOut();
        }
        
        alert('Logout realizado com sucesso!');
      }
    },
    
    // Fechar modal
    closeModal: function() {
      document.getElementById('supabase_admin_login_modal').style.display = 'none';
      document.getElementById('supabase_admin_email').value = '';
      document.getElementById('supabase_admin_password').value = '';
      document.getElementById('supabase_admin_error').style.display = 'none';
    },
    
    // Mostrar erro
    showError: function(message) {
      const errorEl = document.getElementById('supabase_admin_error');
      errorEl.textContent = message;
      errorEl.style.display = 'block';
    },
    
    // Middleware de proteção para funções administrativas existentes
    protectAdminFunction: function(originalFunction) {
      return function(...args) {
        if (!supabase_admin.isSupabaseAdmin) {
          // Mostrar modal de login
          document.getElementById('supabase_admin_login_modal').style.display = 'flex';
          return false;
        }
        return originalFunction.apply(this, args);
      };
    }
  };

  // Inicializar quando o DOM estiver pronto
  document.addEventListener('DOMContentLoaded', function() {
    // Aguardar um pouco para não interferir com inicialização existente
    setTimeout(() => {
      supabase_admin.init();
    }, 1000);
    
    // Adicionar listener para logout via tecla ESC no modal
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        const modal = document.getElementById('supabase_admin_login_modal');
        if (modal && modal.style.display === 'flex') {
          supabase_admin.closeModal();
        }
      }
    });
  });

  // Adicionar estilo CSS para o novo sistema (isolado)
  const supabaseAdminStyles = `
    /* Estilos para sistema Supabase Admin - Isolados com prefixo */
    .supabase-admin-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(34, 197, 94, 0.9);
      color: white;
      padding: 12px 20px;
      border-radius: 10px;
      z-index: 10000;
      display: flex;
      align-items: center;
      gap: 10px;
      animation: supabaseFadeIn 0.3s ease;
    }
    
    @keyframes supabaseFadeIn {
      from { opacity: 0; transform: translateY(-20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .supabase-admin-hidden {
      display: none !important;
    }
  `;

  // Adicionar estilos ao documento
  const styleSheet = document.createElement("style");
  styleSheet.textContent = supabaseAdminStyles;
  document.head.appendChild(styleSheet);
</script>
<script>
/**
 * 🚀 UNIVERSAL IDB SYNC - CORRIGIDO PARA TEMPLATES SIMPLES
 * Ajustado para usar os novos templates: clientesplataforma, projetosplataforma, etc.
 */
(function () {
    // ==========================================================
    // 1. CONFIGURAÇÕES & CONSTANTES
    // ==========================================================
    const SYNC_TABLE = 'lg_crm_supadb';
    const CANONICAL_DB = 'lg_crmDB';
    
    // FIX 1: Mantém a identidade da aba mesmo após refresh (SessionStorage)
    let storedId = sessionStorage.getItem('sync_device_id');
    if (!storedId) {
        storedId = crypto.randomUUID();
        sessionStorage.setItem('sync_device_id', storedId);
    }
    const DEVICE_ID = storedId;
    
    let isReplicating = false; 
    let syncInterval = null;

    // 🧠 CACHE INTELIGENTE
    const syncCache = new Map();

    // ==========================================================
    // 2. UTILITÁRIOS
    // ==========================================================
    const getClient = () => window.supabaseClient || window.supabase;

    const waitForSupabase = () => new Promise(resolve => {
        const check = () => getClient() ? resolve(getClient()) : setTimeout(check, 100);
        check();
    });

    async function getUserId() {
        const client = await waitForSupabase();
        const { data } = await client.auth.getSession();
        return data?.session?.user?.id || null;
    }

    function generateSignature(value) {
        if (value === null || value === undefined) return 'null';
        return JSON.stringify(value);
    }

    // ==========================================================
    // 3. INTERCEPTAÇÃO REAL-TIME (IndexDB -> Supabase)
    // ==========================================================
    const original = {
        put: IDBObjectStore.prototype.put,
        add: IDBObjectStore.prototype.add,
        delete: IDBObjectStore.prototype.delete
    };

    async function scheduleRealtimeUpload(storeName, method, key, value) {
        if (isReplicating) return; 

        const client = getClient();
        const userId = await getUserId();
        if (!client || !userId) return;

        const cacheKey = `${storeName}-${key}`;
        
        // Atualiza cache local imediatamente
        if (method === 'delete') {
            syncCache.delete(cacheKey);
        } else {
            syncCache.set(cacheKey, generateSignature(value));
        }

        // Envia para Supabase
        // FIX: Tratamento de erro silencioso para evitar travar a UI
        client.from(SYNC_TABLE).upsert({
            user_id: userId,
            db_name: CANONICAL_DB,
            store_name: storeName,
            record_key: String(key),
            record_value: method === 'delete' ? null : value,
            is_deleted: method === 'delete',
            device_id: DEVICE_ID,
            updated_at: new Date().toISOString()
        }, { onConflict: 'user_id,db_name,store_name,record_key' })
        .then(({ error }) => {
            if (error) console.warn(`⚠️ Sync Upload Falhou:`, error.message);
        });
    }

    IDBObjectStore.prototype.put = function (v, k) {
        const req = original.put.apply(this, arguments);
        const storeName = this.name;
        req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'put', k || e.target.result, v);
        return req;
    };

    IDBObjectStore.prototype.add = function (v, k) {
        const req = original.add.apply(this, arguments);
        const storeName = this.name;
        req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'add', k || e.target.result, v);
        return req;
    };

    IDBObjectStore.prototype.delete = function (k) {
        const req = original.delete.apply(this, arguments);
        const storeName = this.name;
        req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'delete', k, null);
        return req;
    };

    console.log('🪤 Sistema de Sync Híbrido Ativado (v2 Anti-Zombie)');

    // ==========================================================
    // 4. SMART UPLOAD LOOP (PC -> CLOUD)
    // ==========================================================
    async function smartUploadLoop() {
        const userId = await getUserId();
        const client = getClient();
        if (!userId || !client) return;

        const req = indexedDB.open(CANONICAL_DB);
        
        req.onsuccess = (e) => {
            const db = e.target.result;
            
            // Filtrar apenas os stores da plataforma (terminando com "plataforma")
            const allStoreNames = Array.from(db.objectStoreNames);
            const platformStores = allStoreNames.filter(name => name.includes('plataforma'));
            
            platformStores.forEach(storeName => {
                const tx = db.transaction([storeName], 'readonly');
                const store = tx.objectStore(storeName);
                
                Promise.all([
                    new Promise(r => store.getAll().onsuccess = (ev) => r(ev.target.result)),
                    new Promise(r => store.getAllKeys().onsuccess = (ev) => r(ev.target.result))
                ]).then(async ([records, keys]) => {
                    if (!records.length) return;

                    const changedRecords = [];

                    records.forEach((item, index) => {
                        const key = String(keys[index]);
                        const cacheKey = `${storeName}-${key}`;
                        const currentSig = generateSignature(item);

                        // Só sobe se mudou em relação ao que sabemos
                        if (syncCache.get(cacheKey) !== currentSig) {
                            changedRecords.push({
                                user_id: userId,
                                db_name: CANONICAL_DB,
                                store_name: storeName,
                                record_key: key,
                                record_value: item,
                                is_deleted: false,
                                device_id: DEVICE_ID,
                                updated_at: new Date().toISOString()
                            });
                            syncCache.set(cacheKey, currentSig);
                        }
                    });

                    if (changedRecords.length > 0) {
                        console.log(`📤 Upload Batch (${storeName}): ${changedRecords.length} itens`);
                        await client.from(SYNC_TABLE).upsert(changedRecords, { 
                            onConflict: 'user_id,db_name,store_name,record_key' 
                        });
                    }
                });
            });
        };
    }

    // ==========================================================
    // 5. SMART DOWNLOAD LOOP (CLOUD -> PC)
    // ==========================================================
    async function smartDownloadLoop() {
        const userId = await getUserId();
        const client = getClient();
        if (!userId || !client) return;

        const { data, error } = await client
            .from(SYNC_TABLE)
            .select('*')
            .eq('user_id', userId)
            .eq('db_name', CANONICAL_DB);

        if (error || !data || !data.length) return;

        const req = indexedDB.open(CANONICAL_DB);
        req.onsuccess = (e) => {
            const db = e.target.result;
            const localStores = Array.from(db.objectStoreNames);
            
            // Filtrar apenas dados da plataforma
            const platformRecords = data.filter(r => 
                r.store_name.includes('plataforma') && localStores.includes(r.store_name)
            );
            
            if (!platformRecords.length) return;

            const tx = db.transaction([...new Set(platformRecords.map(r => r.store_name))], 'readwrite');
            isReplicating = true;

            let writes = 0;

            platformRecords.forEach(r => {
                // ANTI-ECHO: Se o dado veio deste mesmo DEVICE_ID, ignoramos.
                if (r.device_id === DEVICE_ID) return;

                const store = tx.objectStore(r.store_name);
                // Converte chave numérica se necessário
                const key = !isNaN(r.record_key) ? Number(r.record_key) : r.record_key;
                const cacheKey = `${r.store_name}-${r.record_key}`;
                
                // LÓGICA DE DELETE (CORRIGIDA)
                if (r.is_deleted) {
                    // FIX: Deleta incondicionalmente. Se não existir, não dá erro.
                    store.delete(key);
                    
                    if (syncCache.has(cacheKey)) {
                        syncCache.delete(cacheKey);
                        writes++;
                    }
                    return;
                }

                // LÓGICA DE UPDATE/INSERT
                const incomingSig = generateSignature(r.record_value);
                const localSig = syncCache.get(cacheKey);

                if (incomingSig === localSig) {
                    return; 
                }

                // Atualiza IDB
                const val = r.record_value;
                if (store.keyPath && val && typeof val === 'object') {
                    // Se a store usa keyPath inline, injetamos a chave se necessário
                    if (!val[store.keyPath]) val[store.keyPath] = key;
                    store.put(val);
                } else {
                    store.put(val, key);
                }
                
                syncCache.set(cacheKey, incomingSig);
                writes++;
            });

            tx.oncomplete = () => {
                isReplicating = false;
                if (writes > 0) console.log(`📥 Download Sync Plataforma: ${writes} alterações aplicadas.`);
            };
            
            tx.onerror = () => {
                isReplicating = false;
                console.error('Erro na transação de download');
            };
        };
    }

    // ==========================================================
    // 6. VERIFICAÇÃO DE INTEGRIDADE DOS TEMPLATES
    // ==========================================================
    async function verifyPlatformTemplates() {
        try {
            const req = indexedDB.open(CANONICAL_DB);
            
            req.onsuccess = (e) => {
                const db = e.target.result;
                const allStores = Array.from(db.objectStoreNames);
                
                // Lista de templates obrigatórios da plataforma
                const requiredTemplates = [
                    'clientesplataforma',
                    'projetosplataforma',
                    'etapasplataforma',
                    'linksplataforma',
                    'orientacoesplataforma',
                    'prazosplataforma',
                    'lembretesplataforma',
                    'alertasplataforma',
                    'configplataforma',
                    'usuariosplataforma'
                ];
                
                const missingTemplates = requiredTemplates.filter(t => !allStores.includes(t));
                
                if (missingTemplates.length > 0) {
                    console.warn('⚠️ Templates da plataforma ausentes:', missingTemplates);
                    
                    // Criar templates ausentes
                    const transaction = db.transaction(missingTemplates, 'readwrite');
                    
                    missingTemplates.forEach(templateName => {
                        if (!db.objectStoreNames.contains(templateName)) {
                            const store = transaction.db.createObjectStore(templateName, { keyPath: 'id', autoIncrement: true });
                            
                            // Adicionar índices básicos
                            if (templateName === 'clientesplataforma') {
                                store.createIndex('cpf', 'cpf', { unique: true });
                                store.createIndex('status', 'status', { unique: false });
                            }
                            
                            if (templateName === 'projetosplataforma') {
                                store.createIndex('clienteId', 'clienteId', { unique: false });
                                store.createIndex('status', 'status', { unique: false });
                            }
                            
                            console.log(`✅ Template criado: ${templateName}`);
                        }
                    });
                } else {
                    console.log('✅ Todos os templates da plataforma estão presentes');
                }
            };
        } catch (error) {
            console.error('Erro na verificação de templates:', error);
        }
    }

    // ==========================================================
    // 7. LIMPEZA DE DADOS ZUMBIS (ANTI-ZOMBIE)
    // ==========================================================
    async function cleanupZombieData() {
        try {
            const userId = await getUserId();
            const client = getClient();
            if (!userId || !client) return;

            // Buscar registros marcados como deletados no Supabase
            const { data, error } = await client
                .from(SYNC_TABLE)
                .select('*')
                .eq('user_id', userId)
                .eq('db_name', CANONICAL_DB)
                .eq('is_deleted', true);

            if (error || !data || !data.length) return;

            const req = indexedDB.open(CANONICAL_DB);
            req.onsuccess = (e) => {
                const db = e.target.result;
                const tx = db.transaction(
                    [...new Set(data.map(r => r.store_name))], 
                    'readwrite'
                );

                data.forEach(r => {
                    if (!r.store_name.includes('plataforma')) return;
                    
                    try {
                        const store = tx.objectStore(r.store_name);
                        const key = !isNaN(r.record_key) ? Number(r.record_key) : r.record_key;
                        
                        // Tentar deletar (pode não existir mais, e está tudo bem)
                        store.delete(key);
                        
                        const cacheKey = `${r.store_name}-${r.record_key}`;
                        syncCache.delete(cacheKey);
                    } catch (e) {
                        // Silenciar erro - o dado pode já ter sido removido
                    }
                });

                tx.oncomplete = () => {
                    console.log('🧟 Limpeza de dados zumbis concluída');
                };
            };
        } catch (error) {
            console.warn('Aviso na limpeza de dados zumbis:', error);
        }
    }

    // ==========================================================
    // 8. INICIALIZAÇÃO COMPLETA
    // ==========================================================
    async function startService() {
        const userId = await getUserId();
        if (!userId) {
            console.log('⏳ Aguardando autenticação para iniciar sync...');
            return;
        }

        console.log('✅ Serviço de Sync Iniciado para:', userId);
        const client = getClient();

        // 1. Verificar integridade dos templates
        await verifyPlatformTemplates();
        
        // 2. Limpar dados zumbis
        await cleanupZombieData();
        
        // 3. Configurar listener em tempo real
        client.channel('global-sync-live')
            .on('postgres_changes', { 
                event: '*', 
                schema: 'public', 
                table: SYNC_TABLE, 
                filter: `user_id=eq.${userId}` 
            }, payload => {
                // Só dispara download se o evento veio de OUTRO device
                if (payload.new && payload.new.device_id !== DEVICE_ID) {
                    smartDownloadLoop();
                }
            })
            .subscribe();

        // 4. Ordem estratégica: Carrega Cache Local -> Baixa Nuvem -> Inicia Loop
        await smartUploadLoop(); 
        setTimeout(smartDownloadLoop, 500);

        // 5. Iniciar loop contínuo
        if (syncInterval) clearInterval(syncInterval);
        syncInterval = setInterval(async () => {
            await smartUploadLoop();
            await smartDownloadLoop();
        }, 10000);
    }

    // ==========================================================
    // 9. INICIALIZADOR PRINCIPAL
    // ==========================================================
    waitForSupabase().then(client => {
        // Monitorar mudanças de autenticação
        client.auth.onAuthStateChange((event, session) => {
            console.log(`🔐 Auth State Change: ${event}`);
            if (event === 'SIGNED_IN' && session) {
                startService();
            } else if (event === 'SIGNED_OUT') {
                if (syncInterval) {
                    clearInterval(syncInterval);
                    syncInterval = null;
                }
                syncCache.clear();
                console.log('🔒 Sync pausado (usuário desconectado)');
            }
        });
        
        // Verificar se já está autenticado
        getUserId().then(id => { 
            if (id) {
                console.log('👤 Usuário já autenticado, iniciando sync...');
                startService();
            }
        });
    });

    // ==========================================================
    // 10. EXPORTAÇÃO PARA DEBUG (OPCIONAL)
    // ==========================================================
    window.plataformaSyncDebug = {
        getCacheSize: () => syncCache.size,
        getCacheKeys: () => Array.from(syncCache.keys()),
        clearCache: () => syncCache.clear(),
        getDeviceId: () => DEVICE_ID,
        forceUpload: () => smartUploadLoop(),
        forceDownload: () => smartDownloadLoop(),
        verifyTemplates: () => verifyPlatformTemplates()
    };

})();
</script>

<!-- ========================================================================= -->
<!-- SISTEMA DE MONITORAMENTO E DEBUG DA PLATAFORMA                           -->
<!-- ========================================================================= -->
<script>
(function() {
    // Sistema de monitoramento para garantir compatibilidade
    const platformMonitor = {
        init: function() {
            console.log('🔍 Monitor da Plataforma iniciado');
            this.checkExistingConflicts();
            this.setupCompatibilityLayer();
            this.startHealthCheck();
        },
        
        // Verificar conflitos com outros sistemas
        checkExistingConflicts: function() {
            try {
                const req = indexedDB.open('lg_crmDB');
                req.onsuccess = (e) => {
                    const db = e.target.result;
                    const allStores = Array.from(db.objectStoreNames);
                    
                    // Separar stores por sistema
                    const systemStores = {
                        crm: allStores.filter(s => s.includes('crm') && !s.includes('plataforma')),
                        forms: allStores.filter(s => s.includes('forms') && !s.includes('plataforma')),
                        contrato: allStores.filter(s => s.includes('contrato') && !s.includes('plataforma')),
                        plataforma: allStores.filter(s => s.includes('plataforma'))
                    };
                    
                    console.log('📊 Análise de stores por sistema:', systemStores);
                    
                    // Verificar se a plataforma está isolada
                    const platformOnly = systemStores.plataforma.every(store => 
                        !store.includes('crm') && !store.includes('forms') && !store.includes('contrato')
                    );
                    
                    if (!platformOnly) {
                        console.warn('⚠️ Possível conflito: Stores da plataforma podem estar interferindo com outros sistemas');
                    } else {
                        console.log('✅ Plataforma isolada corretamente');
                    }
                };
            } catch (error) {
                console.error('Erro na verificação de conflitos:', error);
            }
        },
        
        // Camada de compatibilidade
        setupCompatibilityLayer: function() {
            // Interceptar abertura do banco para garantir templates
            const originalOpen = indexedDB.open;
            
            indexedDB.open = function(name, version) {
                if (name === 'lg_crmDB') {
                    const request = originalOpen.call(this, name, version);
                    
                    request.onupgradeneeded = function(e) {
                        // Chamar o onupgradeneeded original se existir
                        if (typeof request._onupgradeneeded === 'function') {
                            request._onupgradeneeded.call(request, e);
                        }
                        
                        // Garantir templates da plataforma
                        const db = e.target.result;
                        const requiredTemplates = [
                            'clientesplataforma',
                            'projetosplataforma', 
                            'etapasplataforma',
                            'linksplataforma',
                            'orientacoesplataforma',
                            'prazosplataforma',
                            'lembretesplataforma',
                            'alertasplataforma',
                            'configplataforma',
                            'usuariosplataforma'
                        ];
                        
                        requiredTemplates.forEach(templateName => {
                            if (!db.objectStoreNames.contains(templateName)) {
                                const store = db.createObjectStore(templateName, { keyPath: 'id', autoIncrement: true });
                                console.log(`🛠️ Template garantido: ${templateName}`);
                            }
                        });
                    };
                    
                    // Preservar listeners originais
                    const originalOnUpgradeNeeded = request.onupgradeneeded;
                    Object.defineProperty(request, 'onupgradeneeded', {
                        get: function() { return originalOnUpgradeNeeded; },
                        set: function(fn) { 
                            request._onupgradeneeded = fn; 
                            if (typeof fn === 'function') {
                                originalOnUpgradeNeeded = fn;
                            }
                        }
                    });
                    
                    return request;
                }
                return originalOpen.call(this, name, version);
            };
        },
        
        // Health check periódico
        startHealthCheck: function() {
            setInterval(() => {
                this.performHealthCheck();
            }, 30000); // A cada 30 segundos
        },
        
        performHealthCheck: function() {
            try {
                const req = indexedDB.open('lg_crmDB');
                req.onsuccess = (e) => {
                    const db = e.target.result;
                    const storeNames = Array.from(db.objectStoreNames);
                    
                    // Verificar se todos os templates obrigatórios existem
                    const required = ['clientesplataforma', 'projetosplataforma', 'configplataforma'];
                    const missing = required.filter(name => !storeNames.includes(name));
                    
                    if (missing.length === 0) {
                        console.log('✅ Health Check: Plataforma OK');
                    } else {
                        console.warn(`⚠️ Health Check: Templates ausentes: ${missing.join(', ')}`);
                        this.repairMissingTemplates(missing);
                    }
                };
            } catch (error) {
                console.error('❌ Health Check falhou:', error);
            }
        },
        
        // Reparar templates ausentes
        repairMissingTemplates: function(missingTemplates) {
            try {
                const req = indexedDB.open('lg_crmDB');
                
                req.onsuccess = (e) => {
                    const db = e.target.result;
                    const version = db.version + 1;
                    db.close();
                    
                    // Reabrir com nova versão para criar templates
                    const upgradeReq = indexedDB.open('lg_crmDB', version);
                    
                    upgradeReq.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        
                        missingTemplates.forEach(templateName => {
                            if (!db.objectStoreNames.contains(templateName)) {
                                const store = db.createObjectStore(templateName, { keyPath: 'id', autoIncrement: true });
                                
                                // Adicionar índices apropriados
                                if (templateName === 'clientesplataforma') {
                                    store.createIndex('cpf', 'cpf', { unique: true });
                                    store.createIndex('status', 'status', { unique: false });
                                }
                                
                                if (templateName === 'projetosplataforma') {
                                    store.createIndex('clienteId', 'clienteId', { unique: false });
                                    store.createIndex('status', 'status', { unique: false });
                                }
                                
                                console.log(`🔧 Template reparado: ${templateName}`);
                            }
                        });
                    };
                };
            } catch (error) {
                console.error('Erro ao reparar templates:', error);
            }
        }
    };
    
    // Iniciar monitor quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(() => {
            platformMonitor.init();
        }, 2000);
    });
})();
</script>

<!-- ========================================================================= -->
<!-- CONFIGURAÇÃO DE BACKUP E RESTAURAÇÃO                                      -->
<!-- ========================================================================= -->
<script>
(function() {
    const platformBackup = {
        // Criar backup dos dados da plataforma
        createBackup: async function() {
            try {
                const backup = {
                    timestamp: new Date().toISOString(),
                    version: '1.0',
                    data: {}
                };
                
                const req = indexedDB.open('lg_crmDB');
                
                return new Promise((resolve, reject) => {
                    req.onsuccess = async (e) => {
                        const db = e.target.result;
                        const storeNames = Array.from(db.objectStoreNames)
                            .filter(name => name.includes('plataforma'));
                        
                        const transaction = db.transaction(storeNames, 'readonly');
                        
                        for (const storeName of storeNames) {
                            const store = transaction.objectStore(storeName);
                            const data = await new Promise(res => {
                                const request = store.getAll();
                                request.onsuccess = () => res(request.result);
                                request.onerror = () => res([]);
                            });
                            
                            backup.data[storeName] = data;
                        }
                        
                        transaction.oncomplete = () => {
                            const backupString = JSON.stringify(backup, null, 2);
                            this.downloadBackup(backupString);
                            resolve(backup);
                        };
                    };
                    
                    req.onerror = reject;
                });
            } catch (error) {
                console.error('Erro ao criar backup:', error);
                throw error;
            }
        },
        
        // Fazer download do backup
        downloadBackup: function(backupString) {
            const blob = new Blob([backupString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `plataforma_backup_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('Backup criado com sucesso!');
        },
        
        // Restaurar de backup
        restoreBackup: async function(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    try {
                        const backup = JSON.parse(e.target.result);
                        
                        if (!backup.data || !backup.timestamp) {
                            throw new Error('Formato de backup inválido');
                        }
                        
                        if (!confirm(`Restaurar backup de ${new Date(backup.timestamp).toLocaleString()}?`)) {
                            return;
                        }
                        
                        const req = indexedDB.open('lg_crmDB');
                        
                        req.onsuccess = (e) => {
                            const db = e.target.result;
                            const version = db.version + 1;
                            db.close();
                            
                            const upgradeReq = indexedDB.open('lg_crmDB', version);
                            
                            upgradeReq.onupgradeneeded = (e) => {
                                const db = e.target.result;
                                
                                // Limpar dados existentes da plataforma
                                Object.keys(backup.data).forEach(storeName => {
                                    if (db.objectStoreNames.contains(storeName)) {
                                        db.deleteObjectStore(storeName);
                                    }
                                    
                                    const store = db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                                    
                                    // Recriar índices
                                    if (storeName === 'clientesplataforma') {
                                        store.createIndex('cpf', 'cpf', { unique: true });
                                        store.createIndex('status', 'status', { unique: false });
                                    }
                                    
                                    if (storeName === 'projetosplataforma') {
                                        store.createIndex('clienteId', 'clienteId', { unique: false });
                                        store.createIndex('status', 'status', { unique: false });
                                    }
                                });
                            };
                            
                            upgradeReq.onsuccess = (e) => {
                                const db = e.target.result;
                                const storeNames = Object.keys(backup.data);
                                const transaction = db.transaction(storeNames, 'readwrite');
                                
                                let promises = [];
                                
                                storeNames.forEach(storeName => {
                                    const store = transaction.objectStore(storeName);
                                    const data = backup.data[storeName];
                                    
                                    data.forEach(item => {
                                        const promise = new Promise((res, rej) => {
                                            const request = store.add(item);
                                            request.onsuccess = () => res();
                                            request.onerror = rej;
                                        });
                                        promises.push(promise);
                                    });
                                });
                                
                                Promise.all(promises).then(() => {
                                    alert('Backup restaurado com sucesso! Recarregue a página.');
                                    resolve();
                                }).catch(reject);
                            };
                        };
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = reject;
                reader.readAsText(file);
            });
        }
    };
    
    // Adicionar funções de backup ao escopo global
    window.plataformaBackup = platformBackup;
})();
</script>

<!-- ========================================================================= -->
<!-- INTERFACE DE ADMINISTRAÇÃO AVANÇADA                                       -->
<!-- ========================================================================= -->
<div id="plataforma_advanced_admin" style="display: none; position: fixed; bottom: 80px; right: 20px; z-index: 1000;">
    <div style="background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; padding: 15px; width: 300px; backdrop-filter: blur(10px);">
        <h3 style="color: #fff; margin-bottom: 15px; font-size: 1rem;">
            <i class="fas fa-tools"></i> Admin Avançado
        </h3>
        
        <div style="display: flex; flex-direction: column; gap: 10px;">
            <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="window.plataformaBackup.createBackup()">
                <i class="fas fa-download"></i> Criar Backup
            </button>
            
            <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="document.getElementById('backupUpload').click()">
                <i class="fas fa-upload"></i> Restaurar Backup
            </button>
            
            <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="window.plataformaSyncDebug.verifyTemplates()">
                <i class="fas fa-check-circle"></i> Verificar Templates
            </button>
            
            <button class="plataforma_btn plataforma_btn_warning plataforma_btn_small" onclick="plataforma_clearAllData()">
                <i class="fas fa-trash"></i> Limpar Dados (Debug)
            </button>
        </div>
        
        <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
            <div style="color: rgba(255,255,255,0.7); font-size: 0.8rem; margin-bottom: 5px;">
                Status Sync: <span id="syncStatus">Verificando...</span>
            </div>
            <div style="color: rgba(255,255,255,0.7); font-size: 0.8rem;">
                Cache: <span id="cacheSize">0</span> itens
            </div>
        </div>
    </div>
</div>

<input type="file" id="backupUpload" accept=".json" style="display: none;" 
       onchange="window.plataformaBackup.restoreBackup(this.files[0])">

<script>
// Função para limpar dados (apenas para debug)
function plataforma_clearAllData() {
    if (!confirm('⚠️ ATENÇÃO: Isso apagará TODOS os dados da plataforma. Continuar?')) {
        return;
    }
    
    if (!confirm('CONFIRMAÇÃO FINAL: Tem certeza que deseja apagar todos os dados?')) {
        return;
    }
    
    try {
        const req = indexedDB.open('lg_crmDB');
        
        req.onsuccess = (e) => {
            const db = e.target.result;
            const version = db.version + 1;
            db.close();
            
            const upgradeReq = indexedDB.open('lg_crmDB', version);
            
            upgradeReq.onupgradeneeded = (e) => {
                const db = e.target.result;
                const storeNames = Array.from(db.objectStoreNames)
                    .filter(name => name.includes('plataforma'));
                
                storeNames.forEach(storeName => {
                    if (db.objectStoreNames.contains(storeName)) {
                        db.deleteObjectStore(storeName);
                    }
                    
                    // Recriar vazios
                    const store = db.createObjectStore(storeName, { keyPath: 'id', autoIncrement: true });
                    
                    if (storeName === 'clientesplataforma') {
                        store.createIndex('cpf', 'cpf', { unique: true });
                        store.createIndex('status', 'status', { unique: false });
                        
                        // Adicionar cliente demo
                        store.add({
                            nome: 'Cliente Demonstração',
                            email: 'demo@legacyplatform.com',
                            cpf: '123.456.789-00',
                            whatsapp: '5522999999999',
                            status: 'ativo',
                            dataCadastro: new Date().toISOString()
                        });
                    }
                    
                    if (storeName === 'configplataforma') {
                        store.add({
                            chave: 'alertas_config',
                            valor: JSON.stringify({
                                diasAntecedencia: 3,
                                mensagemPadrao: `Olá {nome}! Este é um lembrete sobre o prazo: {titulo}\nVencimento: {data}\nAcesse seu portal para mais detalhes: {link_portal}`
                            })
                        });
                    }
                });
                
                alert('Dados da plataforma resetados com sucesso! Recarregue a página.');
            };
        };
    } catch (error) {
        console.error('Erro ao limpar dados:', error);
        alert('Erro ao limpar dados: ' + error.message);
    }
}

// Atualizar status da interface
function updateAdvancedAdminUI() {
    if (window.plataformaSyncDebug) {
        document.getElementById('cacheSize').textContent = window.plataformaSyncDebug.getCacheSize();
        document.getElementById('syncStatus').textContent = 'Ativo';
        document.getElementById('syncStatus').style.color = '#10b981';
    }
}

// Mostrar/ocultar admin avançado
let advancedAdminVisible = false;
document.addEventListener('keydown', function(e) {
    // Ctrl+Alt+P para mostrar admin avançado
    if (e.ctrlKey && e.altKey && e.key === 'p') {
        advancedAdminVisible = !advancedAdminVisible;
        document.getElementById('plataforma_advanced_admin').style.display = 
            advancedAdminVisible ? 'block' : 'none';
        
        if (advancedAdminVisible) {
            updateAdvancedAdminUI();
            // Atualizar periodicamente
            setInterval(updateAdvancedAdminUI, 5000);
        }
    }
});

// Configurar upload de backup
document.getElementById('backupUpload').addEventListener('change', function(e) {
    if (this.files.length > 0) {
        this.value = ''; // Reset para permitir novo upload do mesmo arquivo
    }
});
</script>

<!-- ========================================================================= -->
<!-- RELATÓRIO DE COMPATIBILIDADE                                              -->
<!-- ========================================================================= -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        generateCompatibilityReport();
    }, 3000);
});

function generateCompatibilityReport() {
    try {
        const req = indexedDB.open('lg_crmDB');
        
        req.onsuccess = (e) => {
            const db = e.target.result;
            const allStores = Array.from(db.objectStoreNames);
            
            const report = {
                totalStores: allStores.length,
                platformStores: allStores.filter(s => s.includes('plataforma')).length,
                otherSystemStores: allStores.filter(s => !s.includes('plataforma')).length,
                storesBySystem: {
                    crm: allStores.filter(s => s.includes('crm') && !s.includes('plataforma')),
                    forms: allStores.filter(s => s.includes('forms') && !s.includes('plataforma')),
                    contrato: allStores.filter(s => s.includes('contrato') && !s.includes('plataforma')),
                    plataforma: allStores.filter(s => s.includes('plataforma'))
                },
                compatibilityStatus: '✅ OK'
            };
            
            // Verificar isolamento
            const platformStores = report.storesBySystem.plataforma;
            const hasConflict = platformStores.some(store => 
                store.includes('crm') || store.includes('forms') || store.includes('contrato')
            );
            
            if (hasConflict) {
                report.compatibilityStatus = '⚠️ CONFLITO DETECTADO';
            }
            
            console.group('📊 RELATÓRIO DE COMPATIBILIDADE - PLATAFORMA');
            console.log('Status:', report.compatibilityStatus);
            console.log('Total de Stores:', report.totalStores);
            console.log('Stores da Plataforma:', report.platformStores);
            console.log('Stores de Outros Sistemas:', report.otherSystemStores);
            console.log('Detalhes por sistema:', report.storesBySystem);
            console.groupEnd();
            
            // Se houver conflito, sugerir correção
            if (hasConflict) {
                console.warn('🚨 RECOMENDAÇÃO: Renomear stores da plataforma para usar sufixo "plataforma"');
                console.warn('Exemplo: "clientes" -> "clientesplataforma"');
            }
        };
    } catch (error) {
        console.error('Erro ao gerar relatório:', error);
    }
}
</script>

<!-- ========================================================================= -->
<!-- MIGRAÇÃO AUTOMÁTICA DE DADOS ANTIGOS                                     -->
<!-- ========================================================================= -->
<script>
(function() {
    // Migrar dados de stores antigos (_plataforma) para novos (plataforma)
    async function migrateOldData() {
        try {
            const req = indexedDB.open('lg_crmDB');
            
            req.onsuccess = (e) => {
                const db = e.target.result;
                const oldStores = Array.from(db.objectStoreNames)
                    .filter(name => name.includes('_plataforma'));
                
                if (oldStores.length === 0) {
                    console.log('✅ Nenhum dado antigo para migrar');
                    return;
                }
                
                console.log(`🔄 Migrando ${oldStores.length} stores antigos...`);
                
                const newStoreNames = oldStores.map(old => 
                    old.replace('_plataforma', 'plataforma')
                );
                
                const transaction = db.transaction([...oldStores, ...newStoreNames], 'readwrite');
                
                oldStores.forEach((oldStoreName, index) => {
                    const newStoreName = newStoreNames[index];
                    const oldStore = transaction.objectStore(oldStoreName);
                    const newStore = transaction.objectStore(newStoreName);
                    
                    const request = oldStore.getAll();
                    
                    request.onsuccess = async () => {
                        const data = request.result;
                        
                        for (const item of data) {
                            try {
                                await new Promise((resolve, reject) => {
                                    const addRequest = newStore.add(item);
                                    addRequest.onsuccess = resolve;
                                    addRequest.onerror = reject;
                                });
                            } catch (error) {
                                console.warn(`Não foi possível migrar item de ${oldStoreName}:`, error);
                            }
                        }
                        
                        console.log(`✅ Migrado: ${oldStoreName} -> ${newStoreName} (${data.length} itens)`);
                    };
                });
                
                transaction.oncomplete = () => {
                    console.log('✅ Migração concluída! Recomenda-se recarregar a página.');
                };
            };
        } catch (error) {
            console.error('Erro na migração:', error);
        }
    }
    
    // Executar migração automaticamente após carregamento
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(migrateOldData, 5000);
    });
})();
</script>

<!-- ========================================================================= -->
<!-- MENSAGEM DE STATUS DO SISTEMA                                             -->
<!-- ========================================================================= -->
<div id="system_status_message" style="display: none; position: fixed; bottom: 20px; left: 20px; background: rgba(15, 23, 42, 0.95); border-left: 4px solid var(--primary); padding: 12px 20px; border-radius: 8px; z-index: 9999; max-width: 400px; backdrop-filter: blur(10px);">
    <div style="display: flex; align-items: center; gap: 10px;">
        <i class="fas fa-info-circle" style="color: var(--primary);"></i>
        <div>
            <div style="font-weight: 600; color: #fff; margin-bottom: 5px;" id="status_title">Sistema Plataforma</div>
            <div style="color: rgba(255,255,255,0.7); font-size: 0.9rem;" id="status_message">Carregando...</div>
        </div>
    </div>
</div>

<script>
function showSystemStatus(title, message, type = 'info') {
    const statusEl = document.getElementById('system_status_message');
    const titleEl = document.getElementById('status_title');
    const messageEl = document.getElementById('status_message');
    const icon = statusEl.querySelector('i');
    
    // Configurar cores baseadas no tipo
    const colors = {
        info: 'var(--primary)',
        success: 'var(--success)',
        warning: 'var(--warning)',
        error: 'var(--danger)'
    };
    
    statusEl.style.borderLeftColor = colors[type] || colors.info;
    icon.style.color = colors[type] || colors.info;
    
    // Atualizar conteúdo
    titleEl.textContent = title;
    messageEl.textContent = message;
    
    // Mostrar
    statusEl.style.display = 'block';
    
    // Ocultar automaticamente após 5 segundos
    setTimeout(() => {
        statusEl.style.display = 'none';
    }, 5000);
}

</script>

</body>
</html>


