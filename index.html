<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Legacy Platform — Enterprise Edition</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&family=Inter:wght@300;400;500;600&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* Todos os estilos CSS originais permanecem aqui */
    :root {
      --bg-dark: #020617;
      --text-white: #ffffff;
      --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.15);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      --primary: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'Poppins', 'Inter', sans-serif;
      background: var(--bg-dark);
      color: var(--text-white);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* ================= HEADER ================= */
    header {
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 48px;
      background: rgba(2, 6, 23, 0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      transition: all 0.3s ease;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 18px;
      flex-shrink: 0;
    }

    .brand-text strong {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 22px;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .brand-text span {
      font-size: 11px;
      letter-spacing: 3px;
      color: var(--primary);
      display: block;
    }

    /* Navegação Topo */
    .header-nav {
      display: flex;
      gap: 30px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .header-nav::-webkit-scrollbar { display: none; }

    .nav-link {
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 5px;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
    }

    .nav-link:hover, .nav-link.active {
      color: #fff;
      border-bottom-color: var(--primary);
    }

    .header-spacer { width: 50px; }

    /* ================= MAIN STRUTUCTURE ================= */
    main {
      padding-top: 110px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      padding-bottom: 100px;
    }

    /* Blobs de Fundo */
    .background-blobs {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 0; pointer-events: none; overflow: hidden;
      position: fixed;
    }

    .blob {
      position: absolute; border-radius: 50%;
      filter: blur(80px); opacity: 0.6;
    }
    .blob-1 {
      width: 500px; height: 500px; background: #ff007a;
      top: 20%; left: 20%; animation: float 6s ease-in-out infinite;
    }
    .blob-2 {
      width: 400px; height: 400px; background: #3b82f6;
      bottom: 10%; right: 20%; animation: float 8s ease-in-out infinite reverse;
    }

    @keyframes float {
      0% { transform: translate(0, 0); }
      50% { transform: translate(30px, -30px); }
      100% { transform: translate(0, 0); }
    }

    /* ================= GLASS CARDS (DASHBOARD) ================= */
    .glass-slider-container {
      position: relative; z-index: 10;
      display: flex; gap: 30px; padding: 20px;
      width: 100%; max-width: 1200px;
      justify-content: center; 
      flex-wrap: wrap;
      margin-bottom: 80px;
    }

    .glass-card {
      width: 300px; height: 420px;
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 30px;
      display: flex; flex-direction: column;
      align-items: center; text-align: center;
      box-shadow: var(--glass-shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      color: #fff;
      flex-shrink: 0;
    }
    .glass-card:hover {
      transform: translateY(-10px);
      background: rgba(255, 255, 255, 0.12);
    }

    .card-img-wrapper {
      width: 100px; height: 100px;
      border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.3);
      margin-bottom: 20px;
      overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.2);
    }
    .card-img-wrapper i { font-size: 40px; color: #fff; }

    .card-title { font-size: 22px; font-weight: 600; margin-bottom: 5px; }
    .card-role { font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 30px; }

    .btn-glass {
      margin-top: auto;
      background: #ffffff; color: #020617;
      border: none; padding: 12px 30px;
      border-radius: 8px; font-weight: 600;
      cursor: pointer; transition: 0.3s;
      text-transform: uppercase; font-size: 13px; letter-spacing: 1px;
    }
    .btn-glass:hover {
      background: var(--primary); color: white;
      box-shadow: 0 0 15px var(--primary);
    }

    /* ================= PRICING SECTION ================= */
    #planos {
      width: 100%; text-align: center; padding: 40px 20px;
      z-index: 10; position: relative;
    }
    #planos h2 { font-size: 2.8rem; font-weight: 800; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); line-height: 1.2; }
    #planos p { max-width: 800px; margin: 0 auto 50px; color: rgba(255,255,255,0.8); font-size: 1.1rem; }

    .pricing-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
      gap: 20px;
      max-width: 1300px;
      margin: 0 auto;
      padding: 0 10px;
      align-items: stretch;
    }

    .price-card {
      position: relative;
      background: rgba(15, 23, 42, 0.6); 
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 30px 25px;
      backdrop-filter: blur(12px);
      transition: .3s;
      display: flex; flex-direction: column;
      text-align: left;
    }

    .price-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px -10px rgba(0,0,0,.6); }
    
    .price-card.featured {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.08);
      box-shadow: 0 0 30px rgba(59,130,246,.2);
      transform: scale(1.02);
      z-index: 11;
    }
    .price-card.featured:hover { transform: scale(1.02) translateY(-8px); }

    .badge-best {
      position: absolute; top: -14px; left: 50%; transform: translateX(-50%);
      background: var(--primary); color: #fff; padding: 6px 20px; border-radius: 20px;
      font-size: .75rem; font-weight: 700; text-transform: uppercase;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }

    .plan-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 5px; }
    .plan-desc { font-size: .85rem; color: rgba(255,255,255,.6); margin-bottom: 20px; min-height: 40px; }

    .price-box { margin-bottom: 5px; }
    .price-value { font-size: 2.2rem; font-weight: 800; color: #fff; }
    .price-suffix { font-size: 1rem; color: rgba(255,255,255,0.6); font-weight: 400; }
    
    .billing-note {
        font-size: 0.8rem;
        color: var(--success);
        font-weight: 500;
        margin-bottom: 25px;
        display: block;
        min-height: 20px;
    }

    .feature-list { list-style: none; padding: 0; margin-bottom: 30px; text-align: left; margin-top: auto; }
    .feature-list li { display: flex; gap: 10px; margin-bottom: 12px; font-size: .85rem; align-items: flex-start; line-height: 1.4; color: rgba(255,255,255,0.85); }
    .feature-list li i { color: var(--primary); margin-top: 3px; font-size: 0.9rem; flex-shrink: 0; }
    .feature-list li.disabled { color: rgba(255,255,255,0.4); }
    .feature-list li.disabled i { color: rgba(255,255,255,0.3); }

    .btn-select-plan {
      width: 100%;
      padding: 12px; border-radius: 10px;
      background: transparent; color: #fff;
      border: 1px solid rgba(255,255,255,.2); cursor: pointer;
      transition: 0.3s; font-weight: 600; font-size: 0.9rem;
    }
    .btn-select-plan:hover { background: rgba(255,255,255,0.1); border-color: #fff; }
    
    .price-card.featured .btn-select-plan { background: var(--primary); border-color: var(--primary); }
    .price-card.featured .btn-select-plan:hover { background: #2563eb; }

    /* ================= MODAL ================= */
    #paymentModal {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.9); z-index: 3000;
      align-items: center; justify-content: center;
      backdrop-filter: blur(5px);
    }
    #paymentModal .modal-box {
      background: #0f172a; padding: 30px; border-radius: 20px;
      max-width: 420px; width: 90%; text-align: center;
      border: 1px solid var(--glass-border);
      box-shadow: 0 0 50px rgba(59,130,246,0.3);
    }
    #paymentModal button {
      margin-top: 20px; padding: 12px 24px; border-radius: 10px;
      border: none; background: var(--primary); color: #fff; cursor: pointer;
      font-weight: bold; transition: 0.3s;
    }
    #paymentModal button:hover { transform: scale(1.05); }

    /* CUBE & ANIMATIONS */
    .cube-header-wrapper { width: 50px; height: 50px; perspective: 800px; }
    .cube-header { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; animation: rotateCube 12s linear infinite; }
    .cube-face { position: absolute; width: 50px; height: 50px; background: rgba(59,130,246,0.2); border: 1px solid rgba(147,197,253,0.8); display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .face-front { transform: rotateY(0deg) translateZ(25px); } .face-back { transform: rotateY(180deg) translateZ(25px); }
    .face-right { transform: rotateY(90deg) translateZ(25px); } .face-left { transform: rotateY(-90deg) translateZ(25px); }
    .face-top { transform: rotateX(90deg) translateZ(25px); } .face-bottom { transform: rotateX(-90deg) translateZ(25px); }
    @keyframes rotateCube { 0% { transform: rotateX(22deg) rotateY(0deg); } 100% { transform: rotateX(22deg) rotateY(360deg); } }
    
    .slider-arrow { color: rgba(255,255,255,0.5); font-size: 2rem; cursor: pointer; padding: 0 20px; transition: 0.3s; }
    .slider-arrow:hover { color: #fff; transform: scale(1.1); }

    /* ================= PORTAL DO CLIENTE (ATUALIZADO) ================= */
    #plataforma_overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 4000;
      backdrop-filter: blur(10px);
    }

    #plataforma_admin_modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 5000;
      align-items: center;
      justify-content: center;
    }

    .plataforma_container {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--bg-dark);
      z-index: 4001;
      overflow-y: auto;
    }

    .plataforma_modal_box {
      background: #0f172a;
      border-radius: 20px;
      border: 1px solid var(--glass-border);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      position: relative;
      max-width: 500px;
      width: 90%;
      margin: 50px auto;
      padding: 40px;
    }

    .plataforma_header {
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 30px;
      background: rgba(2, 6, 23, 0.95);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .plataforma_header_brand {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .plataforma_header_brand strong {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 18px;
      color: #fff;
    }

    .plataforma_header_brand span {
      font-size: 10px;
      color: var(--primary);
      display: block;
    }

    .plataforma_card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
    }

    .plataforma_card_title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .plataforma_status {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: auto;
    }

    .plataforma_status.pendente { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .plataforma_status.andamento { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
    .plataforma_status.concluido { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .plataforma_status.aguardando { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }

    .plataforma_timeline {
      position: relative;
      padding-left: 30px;
      margin: 20px 0;
    }

    .plataforma_timeline::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: rgba(59, 130, 246, 0.3);
    }

    .plataforma_timeline_item {
      position: relative;
      margin-bottom: 25px;
    }

    .plataforma_timeline_item::before {
      content: '';
      position: absolute;
      left: -20px;
      top: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
    }

    .plataforma_timeline_date {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 5px;
    }

    .plataforma_link_list {
      list-style: none;
      padding: 0;
    }

    .plataforma_link_item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      margin-bottom: 10px;
      transition: 0.3s;
      text-decoration: none;
      color: inherit;
    }

    .plataforma_link_item:hover {
      background: rgba(59, 130, 246, 0.1);
      transform: translateX(5px);
    }

    .plataforma_input_group {
      margin-bottom: 20px;
    }

    .plataforma_label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
    }

    .plataforma_input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: #fff;
      font-family: 'Poppins', sans-serif;
    }

    .plataforma_input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .plataforma_textarea {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: #fff;
      font-family: 'Poppins', sans-serif;
      min-height: 120px;
      resize: vertical;
    }

    .plataforma_btn {
      padding: 12px 24px;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
      font-family: 'Poppins', sans-serif;
    }

    .plataforma_btn_primary {
      background: var(--primary);
      color: white;
    }

    .plataforma_btn_primary:hover {
      background: #2563eb;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
    }

    .plataforma_btn_secondary {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .plataforma_btn_secondary:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .plataforma_btn_small {
      padding: 8px 16px;
      font-size: 0.85rem;
    }

    .plataforma_btn_danger {
      background: var(--danger);
      color: white;
    }

    .plataforma_btn_danger:hover {
      background: #dc2626;
    }

    .plataforma_btn_success {
      background: var(--success);
      color: white;
    }

    .plataforma_btn_success:hover {
      background: #059669;
    }

    .plataforma_btn_warning {
      background: var(--warning);
      color: white;
    }

    .plataforma_btn_warning:hover {
      background: #d97706;
    }

    .plataforma_admin_grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .plataforma_table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    .plataforma_table th,
    .plataforma_table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .plataforma_table th {
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      background: rgba(255, 255, 255, 0.03);
    }

    .plataforma_table tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .plataforma_badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .plataforma_badge.success { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .plataforma_badge.warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
    .plataforma_badge.danger { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .plataforma_badge.info { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }

    .plataforma_alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .plataforma_alert.info {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--primary);
    }

    .plataforma_alert.warning {
      background: rgba(245, 158, 11, 0.1);
      border-left: 4px solid #f59e0b;
    }

    .plataforma_alert.danger {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid #ef4444;
    }

    .plataforma_alert.success {
      background: rgba(34, 197, 94, 0.1);
      border-left: 4px solid #10b981;
    }

    #plataforma_admin_access {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.5);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      opacity: 0.3;
      transition: 0.3s;
    }

    #plataforma_admin_access:hover {
      opacity: 1;
      background: rgba(59, 130, 246, 0.3);
      transform: scale(1.1);
    }

    /* NOVOS ESTILOS PARA ALERTAS E NOTIFICAÇÕES */
    .alerta-whatsapp-btn {
      background: #25D366;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85rem;
      transition: 0.3s;
    }

    .alerta-whatsapp-btn:hover {
      background: #128C7E;
      transform: scale(1.05);
    }

    .alerta-config-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .alerta-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .alerta-status.pendente { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .alerta-status.enviado { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .alerta-status.agendado { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }

    .vencimento-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 4px solid transparent;
    }

    .vencimento-item.vencido {
      border-left-color: var(--danger);
      background: rgba(239, 68, 68, 0.05);
    }

    .vencimento-item.proximo {
      border-left-color: var(--warning);
      background: rgba(245, 158, 11, 0.05);
    }

    .vencimento-item.ok {
      border-left-color: var(--success);
    }

    .lembrete-item {
      background: rgba(59, 130, 246, 0.05);
      border-left: 4px solid var(--primary);
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    /* Área de Notificações Administrativas */
    .notificacoes-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--danger);
      color: white;
      font-size: 0.7rem;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .notificacao-item {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid var(--danger);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notificacao-item .info {
      flex: 1;
    }

    .notificacao-item .acoes {
      display: flex;
      gap: 10px;
    }

    /* CPF Input Styles */
    .cpf-input {
      font-family: monospace;
      letter-spacing: 1px;
    }

    /* MEDIA QUERIES */
    @media (max-width: 1000px) {
      header { padding: 15px 20px; height: auto; flex-direction: column; gap: 20px; }
      .header-nav { width: 100%; justify-content: center; padding-bottom: 5px; gap: 20px; }
      .header-spacer { display: none; }
      
      .glass-slider-container {
        flex-wrap: nowrap; justify-content: flex-start; overflow-x: auto;
        scroll-snap-type: x mandatory; padding: 20px 20px 60px 20px; width: 100%;
      }
      .glass-card { min-width: 85vw; margin-right: 15px; scroll-snap-align: center; }
      .slider-arrow { display: none; }
      main { padding-top: 160px; }
      
      .pricing-grid { grid-template-columns: 1fr; max-width: 400px; }

      .plataforma_modal_box {
        width: 95%;
        padding: 25px;
        margin: 20px auto;
      }

      .plataforma_header {
        padding: 0 20px;
        height: 70px;
      }

      .plataforma_admin_grid {
        grid-template-columns: 1fr;
      }

      .notificacao-item {
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }

      .notificacao-item .acoes {
        width: 100%;
        justify-content: flex-end;
      }
    }

    @keyframes plataforma_fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .plataforma_fade_in {
      animation: plataforma_fadeIn 0.5s ease-out;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .pulse {
      animation: pulse 2s infinite;
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="cube-header-wrapper">
      <div class="cube-header">
        <div class="cube-face face-front"><i class="fas fa-chart-line"></i></div>
        <div class="cube-face face-back"><i class="fas fa-users"></i></div>
        <div class="cube-face face-right"><i class="fas fa-project-diagram"></i></div>
        <div class="cube-face face-left"><i class="fas fa-wallet"></i></div>
        <div class="cube-face face-top"><i class="fas fa-cube"></i></div>
        <div class="cube-face face-bottom"><i class="fas fa-database"></i></div>
      </div>
    </div>
    <div class="brand-text">
      <strong>Legacy Platform</strong>
      <span>ENTERPRISE <i class="fas fa-cloud"></i> CLOUD</span>
    </div>
  </div>

  <nav class="header-nav">
    <a href="#" class="nav-link active"><i class="fas fa-chart-pie"></i> Dashboard</a>
    <a href="#planos" class="nav-link"><i class="fas fa-layer-group"></i> Planos</a>
    <a href="#" class="nav-link"><i class="fas fa-book"></i> Base/KB</a>
    <a href="https://wa.me/5522992497662" target="_blank" class="nav-link"><i class="fas fa-headset"></i> Suporte</a>
    <!-- NOVO BOTÃO: ACESSO DE CLIENTES -->
    <a href="#cliente" class="nav-link" onclick="plataforma_showLoginModal()">
      <i class="fas fa-user-tie"></i> Clientes
    </a>
  </nav>
  
  <div class="header-spacer"></div>
</header>
<main>
  <div class="background-blobs">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
  </div>
<div class="glass-slider-container">
    <div class="slider-arrow">
      <i class="fas fa-chevron-left"></i>
    </div>

    <div class="glass-card">
      <div class="card-img-wrapper">
        <i class="fas fa-users"></i>
      </div>
      <h3 class="card-title">Legacy Cloud CRM</h3>
      <p class="card-role">Enterprise Edition</p>
      <button class="btn-glass" onclick="abrirPopup('https://legacycrm.netlify.app/')">
        Acessar Sistema
      </button>
    </div>

    <div class="glass-card">
      <div class="card-img-wrapper">
        <i class="fas fa-file-signature"></i>
      </div>
      <h3 class="card-title">Legacy Contracts</h3>
      <p class="card-role">Gestão de Contratos</p>
      <button class="btn-glass" onclick="abrirPopup('https://legacycontratos.netlify.app')">
        Acessar Sistema
      </button>
    </div>

    <div class="glass-card">
      <div class="card-img-wrapper">
        <i class="fas fa-clipboard-check"></i>
      </div>
      <h3 class="card-title">Legacy Forms</h3>
      <p class="card-role">Gestão de Formulários</p>
      <button class="btn-glass" onclick="abrirPopup('https://legacyforms.netlify.app')">
        Acessar Sistema
      </button>
    </div>

    <div class="slider-arrow">
      <i class="fas fa-chevron-right"></i>
    </div>
  </div>

  <section id="planos">
    <h2>Seu negócio não pode viver preso no WhatsApp.<br>Nem desaparecer quando você troca de celular.</h2>
    <p>Com a Legacy você organiza clientes, conversas, financeiro, agenda e contratos em um sistema em nuvem seguro, para você nunca mais perder informações ou oportunidades.</p>
    
    <div class="pricing-grid">
      <div class="price-card">
        <h3 class="plan-title">SaaS Flex</h3>
        <p class="plan-desc">Para quem busca liberdade sem fidelidade longa.</p>
        <div class="price-box">
          <span class="price-value">R$ 60</span><span class="price-suffix">/mês</span>
        </div>
        <span class="billing-note">Cobrança recorrente mensal</span>
        <ul class="feature-list">
          <li><i class="fas fa-check-circle"></i> Acesso Multi-device Android e Pc</li>
          <li><i class="fas fa-rocket"></i> Implantação guiada</li>
          <li><i class="fas fa-clock"></i> 3 Tickets Suporte/mês</li>
          <li class="disabled"><i class="fas fa-ban"></i> Sem fidelidade</li>
        </ul>
        <button class="btn-select-plan" onclick="openPayment('SaaS Flex Mensal', 60)">Assinar Mensal</button>
      </div>

      <div class="price-card">
        <h3 class="plan-title">Starter</h3>
        <p class="plan-desc">O pacote inicial ideal para organizar a casa.</p>
        <div class="price-box">
          <span class="price-value">R$150</span><span class="price-suffix">Pgto único</span>
        </div>
        <span class="billing-note">Equivalente a R$50/mês</span>
        <ul class="feature-list">
          <li><i class="fas fa-check-circle"></i> Acesso Multi-device Android e Pc</li>
          <li><i class="fas fa-laptop-code"></i> Implantação Guiada</li>
          <li><i class="fas fa-ticket-alt"></i> 5 Tickets Suporte/mês</li>
        </ul>
        <button class="btn-select-plan" onclick="openPayment('Starter Trimestral', 150)">Assinar Trimestral</button>
      </div>

      <div class="price-card featured">
        <div class="badge-best">MAIS POPULAR</div>
        <h3 class="plan-title">Manager <i class="fas fa-crown" style="color: #facc15;"></i></h3>
        <p class="plan-desc">Gestão completa e suporte estendido.</p>
        <div class="price-box">
          <span class="price-value">R$600</span><span class="price-suffix">Pgto único</span>
        </div>
        <span class="billing-note">Equivalente a R$50/mês</span>
        <ul class="feature-list">
        <li><i class="fas fa-check-circle"></i> Acesso Multi-device Android e Pc</li>
          <li><i class="fas fa-laptop-code"></i> Implantação com o usuário</li>
          <li><i class="fas fa-ticket-alt"></i> 8 Tickets Suporte/mês</li>
        </ul>
        <button class="btn-select-plan" onclick="openPayment('Manager Anual', 600)">Assinar Anual</button>
      </div>

      <div class="price-card">
        <h3 class="plan-title">Controller</h3>
        <p class="plan-desc">Equilíbrio perfeito entre custo e prazo.</p>
        <div class="price-box">
          <span class="price-value">R$300</span><span class="price-suffix">Pgto único</span>
        </div>
        <span class="billing-note">Equivalente a R$50/mês</span>
        <ul class="feature-list">
          <li><i class="fas fa-check-circle"></i> Acesso Multi-device Android e Pc</li>
          <li><i class="fas fa-laptop-code"></i> Implantação Guiada</li>
          <li><i class="fas fa-ticket-alt"></i> 5 Tickets Suporte/mês</li>
        </ul>
        <button class="btn-select-plan" onclick="openPayment('Controller Semestral', 300)">Assinar Semestral</button>
      </div>
    </div>
  </section>
</main>

<!-- Botão de acesso administrativo (oculto) -->
<div id="plataforma_admin_access" title="Acesso Administrativo">
  <i class="fas fa-cogs"></i>
</div>

<!-- Overlay do Portal -->
<div id="plataforma_overlay"></div>

<!-- Portal do Cliente -->
<div id="plataforma_client_portal" class="plataforma_container">
  <div class="plataforma_header">
    <div class="plataforma_header_brand">
      <div style="width: 40px; height: 40px; background: rgba(59, 130, 246, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
        <i class="fas fa-user-tie" style="color: var(--primary);"></i>
      </div>
      <div>
        <strong>Portal do Cliente</strong>
        <span>LEGACY PLATFORM</span>
      </div>
    </div>
    <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="plataforma_logout()">
      <i class="fas fa-sign-out-alt"></i> Sair
    </button>
  </div>

  <div style="max-width: 1200px; margin: 0 auto; padding: 30px;">
    <!-- Informações do Cliente -->
    <div class="plataforma_card plataforma_fade_in">
      <h2 class="plataforma_card_title" id="plataforma_client_name">
        <i class="fas fa-user-circle"></i> Carregando...
      </h2>
      <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px;">
        <div>
          <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.6);">Status</div>
          <div class="plataforma_badge success" id="plataforma_client_status">Ativo</div>
        </div>
        <div>
          <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.6);">Último acesso</div>
          <div id="plataforma_last_access">-</div>
        </div>
        <div>
          <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.6);">CPF</div>
          <div id="plataforma_client_cpf">•••••••••••</div>
        </div>
      </div>
    </div>

    <!-- Projeto Atual -->
    <div class="plataforma_card plataforma_fade_in">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <h2 class="plataforma_card_title">
          <i class="fas fa-project-diagram"></i> Projeto Atual
        </h2>
        <span class="plataforma_status andamento" id="plataforma_project_status">Em andamento</span>
      </div>
      
      <h3 style="margin-bottom: 10px; color: #fff;" id="plataforma_project_title">Carregando projeto...</h3>
      <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 20px;" id="plataforma_project_desc"></p>
      
      <!-- Progresso -->
      <div style="margin-bottom: 25px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">Progresso</span>
          <span style="font-size: 0.9rem; font-weight: 600;" id="plataforma_progress_text">0%</span>
        </div>
        <div style="height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
          <div id="plataforma_progress_bar" style="height: 100%; background: linear-gradient(90deg, var(--primary), #60a5fa); width: 0%; transition: width 0.5s ease;"></div>
        </div>
      </div>

      <!-- Timeline -->
      <h3 style="margin: 25px 0 15px; color: #fff; font-size: 1.1rem;">
        <i class="fas fa-history"></i> Linha do Tempo
      </h3>
      <div class="plataforma_timeline" id="plataforma_timeline">
        <div class="plataforma_timeline_item">
          <div class="plataforma_timeline_date">Carregando...</div>
          <div style="color: rgba(255, 255, 255, 0.9);">Aguardando dados</div>
        </div>
      </div>
    </div>

    <!-- Links Importantes -->
    <div class="plataforma_card plataforma_fade_in">
      <h2 class="plataforma_card_title">
        <i class="fas fa-link"></i> Links Importantes
      </h2>
      <ul class="plataforma_link_list" id="plataforma_links_list">
        <li>
          <a href="#" class="plataforma_link_item">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Carregando links...</span>
          </a>
        </li>
      </ul>
    </div>

    <!-- Orientações -->
    <div class="plataforma_card plataforma_fade_in">
      <h2 class="plataforma_card_title">
        <i class="fas fa-graduation-cap"></i> Orientações
      </h2>
      <div id="plataforma_orientacoes">
        <div class="plataforma_alert info">
          <i class="fas fa-info-circle"></i>
          <div>Carregando orientações...</div>
        </div>
      </div>
    </div>

    <!-- Prazos e Datas -->
    <div class="plataforma_card plataforma_fade_in">
      <h2 class="plataforma_card_title">
        <i class="fas fa-calendar-alt"></i> Prazos e Datas
      </h2>
      <div id="plataforma_prazos">
        <div class="plataforma_alert warning">
          <i class="fas fa-clock"></i>
          <div>Carregando prazos...</div>
        </div>
      </div>
    </div>

    <!-- Lembretes -->
    <div class="plataforma_card plataforma_fade_in">
      <h2 class="plataforma_card_title">
        <i class="fas fa-bell"></i> Lembretes
      </h2>
      <div id="plataforma_lembretes">
        <div class="plataforma_alert info">
          <i class="fas fa-info-circle"></i>
          <div>Carregando lembretes...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Área Administrativa -->
<div id="plataforma_admin_portal" class="plataforma_container">
  <div class="plataforma_header">
    <div class="plataforma_header_brand">
      <div style="width: 40px; height: 40px; background: rgba(239, 68, 68, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
        <i class="fas fa-user-shield" style="color: #ef4444;"></i>
      </div>
      <div>
        <strong>Área Administrativa</strong>
        <span>PORTAL DO CLIENTE</span>
      </div>
    </div>
    <div style="display: flex; gap: 10px;">
      <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="plataforma_admin_showDashboard()">
        <i class="fas fa-tachometer-alt"></i> Dashboard
      </button>
      <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="plataforma_admin_showSection('notificacoes')" id="plataforma_notificacoes_btn">
        <i class="fas fa-bell"></i> Notificações
        <span class="notificacoes-badge" id="plataforma_notificacoes_count" style="display: none;">0</span>
      </button>
      <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="plataforma_admin_logout()">
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>
    </div>
  </div>

  <div style="max-width: 1400px; margin: 0 auto; padding: 30px;">
    <!-- Dashboard Admin -->
    <div id="plataforma_admin_dashboard">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="font-size: 1.8rem; color: #fff;">Dashboard Administrativo</h1>
        <button class="plataforma_btn plataforma_btn_primary" onclick="plataforma_admin_showSection('clientes')">
          <i class="fas fa-plus"></i> Novo Cliente
        </button>
      </div>

      <!-- Cards de Resumo -->
      <div class="plataforma_admin_grid">
        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-users"></i> Clientes
          </h3>
          <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary); margin: 10px 0;" id="plataforma_admin_total_clientes">0</div>
          <div style="color: rgba(255, 255, 255, 0.6);">Clientes cadastrados</div>
        </div>

        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-project-diagram"></i> Projetos
          </h3>
          <div style="font-size: 2.5rem; font-weight: 800; color: #10b981; margin: 10px 0;" id="plataforma_admin_total_projetos">0</div>
          <div style="color: rgba(255, 255, 255, 0.6);">Projetos ativos</div>
        </div>

        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-bell"></i> Alertas Pendentes
          </h3>
          <div style="font-size: 2.5rem; font-weight: 800; color: #f59e0b; margin: 10px 0;" id="plataforma_admin_total_alertas">0</div>
          <div style="color: rgba(255, 255, 255, 0.6);">Notificações a enviar</div>
        </div>

        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-clock"></i> Vencimentos Hoje
          </h3>
          <div style="font-size: 2.5rem; font-weight: 800; color: #ef4444; margin: 10px 0;" id="plataforma_admin_total_vencimentos">0</div>
          <div style="color: rgba(255, 255, 255, 0.6);">Prazos a vencer</div>
        </div>
      </div>

      <!-- Lista de Clientes -->
      <div class="plataforma_card" style="margin-top: 30px;">
        <h3 class="plataforma_card_title">
          <i class="fas fa-list"></i> Lista de Clientes
        </h3>
        <div style="overflow-x: auto;">
          <table class="plataforma_table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>CPF</th>
                <th>WhatsApp</th>
                <th>Status</th>
                <th>Projeto</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="plataforma_admin_clientes_list">
              <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">
                  <i class="fas fa-spinner fa-spin"></i> Carregando clientes...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Gestão de Clientes -->
    <div id="plataforma_admin_clientes" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="font-size: 1.8rem; color: #fff;">
          <i class="fas fa-user-plus"></i> Gestão de Clientes
        </h1>
        <button class="plataforma_btn plataforma_btn_secondary" onclick="plataforma_admin_showDashboard()">
          <i class="fas fa-arrow-left"></i> Voltar
        </button>
      </div>

      <div class="plataforma_admin_grid">
        <!-- Formulário de Cadastro -->
        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-plus-circle"></i> Novo Cliente
          </h3>
          <div class="plataforma_input_group">
            <label class="plataforma_label">Nome Completo *</label>
            <input type="text" class="plataforma_input" id="plataforma_novo_nome" placeholder="Nome do cliente">
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Email *</label>
            <input type="email" class="plataforma_input" id="plataforma_novo_email" placeholder="email@cliente.com">
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">CPF (Será a senha) *</label>
            <input type="text" class="plataforma_input cpf-input" id="plataforma_novo_cpf" placeholder="000.000.000-00" maxlength="14">
            <small style="color: rgba(255,255,255,0.5); font-size: 0.8rem; display: block; margin-top: 5px;">
              O CPF será usado como senha de acesso do cliente
            </small>
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Telefone WhatsApp *</label>
            <input type="text" class="plataforma_input" id="plataforma_novo_whatsapp" placeholder="(00) 00000-0000">
          </div>

          <div class="plataforma_input_group">
            <label class="plataforma_label">Status</label>
            <select class="plataforma_input" id="plataforma_novo_status">
              <option value="ativo">Ativo</option>
              <option value="inativo">Inativo</option>
              <option value="pendente">Pendente</option>
            </select>
          </div>

          <button class="plataforma_btn plataforma_btn_primary" style="width: 100%;" onclick="plataforma_admin_salvarCliente()">
            <i class="fas fa-save"></i> Salvar Cliente
          </button>
        </div>

        <!-- Formulário de Projeto -->
        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-project-diagram"></i> Projeto do Cliente
          </h3>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Cliente</label>
            <select class="plataforma_input" id="plataforma_projeto_cliente" onchange="plataforma_admin_carregarProjetoCliente()">
              <option value="">Selecione um cliente</option>
            </select>
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Título do Projeto *</label>
            <input type="text" class="plataforma_input" id="plataforma_projeto_titulo" placeholder="Nome do projeto">
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Descrição</label>
            <textarea class="plataforma_textarea" id="plataforma_projeto_desc" placeholder="Descreva o projeto..."></textarea>
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Status do Projeto</label>
            <select class="plataforma_input" id="plataforma_projeto_status">
              <option value="pendente">Pendente</option>
              <option value="andamento">Em andamento</option>
              <option value="concluido">Concluído</option>
              <option value="aguardando">Aguardando</option>
            </select>
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Progresso (%)</label>
            <input type="range" class="plataforma_input" id="plataforma_projeto_progresso" min="0" max="100" step="5" value="0">
            <div style="text-align: center; margin-top: 5px;">
              <span id="plataforma_projeto_progresso_text">0%</span>
            </div>
          </div>

          <button class="plataforma_btn plataforma_btn_primary" style="width: 100%;" onclick="plataforma_admin_salvarProjeto()">
            <i class="fas fa-save"></i> Salvar Projeto
          </button>
        </div>

        <!-- Gestão de Conteúdo -->
        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-cog"></i> Conteúdo do Portal
          </h3>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Cliente</label>
            <select class="plataforma_input" id="plataforma_conteudo_cliente" onchange="plataforma_admin_carregarConteudoCliente()">
              <option value="">Selecione um cliente</option>
            </select>
          </div>

          <div class="plataforma_input_group">
            <label class="plataforma_label">Adicionar Link</label>
            <input type="text" class="plataforma_input" id="plataforma_novo_link_nome" placeholder="Nome do link">
            <input type="text" class="plataforma_input" style="margin-top: 8px;" id="plataforma_novo_link_url" placeholder="https://exemplo.com">
            <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" style="width: 100%; margin-top: 10px;" onclick="plataforma_admin_adicionarLink()">
              <i class="fas fa-plus"></i> Adicionar Link
            </button>
          </div>

          <div class="plataforma_input_group">
            <label class="plataforma_label">Adicionar Orientação</label>
            <textarea class="plataforma_textarea" id="plataforma_nova_orientacao" placeholder="Digite uma orientação..."></textarea>
            <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" style="width: 100%; margin-top: 10px;" onclick="plataforma_admin_adicionarOrientacao()">
              <i class="fas fa-plus"></i> Adicionar
            </button>
          </div>

          <div class="plataforma_input_group">
            <label class="plataforma_label">Adicionar Prazo</label>
            <input type="text" class="plataforma_input" id="plataforma_novo_prazo_titulo" placeholder="Título do prazo">
            <input type="date" class="plataforma_input" style="margin-top: 8px;" id="plataforma_novo_prazo_data">
            <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" style="width: 100%; margin-top: 10px;" onclick="plataforma_admin_adicionarPrazo()">
              <i class="fas fa-plus"></i> Adicionar Prazo
            </button>
          </div>

          <div class="plataforma_input_group">
            <label class="plataforma_label">Adicionar Lembrete</label>
            <textarea class="plataforma_textarea" id="plataforma_novo_lembrete" placeholder="Digite um lembrete..."></textarea>
            <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" style="width: 100%; margin-top: 10px;" onclick="plataforma_admin_adicionarLembrete()">
              <i class="fas fa-plus"></i> Adicionar Lembrete
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Notificações de Vencimentos -->
    <div id="plataforma_admin_notificacoes" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="font-size: 1.8rem; color: #fff;">
          <i class="fas fa-bell"></i> Notificações de Vencimentos
        </h1>
        <button class="plataforma_btn plataforma_btn_secondary" onclick="plataforma_admin_showDashboard()">
          <i class="fas fa-arrow-left"></i> Voltar
        </button>
      </div>

      <div class="plataforma_card">
        <h3 class="plataforma_card_title">
          <i class="fas fa-exclamation-triangle"></i> Alertas Pendentes
        </h3>
        <div id="plataforma_admin_alertas_lista">
          <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">
            <i class="fas fa-spinner fa-spin"></i> Carregando alertas...
          </div>
        </div>
      </div>

      <div class="plataforma_card" style="margin-top: 30px;">
        <h3 class="plataforma_card_title">
          <i class="fas fa-sliders-h"></i> Configuração de Alertas
        </h3>
        
        <div class="alerta-config-container">
          <div class="plataforma_input_group">
            <label class="plataforma_label">Dias para alerta antecipado</label>
            <input type="number" class="plataforma_input" id="plataforma_alerta_dias" min="1" max="30" value="3">
            <small style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">
              Número de dias antes do vencimento para enviar alerta
            </small>
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Mensagem padrão de alerta</label>
            <textarea class="plataforma_textarea" id="plataforma_alerta_mensagem" placeholder="Digite a mensagem padrão para alertas..." rows="4">
Olá {nome}! Este é um lembrete sobre o prazo: {titulo}
Vencimento: {data}
Acesse seu portal para mais detalhes: {link_portal}
            </textarea>
            <small style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">
              Variáveis disponíveis: {nome}, {titulo}, {data}, {link_portal}
            </small>
          </div>
          
          <button class="plataforma_btn plataforma_btn_primary" onclick="plataforma_admin_salvarConfigAlertas()">
            <i class="fas fa-save"></i> Salvar Configurações
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Login do Cliente (ATUALIZADO PARA CPF) -->
<div id="plataforma_login_modal" class="plataforma_container">
  <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;">
    <div class="plataforma_modal_box plataforma_fade_in">
      <div style="text-align: center; margin-bottom: 30px;">
        <div style="width: 80px; height: 80px; background: rgba(59, 130, 246, 0.2); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
          <i class="fas fa-user-tie" style="font-size: 2rem; color: var(--primary);"></i>
        </div>
        <h2 style="color: #fff; margin-bottom: 10px;">Portal do Cliente</h2>
        <p style="color: rgba(255, 255, 255, 0.7);">Acesse com seu CPF cadastrado</p>
      </div>

      <div class="plataforma_input_group">
        <label class="plataforma_label">CPF (Somente números)</label>
        <input type="text" class="plataforma_input cpf-input" id="plataforma_input_cpf" placeholder="000.000.000-00" maxlength="14">
        <small style="color: rgba(255,255,255,0.5); font-size: 0.8rem; display: block; margin-top: 5px;">
          Digite seu CPF no formato: 000.000.000-00
        </small>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 25px;">
        <button class="plataforma_btn plataforma_btn_secondary" style="flex: 1;" onclick="plataforma_fecharLoginModal()">
          <i class="fas fa-arrow-left"></i> Voltar
        </button>
        <button class="plataforma_btn plataforma_btn_primary" style="flex: 2;" onclick="plataforma_login()">
          <i class="fas fa-sign-in-alt"></i> Entrar
        </button>
      </div>

      <div style="text-align: center; margin-top: 20px; color: rgba(255, 255, 255, 0.5); font-size: 0.85rem;">
        <i class="fas fa-info-circle"></i> Acesso exclusivo para clientes Legacy Platform
      </div>
    </div>
  </div>
</div>

<!-- Modal de Login Admin (ATUALIZADO COM SUPABASE) -->
<div id="plataforma_admin_modal">
  <div class="plataforma_modal_box plataforma_fade_in">
    <div style="text-align: center; margin-bottom: 30px;">
      <div style="width: 80px; height: 80px; background: rgba(239, 68, 68, 0.2); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
        <i class="fas fa-user-shield" style="font-size: 2rem; color: #ef4444;"></i>
      </div>
      <h2 style="color: #fff; margin-bottom: 10px;">Acesso Administrativo</h2>
      <p style="color: rgba(255, 255, 255, 0.7);">Área restrita para administradores</p>
    </div>

    <div class="plataforma_input_group">
      <label class="plataforma_label">Email</label>
      <input type="email" class="plataforma_input" id="plataforma_admin_email" placeholder="seu@email.com">
    </div>

    <div class="plataforma_input_group">
      <label class="plataforma_label">Senha</label>
      <input type="password" class="plataforma_input" id="plataforma_admin_senha" placeholder="Digite sua senha">
    </div>

    <button class="plataforma_btn plataforma_btn_primary" style="width: 100%; background: #ef4444; margin-top: 20px;" onclick="plataforma_admin_login()">
      <i class="fas fa-lock"></i> Entrar no Sistema
    </button>

    <div id="plataforma_admin_error" style="color: #f87171; text-align: center; margin-top: 15px; display: none;">
      <i class="fas fa-exclamation-circle"></i> <span id="plataforma_admin_error_msg"></span>
    </div>

    <div style="text-align: center; margin-top: 20px;">
      <button class="plataforma_btn plataforma_btn_secondary" onclick="plataforma_admin_fecharModal()">
        <i class="fas fa-times"></i> Cancelar
      </button>
    </div>
  </div>
</div>

<!-- Modal de Pagamento Original -->
<div id="paymentModal">
  <div class="modal-box">
    <div style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;">
      <i class="fas fa-shopping-cart"></i>
    </div>
    <h3>Confirmar Assinatura</h3>
    <p style="margin: 10px 0; color: rgba(255,255,255,0.7);">Você selecionou o plano:</p>
    <h2 id="modalPlanName" style="color: #fff; margin-bottom: 5px;"></h2>
    <strong id="modalPrice" style="font-size: 1.5rem; color: var(--success); display: block; margin-bottom: 20px;"></strong>
    <p style="font-size: 0.8rem; margin-bottom: 20px;">Você será redirecionado para finalizar a contratação via WhatsApp.</p>
    <div style="display: flex; gap: 10px; justify-content: center;">
      <button onclick="closePayment()" style="background: transparent; border: 1px solid rgba(255,255,255,0.3);">Cancelar</button>
      <button onclick="confirmarAssinatura()">Confirmar</button>
    </div>
  </div>
</div>

<script>
  // ==================== SISTEMA EXISTENTE (NÃO ALTERAR) ====================
  let planoSelecionado = "";
  let valorSelecionado = "";

  function abrirPopup(url) {
    const width = window.innerWidth * 0.9;
    const height = window.innerHeight * 0.9;
    const left = (window.innerWidth - width) / 2;
    const top = (window.innerHeight - height) / 2;
    const features = `width=${width},height=${height},top=${top},left=${left},resizable=yes,scrollbars=yes`;
    window.open(url, 'LegacySystemPopup', features);
  }

  const modal = document.getElementById('paymentModal');
  const modalName = document.getElementById('modalPlanName');
  const modalPrice = document.getElementById('modalPrice');

  function openPayment(name, price) {
    planoSelecionado = name;
    valorSelecionado = price;
    modalName.innerText = name;
    modalPrice.innerText = 'Total: R$ ' + price + ',00';
    modal.style.display = 'flex';
  }

  function closePayment() {
    modal.style.display = 'none';
  }

  function confirmarAssinatura() {
    const telefone = "5522992497662";
    const mensagem = encodeURIComponent(`Olá! Gostaria de assinar o plano ${planoSelecionado} no valor de R$ ${valorSelecionado},00.`);
    window.open(`https://wa.me/${telefone}?text=${mensagem}`, '_blank');
    closePayment();
  }

  window.onclick = function(event) {
    if (event.target == modal) closePayment();
  }

  // =========================================================================
  // INDEXEDDB - SISTEMA lg_crmDB PARA PLATAFORMA
  // =========================================================================
  const INDEXEDDB_NAME = 'lg_crmDB';
  const INDEXEDDB_VERSION = 9;
  
  // Estrutura das tabelas para a plataforma
  const TABLES_PLATAFORMA = {
    CLIENTES: 'clientesplataforma',
    PROJETOS: 'projetosplataforma',
    LINKS: 'linksplataforma',
    ORIENTACOES: 'orientacoesplataforma',
    PRAZOS: 'prazosplataforma',
    LEMBRETES: 'lembretesplataforma',
    ALERTAS: 'alertasplataforma',
    ETAPAS: 'etapasplataforma',
    CONFIG: 'configplataforma',
    ADMIN: 'adminplataforma' // Para login administrativo local
  };

  // Gerenciador do IndexedDB
  const dbManager = {
    db: null,
    
    // Inicializar o banco de dados
    init: function() {
      return new Promise((resolve, reject) => {
        if (this.db) {
          resolve(this.db);
          return;
        }
        
        const request = indexedDB.open(INDEXEDDB_NAME, INDEXEDDB_VERSION);
        
        request.onerror = (event) => {
          console.error('Erro ao abrir IndexedDB:', event.target.error);
          reject(event.target.error);
        };
        
        request.onsuccess = (event) => {
          this.db = event.target.result;
          console.log('IndexedDB conectado com sucesso');
          resolve(this.db);
        };
        
        request.onupgradeneeded = (event) => {
          const db = event.target.result;
          console.log('Criando/atualizando estrutura do IndexedDB para plataforma');
          
          // Tabela de Clientes
          if (!db.objectStoreNames.contains(TABLES_PLATAFORMA.CLIENTES)) {
            const clientesStore = db.createObjectStore(TABLES_PLATAFORMA.CLIENTES, { keyPath: 'id', autoIncrement: true });
            clientesStore.createIndex('cpf', 'cpf', { unique: true });
            clientesStore.createIndex('email', 'email', { unique: true });
            clientesStore.createIndex('status', 'status', { unique: false });
            console.log('Tabela clientesplataforma criada');
          }
          
          // Tabela de Projetos
          if (!db.objectStoreNames.contains(TABLES_PLATAFORMA.PROJETOS)) {
            const projetosStore = db.createObjectStore(TABLES_PLATAFORMA.PROJETOS, { keyPath: 'id', autoIncrement: true });
            projetosStore.createIndex('cliente_id', 'cliente_id', { unique: false });
            projetosStore.createIndex('status', 'status', { unique: false });
            console.log('Tabela projetosplataforma criada');
          }
          
          // Tabela de Links
          if (!db.objectStoreNames.contains(TABLES_PLATAFORMA.LINKS)) {
            const linksStore = db.createObjectStore(TABLES_PLATAFORMA.LINKS, { keyPath: 'id', autoIncrement: true });
            linksStore.createIndex('cliente_id', 'cliente_id', { unique: false });
            console.log('Tabela linksplataforma criada');
          }
          
          // Tabela de Orientações
          if (!db.objectStoreNames.contains(TABLES_PLATAFORMA.ORIENTACOES)) {
            const orientacoesStore = db.createObjectStore(TABLES_PLATAFORMA.ORIENTACOES, { keyPath: 'id', autoIncrement: true });
            orientacoesStore.createIndex('cliente_id', 'cliente_id', { unique: false });
            console.log('Tabela orientacoesplataforma criada');
          }
          
          // Tabela de Prazos
          if (!db.objectStoreNames.contains(TABLES_PLATAFORMA.PRAZOS)) {
            const prazosStore = db.createObjectStore(TABLES_PLATAFORMA.PRAZOS, { keyPath: 'id', autoIncrement: true });
            prazosStore.createIndex('cliente_id', 'cliente_id', { unique: false });
            prazosStore.createIndex('data', 'data', { unique: false });
            prazosStore.createIndex('status_alerta', 'status_alerta', { unique: false });
            console.log('Tabela prazosplataforma criada');
          }
          
          // Tabela de Lembretes
          if (!db.objectStoreNames.contains(TABLES_PLATAFORMA.LEMBRETES)) {
            const lembretesStore = db.createObjectStore(TABLES_PLATAFORMA.LEMBRETES, { keyPath: 'id', autoIncrement: true });
            lembretesStore.createIndex('cliente_id', 'cliente_id', { unique: false });
            console.log('Tabela lembretesplataforma criada');
          }
          
          // Tabela de Alertas
          if (!db.objectStoreNames.contains(TABLES_PLATAFORMA.ALERTAS)) {
            const alertasStore = db.createObjectStore(TABLES_PLATAFORMA.ALERTAS, { keyPath: 'id', autoIncrement: true });
            alertasStore.createIndex('cliente_id', 'cliente_id', { unique: false });
            alertasStore.createIndex('status', 'status', { unique: false });
            console.log('Tabela alertasplataforma criada');
          }
          
          // Tabela de Etapas
          if (!db.objectStoreNames.contains(TABLES_PLATAFORMA.ETAPAS)) {
            const etapasStore = db.createObjectStore(TABLES_PLATAFORMA.ETAPAS, { keyPath: 'id', autoIncrement: true });
            etapasStore.createIndex('projeto_id', 'projeto_id', { unique: false });
            console.log('Tabela etapasplataforma criada');
          }
          
          // Tabela de Configurações
          if (!db.objectStoreNames.contains(TABLES_PLATAFORMA.CONFIG)) {
            const configStore = db.createObjectStore(TABLES_PLATAFORMA.CONFIG, { keyPath: 'chave' });
            console.log('Tabela configplataforma criada');
            
            // Configurações padrão
            const defaultConfig = {
              chave: 'config_alertas',
              valor: {
                diasAntecedencia: 3,
                mensagemPadrao: `Olá {nome}! Este é um lembrete sobre o prazo: {titulo}\nVencimento: {data}\nAcesse seu portal para mais detalhes: {link_portal}`
              },
              data_criacao: new Date().toISOString(),
              data_atualizacao: new Date().toISOString()
            };
            
            const addRequest = configStore.add(defaultConfig);
            addRequest.onsuccess = () => console.log('Configuração padrão adicionada');
          }
          
          // Tabela de Administradores
          if (!db.objectStoreNames.contains(TABLES_PLATAFORMA.ADMIN)) {
            const adminStore = db.createObjectStore(TABLES_PLATAFORMA.ADMIN, { keyPath: 'id', autoIncrement: true });
            adminStore.createIndex('email', 'email', { unique: true });
            console.log('Tabela adminplataforma criada');
            
            // Administrador padrão (senha: admin123)
            const defaultAdmin = {
              email: 'admin@legacy.com',
              senha: 'admin123', // Em produção, usar hash
              nome: 'Administrador',
              nivel: 'super',
              data_criacao: new Date().toISOString(),
              ultimo_acesso: null
            };
            
            const addRequest = adminStore.add(defaultAdmin);
            addRequest.onsuccess = () => console.log('Administrador padrão adicionado');
          }
        };
      });
    },
    
    // Métodos genéricos para CRUD
    getAll: function(tableName) {
      return new Promise((resolve, reject) => {
        this.init().then(() => {
          const transaction = this.db.transaction([tableName], 'readonly');
          const store = transaction.objectStore(tableName);
          const request = store.getAll();
          
          request.onsuccess = () => resolve(request.result);
          request.onerror = (event) => reject(event.target.error);
        }).catch(reject);
      });
    },
    
    getById: function(tableName, id) {
      return new Promise((resolve, reject) => {
        this.init().then(() => {
          const transaction = this.db.transaction([tableName], 'readonly');
          const store = transaction.objectStore(tableName);
          const request = store.get(id);
          
          request.onsuccess = () => resolve(request.result);
          request.onerror = (event) => reject(event.target.error);
        }).catch(reject);
      });
    },
    
    getByIndex: function(tableName, indexName, value) {
      return new Promise((resolve, reject) => {
        this.init().then(() => {
          const transaction = this.db.transaction([tableName], 'readonly');
          const store = transaction.objectStore(tableName);
          const index = store.index(indexName);
          const request = index.get(value);
          
          request.onsuccess = () => resolve(request.result);
          request.onerror = (event) => reject(event.target.error);
        }).catch(reject);
      });
    },
    
    getAllByIndex: function(tableName, indexName, value) {
      return new Promise((resolve, reject) => {
        this.init().then(() => {
          const transaction = this.db.transaction([tableName], 'readonly');
          const store = transaction.objectStore(tableName);
          const index = store.index(indexName);
          const request = index.getAll(value);
          
          request.onsuccess = () => resolve(request.result);
          request.onerror = (event) => reject(event.target.error);
        }).catch(reject);
      });
    },
    
    add: function(tableName, data) {
      return new Promise((resolve, reject) => {
        this.init().then(() => {
          const transaction = this.db.transaction([tableName], 'readwrite');
          const store = transaction.objectStore(tableName);
          const request = store.add(data);
          
          request.onsuccess = () => resolve(request.result);
          request.onerror = (event) => reject(event.target.error);
        }).catch(reject);
      });
    },
    
    update: function(tableName, id, data) {
      return new Promise((resolve, reject) => {
        this.init().then(() => {
          const transaction = this.db.transaction([tableName], 'readwrite');
          const store = transaction.objectStore(tableName);
          const request = store.put({ ...data, id });
          
          request.onsuccess = () => resolve(request.result);
          request.onerror = (event) => reject(event.target.error);
        }).catch(reject);
      });
    },
    
    delete: function(tableName, id) {
      return new Promise((resolve, reject) => {
        this.init().then(() => {
          const transaction = this.db.transaction([tableName], 'readwrite');
          const store = transaction.objectStore(tableName);
          const request = store.delete(id);
          
          request.onsuccess = () => resolve(true);
          request.onerror = (event) => reject(event.target.error);
        }).catch(reject);
      });
    },
    
    count: function(tableName) {
      return new Promise((resolve, reject) => {
        this.init().then(() => {
          const transaction = this.db.transaction([tableName], 'readonly');
          const store = transaction.objectStore(tableName);
          const request = store.count();
          
          request.onsuccess = () => resolve(request.result);
          request.onerror = (event) => reject(event.target.error);
        }).catch(reject);
      });
    },
    
    countByIndex: function(tableName, indexName, value) {
      return new Promise((resolve, reject) => {
        this.init().then(() => {
          const transaction = this.db.transaction([tableName], 'readonly');
          const store = transaction.objectStore(tableName);
          const index = store.index(indexName);
          const request = index.count(value);
          
          request.onsuccess = () => resolve(request.result);
          request.onerror = (event) => reject(event.target.error);
        }).catch(reject);
      });
    }
  };

  // =========================================================================
  // CONFIGURAÇÃO SUPABASE & AUTENTICAÇÃO
  // =========================================================================
  const SUPABASE_URL = 'https://rjyxkouegrropsarrhje.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqeXhrb3VlZ3Jyb3BzYXJyaGplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NjYxNjcsImV4cCI6MjA4NTE0MjE2N30.UjNPnVBVhQcUSirXeWZ3RmYmAhDMqqbbVUChG_Mv57U';

  // Inicializa Cliente Supabase
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const authManager = {
    // Verifica sessão atual ao carregar
    init: async () => {
      try {
        const { data: { session }, error } = await supabaseClient.auth.getSession();
        if (error) {
          console.error('Erro ao verificar sessão:', error);
          return;
        }
        
        if (session) {
          console.log('Usuário já autenticado:', session.user.email);
          authManager.handleAdminLoginSuccess(session);
        } else {
          console.log('Nenhuma sessão ativa encontrada');
        }
      } catch (error) {
        console.error('Erro na inicialização do auth:', error);
      }
    },

    // Login do administrador
    login: async () => {
      const email = document.getElementById('plataforma_admin_email').value.trim();
      const password = document.getElementById('plataforma_admin_senha').value.trim();
      const errorMsg = document.getElementById('plataforma_admin_error');
      const errorText = document.getElementById('plataforma_admin_error_msg');
      const btn = document.querySelector('#plataforma_admin_modal .plataforma_btn_primary');

      if (!email || !password) {
        errorText.textContent = 'Preencha email e senha.';
        errorMsg.style.display = 'block';
        return;
      }

      const originalText = btn.innerHTML;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Autenticando...';
      btn.disabled = true;
      errorMsg.style.display = 'none';

      try {
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email: email,
          password: password
        });

        if (error) {
          throw error;
        }

        authManager.handleAdminLoginSuccess(data.session);
        
      } catch (error) {
        console.error('Erro no login:', error);
        errorText.textContent = 'Erro: ' + error.message;
        errorMsg.style.display = 'block';
        btn.innerHTML = originalText;
        btn.disabled = false;
      }
    },

    handleAdminLoginSuccess: (session) => {
      console.log('Login admin bem sucedido:', session.user.email);
      plataforma.isAdmin = true;
      plataforma.currentUser = {
        id: session.user.id,
        email: session.user.email,
        nome: 'Administrador'
      };
      
      document.getElementById('plataforma_admin_modal').style.display = 'none';
      plataforma_showAdminPortal();
      
      // Fechar qualquer overlay
      document.getElementById('plataforma_overlay').style.display = 'none';
    },

    // Logout
    logout: async () => {
      if (confirm("Deseja sair do sistema?")) {
        await supabaseClient.auth.signOut();
        plataforma.isAdmin = false;
        plataforma.currentUser = null;
        document.getElementById('plataforma_overlay').style.display = 'none';
        document.getElementById('plataforma_admin_portal').style.display = 'none';
        document.getElementById('plataforma_client_portal').style.display = 'none';
        document.getElementById('plataforma_login_modal').style.display = 'none';
      }
    }
  };

  // Inicia verificação de Auth imediatamente
  window.addEventListener('DOMContentLoaded', function() {
    // Inicializa o IndexedDB
    dbManager.init().then(() => {
      console.log('IndexedDB inicializado para plataforma');
    }).catch(error => {
      console.error('Erro ao inicializar IndexedDB:', error);
    });
    
    authManager.init();
    
    // Configurar evento para o botão de login admin
    const adminPasswordInput = document.getElementById('plataforma_admin_senha');
    if (adminPasswordInput) {
      adminPasswordInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          authManager.login();
        }
      });
    }
  });

  // ==================== PORTAL DO CLIENTE (ATUALIZADO PARA INDEXEDDB) ====================
  const plataforma = {
    currentUser: null,
    isAdmin: false,
    configAlertas: {
      diasAntecedencia: 3,
      mensagemPadrao: `Olá {nome}! Este é um lembrete sobre o prazo: {titulo}\nVencimento: {data}\nAcesse seu portal para mais detalhes: {link_portal}`
    },
    
    // Usar as tabelas do IndexedDB
    TABLES: TABLES_PLATAFORMA
  };

  // Máscara para CPF
  function formatarCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
    cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
    cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    return cpf;
  }

  // Aplicar máscara de CPF nos inputs
  document.addEventListener('DOMContentLoaded', function() {
    const cpfInputs = document.querySelectorAll('.cpf-input');
    cpfInputs.forEach(input => {
      input.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 11) value = value.substring(0, 11);
        e.target.value = formatarCPF(value);
      });
    });
  });

  // Inicialização do sistema
  function plataforma_init() {
    console.log('Sistema de Portal do Cliente inicializado (IndexedDB)');
    
    // Carregar configurações de alertas
    plataforma_carregarConfigAlertas();
  }

  // Login do cliente via CPF
  function plataforma_login() {
    let cpf = document.getElementById('plataforma_input_cpf').value.trim();
    cpf = cpf.replace(/\D/g, ''); // Remover formatação
    
    if (!cpf || cpf.length !== 11) {
      alert('Por favor, digite um CPF válido (11 dígitos)');
      return;
    }
    
    // Buscar cliente no IndexedDB
    plataforma_buscarClientePorCPF(cpf);
  }

  async function plataforma_buscarClientePorCPF(cpf) {
    try {
      const cliente = await dbManager.getByIndex(plataforma.TABLES.CLIENTES, 'cpf', cpf);

      if (!cliente) {
        alert('CPF não encontrado. Entre em contato com o suporte.');
        return;
      }

      if (cliente.status !== 'ativo') {
        alert('Conta inativa. Entre em contato com o suporte.');
        return;
      }

      // Cliente válido, fazer login
      plataforma.currentUser = cliente;
      
      // Atualizar último acesso
      cliente.ultimo_acesso = new Date().toISOString();
      await dbManager.update(plataforma.TABLES.CLIENTES, cliente.id, cliente);

      plataforma_showClientPortal();
      
    } catch (error) {
      console.error('Erro ao buscar cliente:', error);
      alert('Erro ao processar login. Tente novamente.');
    }
  }

  // Logout
  function plataforma_logout() {
    plataforma.currentUser = null;
    plataforma.isAdmin = false;
    plataforma_showLoginModal();
  }

  // Mostrar portal do cliente
  function plataforma_showClientPortal() {
    document.getElementById('plataforma_overlay').style.display = 'block';
    document.getElementById('plataforma_client_portal').style.display = 'block';
    document.getElementById('plataforma_login_modal').style.display = 'none';
    
    plataforma_carregarDadosCliente();
  }

  // Carregar dados do cliente
  async function plataforma_carregarDadosCliente() {
    if (!plataforma.currentUser) return;
    
    // Atualizar nome do cliente
    document.getElementById('plataforma_client_name').innerHTML = 
      `<i class="fas fa-user-circle"></i> ${plataforma.currentUser.nome}`;
    
    // Atualizar último acesso
    const lastAccess = plataforma.currentUser.ultimo_acesso 
      ? new Date(plataforma.currentUser.ultimo_acesso).toLocaleString('pt-BR')
      : 'Primeiro acesso';
    document.getElementById('plataforma_last_access').textContent = lastAccess;
    
    // Mostrar CPF formatado
    if (plataforma.currentUser.cpf) {
      document.getElementById('plataforma_client_cpf').textContent = 
        formatarCPF(plataforma.currentUser.cpf);
    }
    
    // Carregar dados
    await plataforma_carregarProjetoCliente();
    await plataforma_carregarLinksCliente();
    await plataforma_carregarOrientacoesCliente();
    await plataforma_carregarPrazosCliente();
    await plataforma_carregarLembretesCliente();
  }

  // Carregar projeto do cliente
  async function plataforma_carregarProjetoCliente() {
    if (!plataforma.currentUser) return;
    
    try {
      const projetos = await dbManager.getAllByIndex(plataforma.TABLES.PROJETOS, 'cliente_id', plataforma.currentUser.id);
      const projeto = projetos && projetos.length > 0 ? projetos[0] : null;

      if (projeto) {
        document.getElementById('plataforma_project_title').textContent = projeto.titulo;
        document.getElementById('plataforma_project_desc').textContent = projeto.descricao || 'Sem descrição';
        document.getElementById('plataforma_project_status').textContent = projeto.status;
        document.getElementById('plataforma_project_status').className = `plataforma_status ${projeto.status}`;
        
        const progresso = projeto.progresso || 0;
        document.getElementById('plataforma_progress_text').textContent = `${progresso}%`;
        document.getElementById('plataforma_progress_bar').style.width = `${progresso}%`;
        
        await plataforma_carregarEtapasProjeto(projeto.id);
      } else {
        document.getElementById('plataforma_project_title').textContent = 'Nenhum projeto encontrado';
        document.getElementById('plataforma_project_desc').textContent = 'Entre em contato com o administrador';
        document.getElementById('plataforma_project_status').textContent = 'Não iniciado';
      }
    } catch (error) {
      console.error('Erro ao carregar projeto:', error);
    }
  }

  // Carregar etapas do projeto
  async function plataforma_carregarEtapasProjeto(projetoId) {
    try {
      const etapas = await dbManager.getAllByIndex(plataforma.TABLES.ETAPAS, 'projeto_id', projetoId);

      const timeline = document.getElementById('plataforma_timeline');
      timeline.innerHTML = '';
      
      if (etapas && etapas.length > 0) {
        // Ordenar por data
        etapas.sort((a, b) => new Date(a.data) - new Date(b.data));
        
        etapas.forEach(etapa => {
          const item = document.createElement('div');
          item.className = 'plataforma_timeline_item';
          
          const date = new Date(etapa.data).toLocaleDateString('pt-BR');
          item.innerHTML = `
            <div class="plataforma_timeline_date">${date}</div>
            <div style="color: rgba(255, 255, 255, 0.9);">${etapa.titulo}</div>
            <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.9rem; margin-top: 5px;">${etapa.descricao || ''}</div>
          `;
          
          timeline.appendChild(item);
        });
      } else {
        timeline.innerHTML = `
          <div class="plataforma_timeline_item">
            <div class="plataforma_timeline_date">${new Date().toLocaleDateString('pt-BR')}</div>
            <div style="color: rgba(255, 255, 255, 0.9);">Projeto iniciado</div>
          </div>
        `;
      }
    } catch (error) {
      console.error('Erro ao carregar etapas:', error);
    }
  }

  // Carregar links do cliente
  async function plataforma_carregarLinksCliente() {
    if (!plataforma.currentUser) return;
    
    try {
      const links = await dbManager.getAllByIndex(plataforma.TABLES.LINKS, 'cliente_id', plataforma.currentUser.id);

      const linksList = document.getElementById('plataforma_links_list');
      linksList.innerHTML = '';
      
      if (links && links.length > 0) {
        links.forEach(link => {
          const li = document.createElement('li');
          li.innerHTML = `
            <a href="${link.url}" target="_blank" class="plataforma_link_item">
              <i class="fas fa-external-link-alt"></i>
              <span>${link.nome}</span>
            </a>
          `;
          linksList.appendChild(li);
        });
      } else {
        linksList.innerHTML = `
          <li>
            <div class="plataforma_link_item" style="opacity: 0.7;">
              <i class="fas fa-info-circle"></i>
              <span>Nenhum link disponível no momento</span>
            </div>
          </li>
        `;
      }
    } catch (error) {
      console.error('Erro ao carregar links:', error);
    }
  }

  // Carregar orientações do cliente
  async function plataforma_carregarOrientacoesCliente() {
    if (!plataforma.currentUser) return;
    
    try {
      const orientacoes = await dbManager.getAllByIndex(plataforma.TABLES.ORIENTACOES, 'cliente_id', plataforma.currentUser.id);

      const container = document.getElementById('plataforma_orientacoes');
      container.innerHTML = '';
      
      if (orientacoes && orientacoes.length > 0) {
        orientacoes.forEach(orientacao => {
          const alert = document.createElement('div');
          alert.className = 'plataforma_alert info';
          alert.innerHTML = `
            <i class="fas fa-info-circle"></i>
            <div>${orientacao.texto}</div>
          `;
          container.appendChild(alert);
        });
      } else {
        container.innerHTML = `
          <div class="plataforma_alert info">
            <i class="fas fa-info-circle"></i>
            <div>Nenhuma orientação disponível no momento.</div>
          </div>
        `;
      }
    } catch (error) {
      console.error('Erro ao carregar orientações:', error);
    }
  }

  // Carregar prazos do cliente
  async function plataforma_carregarPrazosCliente() {
    if (!plataforma.currentUser) return;
    
    try {
      const prazos = await dbManager.getAllByIndex(plataforma.TABLES.PRAZOS, 'cliente_id', plataforma.currentUser.id);

      const container = document.getElementById('plataforma_prazos');
      container.innerHTML = '';
      
      if (prazos && prazos.length > 0) {
        prazos.sort((a, b) => new Date(a.data) - new Date(b.data)).forEach(prazo => {
          const date = new Date(prazo.data).toLocaleDateString('pt-BR');
          const today = new Date();
          const prazoDate = new Date(prazo.data);
          const diffTime = prazoDate - today;
          const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
          
          let statusClass = 'ok';
          let vencimentoClass = 'ok';
          if (diffDays < 0) {
            statusClass = 'danger';
            vencimentoClass = 'vencido';
          } else if (diffDays <= 3) {
            statusClass = 'warning';
            vencimentoClass = 'proximo';
          }
          
          const item = document.createElement('div');
          item.className = `vencimento-item ${vencimentoClass}`;
          item.innerHTML = `
            <div>
              <strong>${prazo.titulo}</strong><br>
              <small>Vencimento: ${date} (${diffDays >= 0 ? `${diffDays} dias restantes` : 'VENCIDO'})</small>
            </div>
            <span class="alerta-status ${prazo.status_alerta || 'pendente'}">
              ${prazo.status_alerta === 'enviado' ? '✔️ Enviado' : '⏳ Pendente'}
            </span>
          `;
          container.appendChild(item);
        });
      } else {
        container.innerHTML = `
          <div class="plataforma_alert info">
            <i class="fas fa-info-circle"></i>
            <div>Nenhum prazo definido no momento.</div>
          </div>
        `;
      }
    } catch (error) {
      console.error('Erro ao carregar prazos:', error);
    }
  }

  // Carregar lembretes do cliente
  async function plataforma_carregarLembretesCliente() {
    if (!plataforma.currentUser) return;
    
    try {
      const lembretes = await dbManager.getAllByIndex(plataforma.TABLES.LEMBRETES, 'cliente_id', plataforma.currentUser.id);

      const container = document.getElementById('plataforma_lembretes');
      container.innerHTML = '';
      
      if (lembretes && lembretes.length > 0) {
        lembretes.forEach(lembrete => {
          const item = document.createElement('div');
          item.className = 'lembrete-item';
          item.innerHTML = `
            <i class="fas fa-sticky-note" style="color: var(--primary);"></i>
            <div style="flex: 1;">
              ${lembrete.texto}
              ${lembrete.data ? `<br><small style="color: rgba(255,255,255,0.5);">${new Date(lembrete.data).toLocaleDateString('pt-BR')}</small>` : ''}
            </div>
          `;
          container.appendChild(item);
        });
      } else {
        container.innerHTML = `
          <div class="plataforma_alert info">
            <i class="fas fa-info-circle"></i>
            <div>Nenhum lembrete disponível no momento.</div>
          </div>
        `;
      }
    } catch (error) {
      console.error('Erro ao carregar lembretes:', error);
    }
  }

  // ==================== ÁREA ADMINISTRATIVA COM INDEXEDDB ====================
  document.getElementById('plataforma_admin_access').addEventListener('click', () => {
    document.getElementById('plataforma_admin_modal').style.display = 'flex';
  });

  function plataforma_admin_fecharModal() {
    document.getElementById('plataforma_admin_modal').style.display = 'none';
    document.getElementById('plataforma_admin_email').value = '';
    document.getElementById('plataforma_admin_senha').value = '';
    document.getElementById('plataforma_admin_error').style.display = 'none';
  }

  function plataforma_admin_login() {
    authManager.login();
  }

  function plataforma_showAdminPortal() {
    document.getElementById('plataforma_overlay').style.display = 'block';
    document.getElementById('plataforma_admin_portal').style.display = 'block';
    document.getElementById('plataforma_admin_modal').style.display = 'none';
    
    plataforma_admin_carregarDashboard();
    plataforma_admin_carregarClientesSelect();
  }

  function plataforma_admin_logout() {
    authManager.logout();
  }

  function plataforma_admin_showSection(section) {
    document.getElementById('plataforma_admin_dashboard').style.display = 'none';
    document.getElementById('plataforma_admin_clientes').style.display = 'none';
    document.getElementById('plataforma_admin_notificacoes').style.display = 'none';
    
    if (section === 'clientes') {
      document.getElementById('plataforma_admin_clientes').style.display = 'block';
    } else if (section === 'notificacoes') {
      document.getElementById('plataforma_admin_notificacoes').style.display = 'block';
      plataforma_admin_carregarAlertas();
    } else {
      document.getElementById('plataforma_admin_dashboard').style.display = 'block';
    }
  }

  function plataforma_admin_showDashboard() {
    plataforma_admin_showSection('dashboard');
    plataforma_admin_carregarDashboard();
  }

  async function plataforma_admin_carregarDashboard() {
    try {
      // Contar clientes
      const totalClientes = await dbManager.count(plataforma.TABLES.CLIENTES);
      document.getElementById('plataforma_admin_total_clientes').textContent = totalClientes || 0;

      // Contar projetos
      const totalProjetos = await dbManager.count(plataforma.TABLES.PROJETOS);
      document.getElementById('plataforma_admin_total_projetos').textContent = totalProjetos || 0;

      // Contar alertas pendentes
      const totalAlertas = await dbManager.countByIndex(plataforma.TABLES.ALERTAS, 'status', 'pendente');
      document.getElementById('plataforma_admin_total_alertas').textContent = totalAlertas || 0;

      // Contar vencimentos hoje
      const hoje = new Date().toISOString().split('T')[0];
      const prazosHoje = await dbManager.getAllByIndex(plataforma.TABLES.PRAZOS, 'data', hoje);
      document.getElementById('plataforma_admin_total_vencimentos').textContent = prazosHoje ? prazosHoje.length : 0;

      // Carregar lista de clientes
      await plataforma_admin_carregarListaClientes();
      
      // Atualizar badge de notificações
      plataforma_admin_atualizarBadgeNotificacoes();
      
    } catch (error) {
      console.error('Erro ao carregar dashboard:', error);
    }
  }

  async function plataforma_admin_carregarListaClientes() {
    try {
      const clientes = await dbManager.getAll(plataforma.TABLES.CLIENTES);
      const projetos = await dbManager.getAll(plataforma.TABLES.PROJETOS);

      const tbody = document.getElementById('plataforma_admin_clientes_list');
      tbody.innerHTML = '';
      
      if (clientes && clientes.length > 0) {
        clientes.forEach(cliente => {
          const projeto = projetos ? projetos.find(p => p.cliente_id === cliente.id) : null;
          const projetoNome = projeto ? projeto.titulo : 'Sem projeto';
          
          const statusBadge = cliente.status === 'ativo' 
            ? '<span class="plataforma_badge success">Ativo</span>'
            : cliente.status === 'inativo'
            ? '<span class="plataforma_badge danger">Inativo</span>'
            : '<span class="plataforma_badge warning">Pendente</span>';
          
          const row = document.createElement('tr');
          row.innerHTML = `
            <td><strong>${cliente.nome}</strong><br><small>${cliente.email}</small></td>
            <td>${cliente.cpf ? formatarCPF(cliente.cpf) : 'Não cadastrado'}</td>
            <td>${cliente.whatsapp || 'Não cadastrado'}</td>
            <td>${statusBadge}</td>
            <td>${projetoNome}</td>
            <td>
              <button class="alerta-whatsapp-btn" onclick="plataforma_admin_enviarAlertaCliente(${cliente.id})" title="Enviar alerta por WhatsApp">
                <i class="fab fa-whatsapp"></i>
              </button>
            </td>
          `;
          
          tbody.appendChild(row);
        });
      } else {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">
              <i class="fas fa-users-slash"></i> Nenhum cliente cadastrado
            </td>
          </tr>
        `;
      }
    } catch (error) {
      console.error('Erro ao carregar lista de clientes:', error);
    }
  }

  async function plataforma_admin_carregarClientesSelect() {
    try {
      const clientes = await dbManager.getAll(plataforma.TABLES.CLIENTES);

      const selects = [
        'plataforma_projeto_cliente',
        'plataforma_conteudo_cliente'
      ];
      
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
          select.innerHTML = '<option value="">Selecione um cliente</option>';
          if (clientes && clientes.length > 0) {
            clientes.forEach(cliente => {
              const option = document.createElement('option');
              option.value = cliente.id;
              option.textContent = `${cliente.nome} (${cliente.cpf ? formatarCPF(cliente.cpf) : 'Sem CPF'})`;
              select.appendChild(option);
            });
          }
        }
      });
    } catch (error) {
      console.error('Erro ao carregar selects de clientes:', error);
    }
  }

  async function plataforma_admin_salvarCliente() {
    const nome = document.getElementById('plataforma_novo_nome').value.trim();
    const email = document.getElementById('plataforma_novo_email').value.trim();
    let cpf = document.getElementById('plataforma_novo_cpf').value.trim();
    const whatsapp = document.getElementById('plataforma_novo_whatsapp').value.trim();
    const status = document.getElementById('plataforma_novo_status').value;
    
    cpf = cpf.replace(/\D/g, '');
    
    if (!nome || !email || !cpf || cpf.length !== 11) {
      alert('Por favor, preencha todos os campos obrigatórios com CPF válido (11 dígitos)');
      return;
    }
    
    try {
      // Verificar se CPF já existe
      const clienteExistente = await dbManager.getByIndex(plataforma.TABLES.CLIENTES, 'cpf', cpf);

      if (clienteExistente) {
        alert('CPF já cadastrado no sistema');
        return;
      }

      const novoCliente = {
        nome,
        email,
        cpf,
        whatsapp,
        status,
        data_cadastro: new Date().toISOString(),
        ultimo_acesso: null
      };

      await dbManager.add(plataforma.TABLES.CLIENTES, novoCliente);

      alert('Cliente cadastrado com sucesso! CPF será a senha de acesso.');
      document.getElementById('plataforma_novo_nome').value = '';
      document.getElementById('plataforma_novo_email').value = '';
      document.getElementById('plataforma_novo_cpf').value = '';
      document.getElementById('plataforma_novo_whatsapp').value = '';
      
      plataforma_admin_carregarClientesSelect();
      plataforma_admin_carregarListaClientes();
      plataforma_admin_carregarDashboard();
      
    } catch (error) {
      console.error('Erro ao salvar cliente:', error);
      alert('Erro ao salvar cliente: ' + error.message);
    }
  }

  async function plataforma_admin_carregarProjetoCliente() {
    const clienteId = parseInt(document.getElementById('plataforma_projeto_cliente').value);
    
    if (!clienteId) return;
    
    try {
      const projetos = await dbManager.getAllByIndex(plataforma.TABLES.PROJETOS, 'cliente_id', clienteId);
      const projeto = projetos && projetos.length > 0 ? projetos[0] : null;

      if (projeto) {
        document.getElementById('plataforma_projeto_titulo').value = projeto.titulo || '';
        document.getElementById('plataforma_projeto_desc').value = projeto.descricao || '';
        document.getElementById('plataforma_projeto_status').value = projeto.status || 'pendente';
        document.getElementById('plataforma_projeto_progresso').value = projeto.progresso || 0;
        document.getElementById('plataforma_projeto_progresso_text').textContent = `${projeto.progresso || 0}%`;
      } else {
        document.getElementById('plataforma_projeto_titulo').value = '';
        document.getElementById('plataforma_projeto_desc').value = '';
        document.getElementById('plataforma_projeto_status').value = 'pendente';
        document.getElementById('plataforma_projeto_progresso').value = 0;
        document.getElementById('plataforma_projeto_progresso_text').textContent = '0%';
      }
    } catch (error) {
      console.error('Erro ao carregar projeto:', error);
    }
  }

  async function plataforma_admin_salvarProjeto() {
    const clienteId = parseInt(document.getElementById('plataforma_projeto_cliente').value);
    const titulo = document.getElementById('plataforma_projeto_titulo').value.trim();
    const descricao = document.getElementById('plataforma_projeto_desc').value.trim();
    const status = document.getElementById('plataforma_projeto_status').value;
    const progresso = parseInt(document.getElementById('plataforma_projeto_progresso').value);
    
    if (!clienteId || !titulo) {
      alert('Por favor, selecione um cliente e informe o título do projeto');
      return;
    }
    
    try {
      const projeto = {
        cliente_id: clienteId,
        titulo,
        descricao,
        status,
        progresso,
        data_atualizacao: new Date().toISOString()
      };

      // Verificar se projeto já existe
      const projetos = await dbManager.getAllByIndex(plataforma.TABLES.PROJETOS, 'cliente_id', clienteId);
      const projetoExistente = projetos && projetos.length > 0 ? projetos[0] : null;

      if (projetoExistente) {
        // Atualizar projeto existente
        projeto.id = projetoExistente.id;
        projeto.data_criacao = projetoExistente.data_criacao;
        await dbManager.update(plataforma.TABLES.PROJETOS, projetoExistente.id, projeto);
      } else {
        // Criar novo projeto
        projeto.data_criacao = new Date().toISOString();
        await dbManager.add(plataforma.TABLES.PROJETOS, projeto);
      }

      alert('Projeto salvo com sucesso!');
      
      // Adicionar etapa se status mudou
      if (!projetoExistente || projetoExistente.status !== status) {
        const statusText = {
          'pendente': 'Projeto criado e aguardando início',
          'andamento': 'Projeto em andamento',
          'concluido': 'Projeto concluído com sucesso',
          'aguardando': 'Aguardando ação do cliente'
        };
        
        // Buscar ID do projeto salvo
        const projetosAtualizados = await dbManager.getAllByIndex(plataforma.TABLES.PROJETOS, 'cliente_id', clienteId);
        const projetoSalvo = projetosAtualizados && projetosAtualizados.length > 0 ? projetosAtualizados[0] : null;
        
        if (projetoSalvo) {
          const etapa = {
            projeto_id: projetoSalvo.id,
            titulo: `Status alterado para: ${status}`,
            descricao: statusText[status] || 'Status atualizado',
            data: new Date().toISOString()
          };
          
          await dbManager.add(plataforma.TABLES.ETAPAS, etapa);
        }
      }
      
    } catch (error) {
      console.error('Erro ao salvar projeto:', error);
      alert('Erro ao salvar projeto: ' + error.message);
    }
  }

  async function plataforma_admin_adicionarLink() {
    const clienteId = parseInt(document.getElementById('plataforma_conteudo_cliente').value);
    const nome = document.getElementById('plataforma_novo_link_nome').value.trim();
    const url = document.getElementById('plataforma_novo_link_url').value.trim();
    
    if (!clienteId || !nome || !url) {
      alert('Por favor, selecione um cliente e preencha nome e URL do link');
      return;
    }
    
    try {
      const link = {
        cliente_id: clienteId,
        nome,
        url,
        data_criacao: new Date().toISOString()
      };

      await dbManager.add(plataforma.TABLES.LINKS, link);

      alert('Link adicionado com sucesso!');
      document.getElementById('plataforma_novo_link_nome').value = '';
      document.getElementById('plataforma_novo_link_url').value = '';
      
    } catch (error) {
      console.error('Erro ao adicionar link:', error);
      alert('Erro ao adicionar link: ' + error.message);
    }
  }

  async function plataforma_admin_adicionarOrientacao() {
    const clienteId = parseInt(document.getElementById('plataforma_conteudo_cliente').value);
    const texto = document.getElementById('plataforma_nova_orientacao').value.trim();
    
    if (!clienteId || !texto) {
      alert('Por favor, selecione um cliente e digite uma orientação');
      return;
    }
    
    try {
      const orientacao = {
        cliente_id: clienteId,
        texto,
        data_criacao: new Date().toISOString()
      };

      await dbManager.add(plataforma.TABLES.ORIENTACOES, orientacao);

      alert('Orientação adicionada com sucesso!');
      document.getElementById('plataforma_nova_orientacao').value = '';
      
    } catch (error) {
      console.error('Erro ao adicionar orientação:', error);
      alert('Erro ao adicionar orientação: ' + error.message);
    }
  }

  async function plataforma_admin_adicionarPrazo() {
    const clienteId = parseInt(document.getElementById('plataforma_conteudo_cliente').value);
    const titulo = document.getElementById('plataforma_novo_prazo_titulo').value.trim();
    const data = document.getElementById('plataforma_novo_prazo_data').value;
    
    if (!clienteId || !titulo || !data) {
      alert('Por favor, selecione um cliente e preencha título e data');
      return;
    }
    
    try {
      const prazo = {
        cliente_id: clienteId,
        titulo,
        data: new Date(data).toISOString(),
        status_alerta: 'pendente',
        data_criacao: new Date().toISOString()
      };

      await dbManager.add(plataforma.TABLES.PRAZOS, prazo);

      alert('Prazo adicionado com sucesso! O sistema notificará automaticamente.');
      document.getElementById('plataforma_novo_prazo_titulo').value = '';
      document.getElementById('plataforma_novo_prazo_data').value = '';
      
    } catch (error) {
      console.error('Erro ao adicionar prazo:', error);
      alert('Erro ao adicionar prazo: ' + error.message);
    }
  }

  async function plataforma_admin_adicionarLembrete() {
    const clienteId = parseInt(document.getElementById('plataforma_conteudo_cliente').value);
    const texto = document.getElementById('plataforma_novo_lembrete').value.trim();
    
    if (!clienteId || !texto) {
      alert('Por favor, selecione um cliente e digite um lembrete');
      return;
    }
    
    try {
      const lembrete = {
        cliente_id: clienteId,
        texto,
        data: new Date().toISOString(),
        data_criacao: new Date().toISOString()
      };

      await dbManager.add(plataforma.TABLES.LEMBRETES, lembrete);

      alert('Lembrete adicionado com sucesso!');
      document.getElementById('plataforma_novo_lembrete').value = '';
      
    } catch (error) {
      console.error('Erro ao adicionar lembrete:', error);
      alert('Erro ao adicionar lembrete: ' + error.message);
    }
  }

  async function plataforma_carregarConfigAlertas() {
    try {
      const config = await dbManager.getById(plataforma.TABLES.CONFIG, 'config_alertas');

      if (config && config.valor) {
        plataforma.configAlertas = config.valor;
        
        // Atualizar campos no formulário se existirem
        const diasInput = document.getElementById('plataforma_alerta_dias');
        const mensagemTextarea = document.getElementById('plataforma_alerta_mensagem');
        
        if (diasInput) diasInput.value = plataforma.configAlertas.diasAntecedencia || 3;
        if (mensagemTextarea) mensagemTextarea.value = plataforma.configAlertas.mensagemPadrao || '';
      }
    } catch (error) {
      console.error('Erro ao carregar configurações:', error);
    }
  }

  async function plataforma_admin_salvarConfigAlertas() {
    const dias = parseInt(document.getElementById('plataforma_alerta_dias').value);
    const mensagem = document.getElementById('plataforma_alerta_mensagem').value.trim();
    
    if (!dias || !mensagem) {
      alert('Por favor, preencha todos os campos');
      return;
    }
    
    plataforma.configAlertas = {
      diasAntecedencia: dias,
      mensagemPadrao: mensagem
    };
    
    try {
      const config = {
        chave: 'config_alertas',
        valor: plataforma.configAlertas,
        data_atualizacao: new Date().toISOString()
      };

      // Verificar se configuração já existe
      const configExistente = await dbManager.getById(plataforma.TABLES.CONFIG, 'config_alertas');

      if (configExistente) {
        // Atualizar configuração existente
        config.data_criacao = configExistente.data_criacao;
        await dbManager.update(plataforma.TABLES.CONFIG, 'config_alertas', config);
      } else {
        // Criar nova configuração
        config.data_criacao = new Date().toISOString();
        await dbManager.add(plataforma.TABLES.CONFIG, config);
      }

      alert('Configurações salvas com sucesso!');
      
    } catch (error) {
      console.error('Erro ao salvar configurações:', error);
      alert('Erro ao salvar configurações: ' + error.message);
    }
  }

  // Mostrar modal de login
  function plataforma_showLoginModal() {
    document.getElementById('plataforma_overlay').style.display = 'block';
    document.getElementById('plataforma_login_modal').style.display = 'block';
    document.getElementById('plataforma_client_portal').style.display = 'none';
    document.getElementById('plataforma_admin_portal').style.display = 'none';
    
    // Limpar campo CPF
    document.getElementById('plataforma_input_cpf').value = '';
  }

  // Fechar modal de login e voltar para a página principal
  function plataforma_fecharLoginModal() {
    document.getElementById('plataforma_overlay').style.display = 'none';
    document.getElementById('plataforma_login_modal').style.display = 'none';
    document.getElementById('plataforma_input_cpf').value = '';
  }

  async function plataforma_admin_carregarAlertas() {
    try {
      const alertas = await dbManager.getAll(plataforma.TABLES.ALERTAS);

      const container = document.getElementById('plataforma_admin_alertas_lista');
      container.innerHTML = '';
      
      if (alertas && alertas.length > 0) {
        alertas.sort((a, b) => new Date(b.data_criacao) - new Date(a.data_criacao));
        
        alertas.forEach(alerta => {
          const item = document.createElement('div');
          item.className = 'notificacao-item';
          item.innerHTML = `
            <div class="info">
              <strong>Alerta #${alerta.id}</strong><br>
              <small>${alerta.mensagem || 'Sem mensagem'}</small>
            </div>
            <div class="acoes">
              <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="plataforma_admin_marcarEnviado(${alerta.id})">
                <i class="fas fa-check"></i> Marcado
              </button>
            </div>
          `;
          container.appendChild(item);
        });
      } else {
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">
            <i class="fas fa-check-circle" style="font-size: 3rem; margin-bottom: 15px;"></i><br>
            Nenhum alerta pendente no momento.
          </div>
        `;
      }
    } catch (error) {
      console.error('Erro ao carregar alertas:', error);
    }
  }

  async function plataforma_admin_marcarEnviado(alertaId) {
    try {
      const alerta = await dbManager.getById(plataforma.TABLES.ALERTAS, alertaId);
      
      if (alerta) {
        alerta.status = 'enviado';
        alerta.data_envio = new Date().toISOString();
        await dbManager.update(plataforma.TABLES.ALERTAS, alertaId, alerta);
      }

      plataforma_admin_carregarAlertas();
      plataforma_admin_atualizarBadgeNotificacoes();
      plataforma_admin_carregarDashboard();
      
    } catch (error) {
      console.error('Erro ao marcar alerta como enviado:', error);
      alert('Erro ao atualizar alerta: ' + error.message);
    }
  }

  async function plataforma_admin_atualizarBadgeNotificacoes() {
    try {
      const totalAlertas = await dbManager.countByIndex(plataforma.TABLES.ALERTAS, 'status', 'pendente');

      const badge = document.getElementById('plataforma_notificacoes_count');
      const btn = document.getElementById('plataforma_notificacoes_btn');
      
      if (totalAlertas > 0) {
        badge.textContent = totalAlertas;
        badge.style.display = 'flex';
        btn.classList.add('pulse');
      } else {
        badge.style.display = 'none';
        btn.classList.remove('pulse');
      }
    } catch (error) {
      console.error('Erro ao atualizar badge:', error);
    }
  }

  // Inicialização
  window.addEventListener('DOMContentLoaded', function() {
    plataforma_init();
    
    // Configurar slider de progresso
    const progressSlider = document.getElementById('plataforma_projeto_progresso');
    if (progressSlider) {
      progressSlider.addEventListener('input', function() {
        document.getElementById('plataforma_projeto_progresso_text').textContent = `${this.value}%`;
      });
    }
  });

  // Event listener para o overlay
  document.getElementById('plataforma_overlay').addEventListener('click', function(e) {
    if (e.target === this && !plataforma.isAdmin && plataforma.currentUser) {
      plataforma_showClientPortal();
    }
  });

  // Função para enviar alerta por WhatsApp
  async function plataforma_admin_enviarAlertaCliente(clienteId) {
    try {
      // Buscar cliente
      const cliente = await dbManager.getById(plataforma.TABLES.CLIENTES, clienteId);

      if (!cliente) {
        alert('Cliente não encontrado');
        return;
      }

      // Buscar prazos pendentes do cliente
      const prazos = await dbManager.getAllByIndex(plataforma.TABLES.PRAZOS, 'cliente_id', clienteId);
      const prazosPendentes = prazos ? prazos.filter(p => p.status_alerta === 'pendente') : [];

      if (!prazosPendentes || prazosPendentes.length === 0) {
        alert('Nenhum prazo pendente para este cliente');
        return;
      }

      // Construir mensagem
      let mensagem = `Olá ${cliente.nome}!%0A%0A`;
      mensagem += `Lembretes de prazos:%0A%0A`;
      
      prazosPendentes.forEach((prazo, index) => {
        const dataFormatada = new Date(prazo.data).toLocaleDateString('pt-BR');
        mensagem += `${index + 1}. ${prazo.titulo} - Vencimento: ${dataFormatada}%0A`;
      });
      
      mensagem += `%0AAcesse seu portal para mais detalhes.`;
      
      // Abrir WhatsApp
      const telefone = cliente.whatsapp || '5522999999999';
      window.open(`https://wa.me/${telefone}?text=${mensagem}`, '_blank');
      
      // Marcar prazos como enviados
      for (const prazo of prazosPendentes) {
        prazo.status_alerta = 'enviado';
        await dbManager.update(plataforma.TABLES.PRAZOS, prazo.id, prazo);
      }
      
      // Criar registro de alerta enviado
      const alerta = {
        cliente_id: clienteId,
        tipo: 'whatsapp',
        mensagem: 'Lembretes de prazos enviados via WhatsApp',
        status: 'enviado',
        data_envio: new Date().toISOString(),
        data_criacao: new Date().toISOString()
      };
      
      await dbManager.add(plataforma.TABLES.ALERTAS, alerta);
      
      alert('Alerta enviado com sucesso!');
      plataforma_admin_carregarDashboard();
      
    } catch (error) {
      console.error('Erro ao enviar alerta:', error);
      alert('Erro ao enviar alerta: ' + error.message);
    }
  }
</<script>
/**
 * 🚀 UNIVERSAL IDB SYNC - FIXED (ANTI-ZOMBIE DATA)
 * - Correção: Persistência de DeviceID (Evita auto-download após F5).
 * - Correção: Force Delete (Deleta do disco mesmo se não estiver no Cache).
 */
(function () {
    // ==========================================================
    // 1. CONFIGURAÇÕES & CONSTANTES
    // ==========================================================
    const SYNC_TABLE = 'lg_crm_supadb';
    const CANONICAL_DB = 'lg_crmDB';
    
    // FIX 1: Mantém a identidade da aba mesmo após refresh (SessionStorage)
    // Isso impede que a aba baixe de volta um dado que ela mesma acabou de deletar
    let storedId = sessionStorage.getItem('sync_device_id');
    if (!storedId) {
        storedId = crypto.randomUUID();
        sessionStorage.setItem('sync_device_id', storedId);
    }
    const DEVICE_ID = storedId;
    
    let isReplicating = false; 
    let syncInterval = null;

    // 🧠 CACHE INTELIGENTE
    const syncCache = new Map();

    // ==========================================================
    // 2. UTILITÁRIOS
    // ==========================================================
    const getClient = () => window.supabaseClient || window.supabase;

    const waitForSupabase = () => new Promise(resolve => {
        const check = () => getClient() ? resolve(getClient()) : setTimeout(check, 100);
        check();
    });

    async function getUserId() {
        const client = await waitForSupabase();
        const { data } = await client.auth.getSession();
        return data?.session?.user?.id || null;
    }

    function generateSignature(value) {
        // Garante que null/undefined sejam tratados iguais
        if (value === null || value === undefined) return 'null';
        return JSON.stringify(value);
    }

    // ==========================================================
    // 3. INTERCEPTAÇÃO REAL-TIME (IndexDB -> Supabase)
    // ==========================================================
    const original = {
        put: IDBObjectStore.prototype.put,
        add: IDBObjectStore.prototype.add,
        delete: IDBObjectStore.prototype.delete
    };

    async function scheduleRealtimeUpload(storeName, method, key, value) {
        if (isReplicating) return; 

        const client = getClient();
        const userId = await getUserId();
        if (!client || !userId) return;

        const cacheKey = `${storeName}-${key}`;
        
        // Atualiza cache local imediatamente
        if (method === 'delete') {
            syncCache.delete(cacheKey);
        } else {
            syncCache.set(cacheKey, generateSignature(value));
        }

        // Envia para Supabase
        // FIX: Tratamento de erro silencioso para evitar travar a UI
        client.from(SYNC_TABLE).upsert({
            user_id: userId,
            db_name: CANONICAL_DB,
            store_name: storeName,
            record_key: String(key),
            record_value: method === 'delete' ? null : value,
            is_deleted: method === 'delete',
            device_id: DEVICE_ID,
            updated_at: new Date().toISOString()
        }, { onConflict: 'user_id,db_name,store_name,record_key' })
        .then(({ error }) => {
            if (error) console.warn(`⚠️ Sync Upload Falhou:`, error.message);
        });
    }

    IDBObjectStore.prototype.put = function (v, k) {
        const req = original.put.apply(this, arguments);
        const storeName = this.name;
        req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'put', k || e.target.result, v);
        return req;
    };

    IDBObjectStore.prototype.add = function (v, k) {
        const req = original.add.apply(this, arguments);
        const storeName = this.name;
        req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'add', k || e.target.result, v);
        return req;
    };

    IDBObjectStore.prototype.delete = function (k) {
        const req = original.delete.apply(this, arguments);
        const storeName = this.name;
        req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'delete', k, null);
        return req;
    };

    console.log('🪤 Sistema de Sync Híbrido Ativado (v2 Anti-Zombie)');

    // ==========================================================
    // 4. SMART UPLOAD LOOP (PC -> CLOUD)
    // ==========================================================
    async function smartUploadLoop() {
        const userId = await getUserId();
        const client = getClient();
        if (!userId || !client) return;

        const req = indexedDB.open(CANONICAL_DB);
        
        req.onsuccess = (e) => {
            const db = e.target.result;
            const storeNames = Array.from(db.objectStoreNames);

            storeNames.forEach(storeName => {
                const tx = db.transaction([storeName], 'readonly');
                const store = tx.objectStore(storeName);
                
                Promise.all([
                    new Promise(r => store.getAll().onsuccess = (ev) => r(ev.target.result)),
                    new Promise(r => store.getAllKeys().onsuccess = (ev) => r(ev.target.result))
                ]).then(async ([records, keys]) => {
                    if (!records.length) return;

                    const changedRecords = [];

                    records.forEach((item, index) => {
                        const key = String(keys[index]);
                        const cacheKey = `${storeName}-${key}`;
                        const currentSig = generateSignature(item);

                        // Só sobe se mudou em relação ao que sabemos
                        if (syncCache.get(cacheKey) !== currentSig) {
                            changedRecords.push({
                                user_id: userId,
                                db_name: CANONICAL_DB,
                                store_name: storeName,
                                record_key: key,
                                record_value: item,
                                is_deleted: false,
                                device_id: DEVICE_ID,
                                updated_at: new Date().toISOString()
                            });
                            syncCache.set(cacheKey, currentSig);
                        }
                    });

                    if (changedRecords.length > 0) {
                        console.log(`📤 Upload Batch: ${changedRecords.length} itens`);
                        await client.from(SYNC_TABLE).upsert(changedRecords, { 
                            onConflict: 'user_id,db_name,store_name,record_key' 
                        });
                    }
                });
            });
        };
    }

    // ==========================================================
    // 5. SMART DOWNLOAD LOOP (CLOUD -> PC)
    // ==========================================================
    async function smartDownloadLoop() {
        const userId = await getUserId();
        const client = getClient();
        if (!userId || !client) return;

        const { data, error } = await client
            .from(SYNC_TABLE)
            .select('*')
            .eq('user_id', userId)
            .eq('db_name', CANONICAL_DB);

        if (error || !data || !data.length) return;

        const req = indexedDB.open(CANONICAL_DB);
        req.onsuccess = (e) => {
            const db = e.target.result;
            const localStores = Array.from(db.objectStoreNames);
            
            const validRecords = data.filter(r => localStores.includes(r.store_name));
            if (!validRecords.length) return;

            const tx = db.transaction([...new Set(validRecords.map(r => r.store_name))], 'readwrite');
            isReplicating = true;

            let writes = 0;

            validRecords.forEach(r => {
                // ANTI-ECHO: Se o dado veio deste mesmo DEVICE_ID, ignoramos.
                // Como agora usamos sessionStorage, isso persiste após refresh.
                if (r.device_id === DEVICE_ID) return;

                const store = tx.objectStore(r.store_name);
                // Converte chave numérica se necessário
                const key = !isNaN(r.record_key) ? Number(r.record_key) : r.record_key;
                const cacheKey = `${r.store_name}-${r.record_key}`;
                
                // LÓGICA DE DELETE (CORRIGIDA)
                if (r.is_deleted) {
                    // FIX: Deleta incondicionalmente. Se não existir, não dá erro.
                    // Antes verificávamos o cache, o que impedia deletes em sessões novas.
                    store.delete(key);
                    
                    if (syncCache.has(cacheKey)) {
                        syncCache.delete(cacheKey);
                        writes++;
                    }
                    return;
                }

                // LÓGICA DE UPDATE/INSERT
                const incomingSig = generateSignature(r.record_value);
                const localSig = syncCache.get(cacheKey);

                if (incomingSig === localSig) {
                    return; 
                }

                // Atualiza IDB
                const val = r.record_value;
                if (store.keyPath && val && typeof val === 'object') {
                    // Se a store usa keyPath inline, injetamos a chave se necessário
                    if (!val[store.keyPath]) val[store.keyPath] = key;
                    store.put(val);
                } else {
                    store.put(val, key);
                }
                
                syncCache.set(cacheKey, incomingSig);
                writes++;
            });

            tx.oncomplete = () => {
                isReplicating = false;
                if (writes > 0) console.log(`📥 Download Sync: ${writes} alterações aplicadas.`);
            };
            
            tx.onerror = () => isReplicating = false;
        };
    }

    // ==========================================================
    // 6. INICIALIZAÇÃO
    // ==========================================================
    async function startService() {
        const userId = await getUserId();
        if (!userId) return;

        console.log('✅ Serviço de Sync Iniciado para:', userId);
        const client = getClient();

        client.channel('global-sync-live')
            .on('postgres_changes', { 
                event: '*', schema: 'public', table: SYNC_TABLE, filter: `user_id=eq.${userId}` 
            }, payload => {
                // Só dispara download se o evento veio de OUTRO device
                if (payload.new && payload.new.device_id !== DEVICE_ID) {
                    smartDownloadLoop();
                }
            })
            .subscribe();

        // Ordem estratégica: Carrega Cache Local -> Baixa Nuvem -> Inicia Loop
        await smartUploadLoop(); 
        setTimeout(smartDownloadLoop, 500); // Pequeno delay para garantir que o Upload populou o cache

        if (syncInterval) clearInterval(syncInterval);
        syncInterval = setInterval(async () => {
            await smartUploadLoop();
            await smartDownloadLoop();
        }, 10000);
    }

    waitForSupabase().then(client => {
        client.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN' && session) startService();
        });
        getUserId().then(id => { if (id) startService(); });
    });

})();
</script>
</body>
</html>
