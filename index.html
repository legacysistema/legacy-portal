old<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Legacy Platform — Enterprise Edition</title>

  <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@700&family=Inter:wght@300;400;500;600&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg-dark: #020617;
      --text-white: #ffffff;
      --glass-bg: rgba(255, 255, 255, 0.08);
      --glass-border: rgba(255, 255, 255, 0.15);
      --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
      --primary: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html { scroll-behavior: smooth; }

    body {
      font-family: 'Poppins', 'Inter', sans-serif;
      background: var(--bg-dark);
      color: var(--text-white);
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* ================= HEADER ================= */
    header {
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 48px;
      background: rgba(2, 6, 23, 0.85);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1000;
      transition: all 0.3s ease;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 18px;
      flex-shrink: 0;
    }

    .brand-text strong {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 22px;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .brand-text span {
      font-size: 11px;
      letter-spacing: 3px;
      color: var(--primary);
      display: block;
    }

    /* Navegação Topo */
    .header-nav {
      display: flex;
      gap: 30px;
      overflow-x: auto;
      scrollbar-width: none;
    }
    .header-nav::-webkit-scrollbar { display: none; }

    .nav-link {
      color: rgba(255,255,255,0.7);
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      padding-bottom: 5px;
      border-bottom: 2px solid transparent;
      white-space: nowrap;
    }

    .nav-link:hover, .nav-link.active {
      color: #fff;
      border-bottom-color: var(--primary);
    }

    .header-spacer { width: 50px; }

    /* ================= MAIN STRUTUCTURE ================= */
    main {
      padding-top: 110px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      padding-bottom: 100px;
    }

    /* Blobs de Fundo */
    .background-blobs {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      z-index: 0; pointer-events: none; overflow: hidden;
      position: fixed;
    }

    .blob {
      position: absolute; border-radius: 50%;
      filter: blur(80px); opacity: 0.6;
    }
    .blob-1 {
      width: 500px; height: 500px; background: #ff007a;
      top: 20%; left: 20%; animation: float 6s ease-in-out infinite;
    }
    .blob-2 {
      width: 400px; height: 400px; background: #3b82f6;
      bottom: 10%; right: 20%; animation: float 8s ease-in-out infinite reverse;
    }

    @keyframes float {
      0% { transform: translate(0, 0); }
      50% { transform: translate(30px, -30px); }
      100% { transform: translate(0, 0); }
    }

    /* ================= GLASS CARDS (DASHBOARD) ================= */
    .glass-slider-container {
      position: relative; z-index: 10;
      display: flex; gap: 30px; padding: 20px;
      width: 100%; max-width: 1200px;
      justify-content: center; 
      flex-wrap: wrap;
      margin-bottom: 80px;
    }

    .glass-card {
      width: 300px; height: 420px;
      background: var(--glass-bg);
      backdrop-filter: blur(15px);
      -webkit-backdrop-filter: blur(15px);
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 30px;
      display: flex; flex-direction: column;
      align-items: center; text-align: center;
      box-shadow: var(--glass-shadow);
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      color: #fff;
      flex-shrink: 0;
    }
    .glass-card:hover {
      transform: translateY(-10px);
      background: rgba(255, 255, 255, 0.12);
    }

    .card-img-wrapper {
      width: 100px; height: 100px;
      border-radius: 50%;
      border: 3px solid rgba(255,255,255,0.3);
      margin-bottom: 20px;
      overflow: hidden;
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.2);
    }
    .card-img-wrapper i { font-size: 40px; color: #fff; }

    .card-title { font-size: 22px; font-weight: 600; margin-bottom: 5px; }
    .card-role { font-size: 14px; color: rgba(255,255,255,0.7); margin-bottom: 30px; }

    .btn-glass {
      margin-top: auto;
      background: #ffffff; color: #020617;
      border: none; padding: 12px 30px;
      border-radius: 8px; font-weight: 600;
      cursor: pointer; transition: 0.3s;
      text-transform: uppercase; font-size: 13px; letter-spacing: 1px;
    }
    .btn-glass:hover {
      background: var(--primary); color: white;
      box-shadow: 0 0 15px var(--primary);
    }

    /* ================= PRICING SECTION ================= */
    #planos {
      width: 100%; text-align: center; padding: 40px 20px;
      z-index: 10; position: relative;
    }
    #planos h2 { font-size: 2.8rem; font-weight: 800; margin-bottom: 10px; text-shadow: 0 2px 10px rgba(0,0,0,0.5); line-height: 1.2; }
    #planos p { max-width: 800px; margin: 0 auto 50px; color: rgba(255,255,255,0.8); font-size: 1.1rem; }

    .pricing-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
      gap: 20px;
      max-width: 1300px;
      margin: 0 auto;
      padding: 0 10px;
      align-items: stretch;
    }

    .price-card {
      position: relative;
      background: rgba(15, 23, 42, 0.6); 
      border: 1px solid var(--glass-border);
      border-radius: 20px;
      padding: 30px 25px;
      backdrop-filter: blur(12px);
      transition: .3s;
      display: flex; flex-direction: column;
      text-align: left;
    }

    .price-card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px -10px rgba(0,0,0,.6); }
    
    .price-card.featured {
      border-color: var(--primary);
      background: rgba(59, 130, 246, 0.08);
      box-shadow: 0 0 30px rgba(59,130,246,.2);
      transform: scale(1.02);
      z-index: 11;
    }
    .price-card.featured:hover { transform: scale(1.02) translateY(-8px); }

    .badge-best {
      position: absolute; top: -14px; left: 50%; transform: translateX(-50%);
      background: var(--primary); color: #fff; padding: 6px 20px; border-radius: 20px;
      font-size: .75rem; font-weight: 700; text-transform: uppercase;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.4);
    }

    .plan-title { font-size: 1.4rem; font-weight: 700; margin-bottom: 5px; }
    .plan-desc { font-size: .85rem; color: rgba(255,255,255,.6); margin-bottom: 20px; min-height: 40px; }

    .price-box { margin-bottom: 5px; }
    .price-value { font-size: 2.2rem; font-weight: 800; color: #fff; }
    .price-suffix { font-size: 1rem; color: rgba(255,255,255,0.6); font-weight: 400; }
    
    .billing-note {
        font-size: 0.8rem;
        color: var(--success);
        font-weight: 500;
        margin-bottom: 25px;
        display: block;
        min-height: 20px;
    }

    .feature-list { list-style: none; padding: 0; margin-bottom: 30px; text-align: left; margin-top: auto; }
    .feature-list li { display: flex; gap: 10px; margin-bottom: 12px; font-size: .85rem; align-items: flex-start; line-height: 1.4; color: rgba(255,255,255,0.85); }
    .feature-list li i { color: var(--primary); margin-top: 3px; font-size: 0.9rem; flex-shrink: 0; }
    .feature-list li.disabled { color: rgba(255,255,255,0.4); }
    .feature-list li.disabled i { color: rgba(255,255,255,0.3); }

    .btn-select-plan {
      width: 100%;
      padding: 12px; border-radius: 10px;
      background: transparent; color: #fff;
      border: 1px solid rgba(255,255,255,.2); cursor: pointer;
      transition: 0.3s; font-weight: 600; font-size: 0.9rem;
    }
    .btn-select-plan:hover { background: rgba(255,255,255,0.1); border-color: #fff; }
    
    .price-card.featured .btn-select-plan { background: var(--primary); border-color: var(--primary); }
    .price-card.featured .btn-select-plan:hover { background: #2563eb; }

    /* ================= MODAL DE PAGAMENTO ================= */
    #paymentModal {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,.9); z-index: 3000;
      align-items: center; justify-content: center;
      backdrop-filter: blur(5px);
    }
    #paymentModal .modal-box {
      background: #0f172a; padding: 30px; border-radius: 20px;
      max-width: 420px; width: 90%; text-align: center;
      border: 1px solid var(--glass-border);
      box-shadow: 0 0 50px rgba(59,130,246,0.3);
    }
    #paymentModal button {
      margin-top: 20px; padding: 12px 24px; border-radius: 10px;
      border: none; background: var(--primary); color: #fff; cursor: pointer;
      font-weight: bold; transition: 0.3s;
    }
    #paymentModal button:hover { transform: scale(1.05); }

    /* CUBE & ANIMATIONS */
    .cube-header-wrapper { width: 50px; height: 50px; perspective: 800px; }
    .cube-header { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; animation: rotateCube 12s linear infinite; }
    .cube-face { position: absolute; width: 50px; height: 50px; background: rgba(59,130,246,0.2); border: 1px solid rgba(147,197,253,0.8); display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .face-front { transform: rotateY(0deg) translateZ(25px); } .face-back { transform: rotateY(180deg) translateZ(25px); }
    .face-right { transform: rotateY(90deg) translateZ(25px); } .face-left { transform: rotateY(-90deg) translateZ(25px); }
    .face-top { transform: rotateX(90deg) translateZ(25px); } .face-bottom { transform: rotateX(-90deg) translateZ(25px); }
    @keyframes rotateCube { 0% { transform: rotateX(22deg) rotateY(0deg); } 100% { transform: rotateX(22deg) rotateY(360deg); } }
    
    .slider-arrow { color: rgba(255,255,255,0.5); font-size: 2rem; cursor: pointer; padding: 0 20px; transition: 0.3s; }
    .slider-arrow:hover { color: #fff; transform: scale(1.1); }

    /* ================= PORTAL DO CLIENTE (ATUALIZADO) ================= */
    #plataforma_overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 4000;
      backdrop-filter: blur(10px);
    }

    #plataforma_admin_modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      z-index: 5000;
      align-items: center;
      justify-content: center;
    }

    .plataforma_container {
      display: none;
      position: fixed;
      inset: 0;
      background: var(--bg-dark);
      z-index: 4001;
      overflow-y: auto;
    }

    .plataforma_modal_box {
      background: #0f172a;
      border-radius: 20px;
      border: 1px solid var(--glass-border);
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
      position: relative;
      max-width: 500px;
      width: 90%;
      margin: 50px auto;
      padding: 40px;
    }

    .plataforma_header {
      height: 80px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 30px;
      background: rgba(2, 6, 23, 0.95);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .plataforma_header_brand {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .plataforma_header_brand strong {
      font-family: 'Roboto Condensed', sans-serif;
      font-size: 18px;
      color: #fff;
    }

    .plataforma_header_brand span {
      font-size: 10px;
      color: var(--primary);
      display: block;
    }

    .plataforma_card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 25px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
    }

    .plataforma_card_title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 15px;
      color: #fff;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .plataforma_status {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-left: auto;
    }

    .plataforma_status.pendente { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .plataforma_status.andamento { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
    .plataforma_status.concluido { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .plataforma_status.aguardando { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }

    .plataforma_timeline {
      position: relative;
      padding-left: 30px;
      margin: 20px 0;
    }

    .plataforma_timeline::before {
      content: '';
      position: absolute;
      left: 10px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: rgba(59, 130, 246, 0.3);
    }

    .plataforma_timeline_item {
      position: relative;
      margin-bottom: 25px;
    }

    .plataforma_timeline_item::before {
      content: '';
      position: absolute;
      left: -20px;
      top: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
    }

    .plataforma_timeline_date {
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 5px;
    }

    .plataforma_link_list {
      list-style: none;
      padding: 0;
    }

    .plataforma_link_item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      margin-bottom: 10px;
      transition: 0.3s;
      text-decoration: none;
      color: inherit;
    }

    .plataforma_link_item:hover {
      background: rgba(59, 130, 246, 0.1);
      transform: translateX(5px);
    }

    .plataforma_input_group {
      margin-bottom: 20px;
    }

    .plataforma_label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: rgba(255, 255, 255, 0.9);
    }

    .plataforma_input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: #fff;
      font-family: 'Poppins', sans-serif;
    }

    .plataforma_input:focus {
      outline: none;
      border-color: var(--primary);
    }

    .plataforma_textarea {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      color: #fff;
      font-family: 'Poppins', sans-serif;
      min-height: 120px;
      resize: vertical;
    }

    .plataforma_btn {
      padding: 12px 24px;
      border-radius: 10px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
      font-family: 'Poppins', sans-serif;
    }

    .plataforma_btn_primary {
      background: var(--primary);
      color: white;
    }

    .plataforma_btn_primary:hover {
      background: #2563eb;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.4);
    }

    .plataforma_btn_secondary {
      background: transparent;
      color: #fff;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .plataforma_btn_secondary:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .plataforma_btn_small {
      padding: 8px 16px;
      font-size: 0.85rem;
    }

    .plataforma_btn_danger {
      background: var(--danger);
      color: white;
    }

    .plataforma_btn_danger:hover {
      background: #dc2626;
    }

    .plataforma_btn_success {
      background: var(--success);
      color: white;
    }

    .plataforma_btn_success:hover {
      background: #059669;
    }

    .plataforma_btn_warning {
      background: var(--warning);
      color: white;
    }

    .plataforma_btn_warning:hover {
      background: #d97706;
    }

    .plataforma_admin_grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .plataforma_table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }

    .plataforma_table th,
    .plataforma_table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .plataforma_table th {
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      background: rgba(255, 255, 255, 0.03);
    }

    .plataforma_table tr:hover {
      background: rgba(255, 255, 255, 0.02);
    }

    .plataforma_badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .plataforma_badge.success { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .plataforma_badge.warning { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
    .plataforma_badge.danger { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .plataforma_badge.info { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }

    .plataforma_alert {
      padding: 15px 20px;
      border-radius: 10px;
      margin: 20px 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .plataforma_alert.info {
      background: rgba(59, 130, 246, 0.1);
      border-left: 4px solid var(--primary);
    }

    .plataforma_alert.warning {
      background: rgba(245, 158, 11, 0.1);
      border-left: 4px solid #f59e0b;
    }

    .plataforma_alert.danger {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid #ef4444;
    }

    .plataforma_alert.success {
      background: rgba(34, 197, 94, 0.1);
      border-left: 4px solid #10b981;
    }

    #plataforma_admin_access {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(59, 130, 246, 0.2);
      border: 1px solid rgba(59, 130, 246, 0.5);
      color: var(--primary);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 100;
      opacity: 0.3;
      transition: 0.3s;
    }

    #plataforma_admin_access:hover {
      opacity: 1;
      background: rgba(59, 130, 246, 0.3);
      transform: scale(1.1);
    }

    .alerta-whatsapp-btn {
      background: #25D366;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.85rem;
      transition: 0.3s;
    }

    .alerta-whatsapp-btn:hover {
      background: #128C7E;
      transform: scale(1.05);
    }

    .alerta-config-container {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .alerta-status {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .alerta-status.pendente { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .alerta-status.enviado { background: rgba(34, 197, 94, 0.2); color: #4ade80; }
    .alerta-status.agendado { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }

    .vencimento-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 10px;
      margin-bottom: 10px;
      border-left: 4px solid transparent;
    }

    .vencimento-item.vencido {
      border-left-color: var(--danger);
      background: rgba(239, 68, 68, 0.05);
    }

    .vencimento-item.proximo {
      border-left-color: var(--warning);
      background: rgba(245, 158, 11, 0.05);
    }

    .vencimento-item.ok {
      border-left-color: var(--success);
    }

    .lembrete-item {
      background: rgba(59, 130, 246, 0.05);
      border-left: 4px solid var(--primary);
      padding: 12px 15px;
      border-radius: 10px;
      margin-bottom: 10px;
    }

    .notificacoes-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background: var(--danger);
      color: white;
      font-size: 0.7rem;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }

    .notificacao-item {
      background: rgba(239, 68, 68, 0.1);
      border-left: 4px solid var(--danger);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notificacao-item .info { flex: 1; }
    .notificacao-item .acoes { display: flex; gap: 10px; }

    .cpf-input {
      font-family: monospace;
      letter-spacing: 1px;
    }

    /* MEDIA QUERIES */
    @media (max-width: 1000px) {
      header { padding: 15px 20px; height: auto; flex-direction: column; gap: 20px; }
      .header-nav { width: 100%; justify-content: center; padding-bottom: 5px; gap: 20px; }
      .header-spacer { display: none; }
      
      .glass-slider-container {
        flex-wrap: nowrap; justify-content: flex-start; overflow-x: auto;
        scroll-snap-type: x mandatory; padding: 20px 20px 60px 20px; width: 100%;
      }
      .glass-card { min-width: 85vw; margin-right: 15px; scroll-snap-align: center; }
      .slider-arrow { display: none; }
      main { padding-top: 160px; }
      
      .pricing-grid { grid-template-columns: 1fr; max-width: 400px; }

      .plataforma_modal_box { width: 95%; padding: 25px; margin: 20px auto; }
      .plataforma_header { padding: 0 20px; height: 70px; }
      .plataforma_admin_grid { grid-template-columns: 1fr; }
      .notificacao-item { flex-direction: column; gap: 10px; align-items: flex-start; }
      .notificacao-item .acoes { width: 100%; justify-content: flex-end; }
    }

    @keyframes plataforma_fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .plataforma_fade_in { animation: plataforma_fadeIn 0.5s ease-out; }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .pulse { animation: pulse 2s infinite; }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="cube-header-wrapper">
      <div class="cube-header">
        <div class="cube-face face-front"><i class="fas fa-chart-line"></i></div>
        <div class="cube-face face-back"><i class="fas fa-users"></i></div>
        <div class="cube-face face-right"><i class="fas fa-project-diagram"></i></div>
        <div class="cube-face face-left"><i class="fas fa-wallet"></i></div>
        <div class="cube-face face-top"><i class="fas fa-cube"></i></div>
        <div class="cube-face face-bottom"><i class="fas fa-database"></i></div>
      </div>
    </div>
    <div class="brand-text">
      <strong>Legacy Platform</strong>
      <span>ENTERPRISE <i class="fas fa-cloud"></i> CLOUD</span>
    </div>
  </div>

  <nav class="header-nav">
    <a href="#" class="nav-link active"><i class="fas fa-chart-pie"></i> Dashboard</a>
    <a href="#planos" class="nav-link"><i class="fas fa-layer-group"></i> Planos</a>
    <a href="#" class="nav-link"><i class="fas fa-book"></i> Base/KB</a>
    <a href="https://wa.me/5522992497662" target="_blank" class="nav-link"><i class="fas fa-headset"></i> Suporte</a>
    <a href="#cliente" class="nav-link" onclick="plataforma_showLoginModal()">
      <i class="fas fa-user-tie"></i> Clientes
    </a>
  </nav>
  
  <div class="header-spacer"></div>
</header>
<main>
  <div class="background-blobs">
    <div class="blob blob-1"></div>
    <div class="blob blob-2"></div>
  </div>
<div class="glass-slider-container">
    <div class="slider-arrow">
      <i class="fas fa-chevron-left"></i>
    </div>

    <div class="glass-card">
      <div class="card-img-wrapper">
        <i class="fas fa-users"></i>
      </div>
      <h3 class="card-title">Legacy Cloud CRM</h3>
      <p class="card-role">Enterprise Edition</p>
      <button class="btn-glass" onclick="abrirPopup('https://legacycrm.netlify.app/')">
        Acessar Sistema
      </button>
    </div>

    <div class="glass-card">
      <div class="card-img-wrapper">
        <i class="fas fa-file-signature"></i>
      </div>
      <h3 class="card-title">Legacy Contracts</h3>
      <p class="card-role">Gestão de Contratos</p>
      <button class="btn-glass" onclick="abrirPopup('https://legacycontratos.netlify.app')">
        Acessar Sistema
      </button>
    </div>

    <div class="glass-card">
      <div class="card-img-wrapper">
        <i class="fas fa-clipboard-check"></i>
      </div>
      <h3 class="card-title">Legacy Forms</h3>
      <p class="card-role">Gestão de Formulários</p>
      <button class="btn-glass" onclick="abrirPopup('https://legacyforms.netlify.app')">
        Acessar Sistema
      </button>
    </div>

    <div class="slider-arrow">
      <i class="fas fa-chevron-right"></i>
    </div>
  </div>

  <section id="planos">
    <h2>Seu negócio não pode viver preso no WhatsApp.<br>Nem desaparecer quando você troca de celular.</h2>
    <p>Com a Legacy você organiza clientes, conversas, financeiro, agenda e contratos em um sistema em nuvem seguro, para você nunca mais perder informações ou oportunidades.</p>
    
    <div class="pricing-grid">
      <div class="price-card">
        <h3 class="plan-title">SaaS Flex</h3>
        <p class="plan-desc">Para quem busca liberdade sem fidelidade longa.</p>
        <div class="price-box">
          <span class="price-value">R$ 60</span><span class="price-suffix">/mês</span>
        </div>
        <span class="billing-note">Cobrança recorrente mensal</span>
        <ul class="feature-list">
          <li><i class="fas fa-check-circle"></i> Acesso Multi-device Android e Pc</li>
          <li><i class="fas fa-rocket"></i> Implantação guiada</li>
          <li><i class="fas fa-clock"></i> 3 Tickets Suporte/mês</li>
          <li class="disabled"><i class="fas fa-ban"></i> Sem fidelidade</li>
        </ul>
        <button class="btn-select-plan" onclick="openPayment('SaaS Flex Mensal', 60)">Assinar Mensal</button>
      </div>

      <div class="price-card">
        <h3 class="plan-title">Starter</h3>
        <p class="plan-desc">O pacote inicial ideal para organizar a casa.</p>
        <div class="price-box">
          <span class="price-value">R$150</span><span class="price-suffix">Pgto único</span>
        </div>
        <span class="billing-note">Equivalente a R$50/mês</span>
        <ul class="feature-list">
          <li><i class="fas fa-check-circle"></i> Acesso Multi-device Android e Pc</li>
          <li><i class="fas fa-laptop-code"></i> Implantação Guiada</li>
          <li><i class="fas fa-ticket-alt"></i> 5 Tickets Suporte/mês</li>
        </ul>
        <button class="btn-select-plan" onclick="openPayment('Starter Trimestral', 150)">Assinar Trimestral</button>
      </div>

      <div class="price-card featured">
        <div class="badge-best">MAIS POPULAR</div>
        <h3 class="plan-title">Manager <i class="fas fa-crown" style="color: #facc15;"></i></h3>
        <p class="plan-desc">Gestão completa e suporte estendido.</p>
        <div class="price-box">
          <span class="price-value">R$600</span><span class="price-suffix">Pgto único</span>
        </div>
        <span class="billing-note">Equivalente a R$50/mês</span>
        <ul class="feature-list">
        <li><i class="fas fa-check-circle"></i> Acesso Multi-device Android e Pc</li>
          <li><i class="fas fa-laptop-code"></i> Implantação com o usuário</li>
          <li><i class="fas fa-ticket-alt"></i> 8 Tickets Suporte/mês</li>
        </ul>
        <button class="btn-select-plan" onclick="openPayment('Manager Anual', 600)">Assinar Anual</button>
      </div>

      <div class="price-card">
        <h3 class="plan-title">Controller</h3>
        <p class="plan-desc">Equilíbrio perfeito entre custo e prazo.</p>
        <div class="price-box">
          <span class="price-value">R$300</span><span class="price-suffix">Pgto único</span>
        </div>
        <span class="billing-note">Equivalente a R$50/mês</span>
        <ul class="feature-list">
          <li><i class="fas fa-check-circle"></i> Acesso Multi-device Android e Pc</li>
          <li><i class="fas fa-laptop-code"></i> Implantação Guiada</li>
          <li><i class="fas fa-ticket-alt"></i> 5 Tickets Suporte/mês</li>
        </ul>
        <button class="btn-select-plan" onclick="openPayment('Controller Semestral', 300)">Assinar Semestral</button>
      </div>
    </div>
  </section>
</main>

<div id="plataforma_admin_access" title="Acesso Administrativo">
  <i class="fas fa-cogs"></i>
</div>

<div id="plataforma_overlay"></div>

<div id="plataforma_client_portal" class="plataforma_container">
  <div class="plataforma_header">
    <div class="plataforma_header_brand">
      <div style="width: 40px; height: 40px; background: rgba(59, 130, 246, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
        <i class="fas fa-user-tie" style="color: var(--primary);"></i>
      </div>
      <div>
        <strong>Portal do Cliente</strong>
        <span>LEGACY PLATFORM</span>
      </div>
    </div>
    <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="plataforma_logout()">
      <i class="fas fa-sign-out-alt"></i> Sair
    </button>
  </div>

  <div style="max-width: 1200px; margin: 0 auto; padding: 30px;">
    <div class="plataforma_card plataforma_fade_in">
      <h2 class="plataforma_card_title" id="plataforma_client_name">
        <i class="fas fa-user-circle"></i> Carregando...
      </h2>
      <div style="display: flex; gap: 20px; flex-wrap: wrap; margin-top: 15px;">
        <div>
          <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.6);">Status</div>
          <div class="plataforma_badge success" id="plataforma_client_status">Ativo</div>
        </div>
        <div>
          <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.6);">Último acesso</div>
          <div id="plataforma_last_access">-</div>
        </div>
        <div>
          <div style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.6);">CPF</div>
          <div id="plataforma_client_cpf">•••••••••••</div>
        </div>
      </div>
    </div>

    <div class="plataforma_card plataforma_fade_in">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <h2 class="plataforma_card_title">
          <i class="fas fa-project-diagram"></i> Projeto Atual
        </h2>
        <span class="plataforma_status andamento" id="plataforma_project_status">Em andamento</span>
      </div>
      
      <h3 style="margin-bottom: 10px; color: #fff;" id="plataforma_project_title">Carregando projeto...</h3>
      <p style="color: rgba(255, 255, 255, 0.7); margin-bottom: 20px;" id="plataforma_project_desc"></p>
      
      <div style="margin-bottom: 25px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span style="font-size: 0.9rem; color: rgba(255, 255, 255, 0.7);">Progresso</span>
          <span style="font-size: 0.9rem; font-weight: 600;" id="plataforma_progress_text">0%</span>
        </div>
        <div style="height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
          <div id="plataforma_progress_bar" style="height: 100%; background: linear-gradient(90deg, var(--primary), #60a5fa); width: 0%; transition: width 0.5s ease;"></div>
        </div>
      </div>

      <h3 style="margin: 25px 0 15px; color: #fff; font-size: 1.1rem;">
        <i class="fas fa-history"></i> Linha do Tempo
      </h3>
      <div class="plataforma_timeline" id="plataforma_timeline">
        <div class="plataforma_timeline_item">
          <div class="plataforma_timeline_date">Carregando...</div>
          <div style="color: rgba(255, 255, 255, 0.9);">Aguardando dados</div>
        </div>
      </div>
    </div>

    <div class="plataforma_card plataforma_fade_in">
      <h2 class="plataforma_card_title">
        <i class="fas fa-link"></i> Links Importantes
      </h2>
      <ul class="plataforma_link_list" id="plataforma_links_list">
        <li>
          <a href="#" class="plataforma_link_item">
            <i class="fas fa-spinner fa-spin"></i>
            <span>Carregando links...</span>
          </a>
        </li>
      </ul>
    </div>

    <div class="plataforma_card plataforma_fade_in">
      <h2 class="plataforma_card_title">
        <i class="fas fa-graduation-cap"></i> Orientações
      </h2>
      <div id="plataforma_orientacoes">
        <div class="plataforma_alert info">
          <i class="fas fa-info-circle"></i>
          <div>Carregando orientações...</div>
        </div>
      </div>
    </div>

    <div class="plataforma_card plataforma_fade_in">
      <h2 class="plataforma_card_title">
        <i class="fas fa-calendar-alt"></i> Prazos e Datas
      </h2>
      <div id="plataforma_prazos">
        <div class="plataforma_alert warning">
          <i class="fas fa-clock"></i>
          <div>Carregando prazos...</div>
        </div>
      </div>
    </div>

    <div class="plataforma_card plataforma_fade_in">
      <h2 class="plataforma_card_title">
        <i class="fas fa-bell"></i> Lembretes
      </h2>
      <div id="plataforma_lembretes">
        <div class="plataforma_alert info">
          <i class="fas fa-info-circle"></i>
          <div>Carregando lembretes...</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="plataforma_admin_portal" class="plataforma_container">
  <div class="plataforma_header">
    <div class="plataforma_header_brand">
      <div style="width: 40px; height: 40px; background: rgba(239, 68, 68, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
        <i class="fas fa-user-shield" style="color: #ef4444;"></i>
      </div>
      <div>
        <strong>Área Administrativa</strong>
        <span>PORTAL DO CLIENTE</span>
      </div>
    </div>
    <div style="display: flex; gap: 10px;">
      <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="plataforma_admin_showDashboard()">
        <i class="fas fa-tachometer-alt"></i> Dashboard
      </button>
      <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="plataforma_admin_showSection('notificacoes')" id="plataforma_notificacoes_btn">
        <i class="fas fa-bell"></i> Notificações
        <span class="notificacoes-badge" id="plataforma_notificacoes_count" style="display: none;">0</span>
      </button>
      <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" onclick="plataforma_admin_logout()">
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>
    </div>
  </div>

  <div style="max-width: 1400px; margin: 0 auto; padding: 30px;">
    <div id="plataforma_admin_dashboard">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="font-size: 1.8rem; color: #fff;">Dashboard Administrativo</h1>
        <button class="plataforma_btn plataforma_btn_primary" onclick="plataforma_admin_showSection('clientes')">
          <i class="fas fa-plus"></i> Novo Cliente
        </button>
      </div>

      <div class="plataforma_admin_grid">
        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-users"></i> Clientes
          </h3>
          <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary); margin: 10px 0;" id="plataforma_admin_total_clientes">0</div>
          <div style="color: rgba(255, 255, 255, 0.6);">Clientes cadastrados</div>
        </div>

        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-project-diagram"></i> Projetos
          </h3>
          <div style="font-size: 2.5rem; font-weight: 800; color: #10b981; margin: 10px 0;" id="plataforma_admin_total_projetos">0</div>
          <div style="color: rgba(255, 255, 255, 0.6);">Projetos ativos</div>
        </div>

        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-bell"></i> Alertas Pendentes
          </h3>
          <div style="font-size: 2.5rem; font-weight: 800; color: #f59e0b; margin: 10px 0;" id="plataforma_admin_total_alertas">0</div>
          <div style="color: rgba(255, 255, 255, 0.6);">Notificações a enviar</div>
        </div>

        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-clock"></i> Vencimentos Hoje
          </h3>
          <div style="font-size: 2.5rem; font-weight: 800; color: #ef4444; margin: 10px 0;" id="plataforma_admin_total_vencimentos">0</div>
          <div style="color: rgba(255, 255, 255, 0.6);">Prazos a vencer</div>
        </div>
      </div>

      <div class="plataforma_card" style="margin-top: 30px;">
        <h3 class="plataforma_card_title">
          <i class="fas fa-list"></i> Lista de Clientes
        </h3>
        <div style="overflow-x: auto;">
          <table class="plataforma_table">
            <thead>
              <tr>
                <th>Nome</th>
                <th>CPF</th>
                <th>WhatsApp</th>
                <th>Status</th>
                <th>Projeto</th>
                <th>Ações</th>
              </tr>
            </thead>
            <tbody id="plataforma_admin_clientes_list">
              <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">
                  <i class="fas fa-spinner fa-spin"></i> Carregando clientes...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="plataforma_admin_clientes" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="font-size: 1.8rem; color: #fff;">
          <i class="fas fa-user-plus"></i> Gestão de Clientes
        </h1>
        <button class="plataforma_btn plataforma_btn_secondary" onclick="plataforma_admin_showDashboard()">
          <i class="fas fa-arrow-left"></i> Voltar
        </button>
      </div>

      <div class="plataforma_admin_grid">
        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-plus-circle"></i> Novo Cliente
          </h3>
          <div class="plataforma_input_group">
            <label class="plataforma_label">Nome Completo *</label>
            <input type="text" class="plataforma_input" id="plataforma_novo_nome" placeholder="Nome do cliente">
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Email *</label>
            <input type="email" class="plataforma_input" id="plataforma_novo_email" placeholder="email@cliente.com">
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">CPF (Será a senha) *</label>
            <input type="text" class="plataforma_input cpf-input" id="plataforma_novo_cpf" placeholder="000.000.000-00" maxlength="14">
            <small style="color: rgba(255,255,255,0.5); font-size: 0.8rem; display: block; margin-top: 5px;">
              O CPF será usado como senha de acesso do cliente
            </small>
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Telefone WhatsApp *</label>
            <input type="text" class="plataforma_input" id="plataforma_novo_whatsapp" placeholder="(00) 00000-0000">
          </div>

          <div class="plataforma_input_group">
            <label class="plataforma_label">Status</label>
            <select class="plataforma_input" id="plataforma_novo_status">
              <option value="ativo">Ativo</option>
              <option value="inativo">Inativo</option>
              <option value="pendente">Pendente</option>
            </select>
          </div>

          <button class="plataforma_btn plataforma_btn_primary" style="width: 100%;" onclick="plataforma_admin_salvarCliente()">
            <i class="fas fa-save"></i> Salvar Cliente
          </button>
        </div>

        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-project-diagram"></i> Projeto do Cliente
          </h3>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Cliente</label>
            <select class="plataforma_input" id="plataforma_projeto_cliente" onchange="plataforma_admin_carregarProjetoCliente()">
              <option value="">Selecione um cliente</option>
            </select>
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Título do Projeto *</label>
            <input type="text" class="plataforma_input" id="plataforma_projeto_titulo" placeholder="Nome do projeto">
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Descrição</label>
            <textarea class="plataforma_textarea" id="plataforma_projeto_desc" placeholder="Descreva o projeto..."></textarea>
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Status do Projeto</label>
            <select class="plataforma_input" id="plataforma_projeto_status">
              <option value="pendente">Pendente</option>
              <option value="andamento">Em andamento</option>
              <option value="concluido">Concluído</option>
              <option value="aguardando">Aguardando</option>
            </select>
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Progresso (%)</label>
            <input type="range" class="plataforma_input" id="plataforma_projeto_progresso" min="0" max="100" step="5" value="0">
            <div style="text-align: center; margin-top: 5px;">
              <span id="plataforma_projeto_progresso_text">0%</span>
            </div>
          </div>

          <button class="plataforma_btn plataforma_btn_primary" style="width: 100%;" onclick="plataforma_admin_salvarProjeto()">
            <i class="fas fa-save"></i> Salvar Projeto
          </button>
        </div>

        <div class="plataforma_card">
          <h3 class="plataforma_card_title">
            <i class="fas fa-cog"></i> Conteúdo do Portal
          </h3>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Cliente</label>
            <select class="plataforma_input" id="plataforma_conteudo_cliente" onchange="plataforma_admin_carregarConteudoCliente()">
              <option value="">Selecione um cliente</option>
            </select>
          </div>

          <div class="plataforma_input_group">
            <label class="plataforma_label">Adicionar Link</label>
            <input type="text" class="plataforma_input" id="plataforma_novo_link_nome" placeholder="Nome do link">
            <input type="text" class="plataforma_input" style="margin-top: 8px;" id="plataforma_novo_link_url" placeholder="https://exemplo.com">
            <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" style="width: 100%; margin-top: 10px;" onclick="plataforma_admin_adicionarLink()">
              <i class="fas fa-plus"></i> Adicionar Link
            </button>
          </div>

          <div class="plataforma_input_group">
            <label class="plataforma_label">Adicionar Orientação</label>
            <textarea class="plataforma_textarea" id="plataforma_nova_orientacao" placeholder="Digite uma orientação..."></textarea>
            <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" style="width: 100%; margin-top: 10px;" onclick="plataforma_admin_adicionarOrientacao()">
              <i class="fas fa-plus"></i> Adicionar
            </button>
          </div>

          <div class="plataforma_input_group">
            <label class="plataforma_label">Adicionar Prazo</label>
            <input type="text" class="plataforma_input" id="plataforma_novo_prazo_titulo" placeholder="Título do prazo">
            <input type="date" class="plataforma_input" style="margin-top: 8px;" id="plataforma_novo_prazo_data">
            <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" style="width: 100%; margin-top: 10px;" onclick="plataforma_admin_adicionarPrazo()">
              <i class="fas fa-plus"></i> Adicionar Prazo
            </button>
          </div>

          <div class="plataforma_input_group">
            <label class="plataforma_label">Adicionar Lembrete</label>
            <textarea class="plataforma_textarea" id="plataforma_novo_lembrete" placeholder="Digite um lembrete..."></textarea>
            <button class="plataforma_btn plataforma_btn_secondary plataforma_btn_small" style="width: 100%; margin-top: 10px;" onclick="plataforma_admin_adicionarLembrete()">
              <i class="fas fa-plus"></i> Adicionar Lembrete
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="plataforma_admin_notificacoes" style="display: none;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="font-size: 1.8rem; color: #fff;">
          <i class="fas fa-bell"></i> Notificações de Vencimentos
        </h1>
        <button class="plataforma_btn plataforma_btn_secondary" onclick="plataforma_admin_showDashboard()">
          <i class="fas fa-arrow-left"></i> Voltar
        </button>
      </div>

      <div class="plataforma_card">
        <h3 class="plataforma_card_title">
          <i class="fas fa-exclamation-triangle"></i> Alertas Pendentes
        </h3>
        <div id="plataforma_admin_alertas_lista">
          <div style="text-align: center; padding: 40px; color: rgba(255, 255, 255, 0.5);">
            <i class="fas fa-spinner fa-spin"></i> Carregando alertas...
          </div>
        </div>
      </div>

      <div class="plataforma_card" style="margin-top: 30px;">
        <h3 class="plataforma_card_title">
          <i class="fas fa-sliders-h"></i> Configuração de Alertas
        </h3>
        
        <div class="alerta-config-container">
          <div class="plataforma_input_group">
            <label class="plataforma_label">Dias para alerta antecipado</label>
            <input type="number" class="plataforma_input" id="plataforma_alerta_dias" min="1" max="30" value="3">
            <small style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">
              Número de dias antes do vencimento para enviar alerta
            </small>
          </div>
          
          <div class="plataforma_input_group">
            <label class="plataforma_label">Mensagem padrão de alerta</label>
            <textarea class="plataforma_textarea" id="plataforma_alerta_mensagem" placeholder="Digite a mensagem padrão para alertas..." rows="4">
Olá {nome}! Este é um lembrete sobre o prazo: {titulo}
Vencimento: {data}
Acesse seu portal para mais detalhes: {link_portal}
            </textarea>
            <small style="color: rgba(255,255,255,0.5); font-size: 0.8rem;">
              Variáveis disponíveis: {nome}, {titulo}, {data}, {link_portal}
            </small>
          </div>
          
          <button class="plataforma_btn plataforma_btn_primary" onclick="plataforma_admin_salvarConfigAlertas()">
            <i class="fas fa-save"></i> Salvar Configurações
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="plataforma_login_modal" class="plataforma_container">
  <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;">
    <div class="plataforma_modal_box plataforma_fade_in">
      <div style="text-align: center; margin-bottom: 30px;">
        <div style="width: 80px; height: 80px; background: rgba(59, 130, 246, 0.2); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
          <i class="fas fa-user-tie" style="font-size: 2rem; color: var(--primary);"></i>
        </div>
        <h2 style="color: #fff; margin-bottom: 10px;">Portal do Cliente</h2>
        <p style="color: rgba(255, 255, 255, 0.7);">Acesse com seu CPF cadastrado</p>
      </div>

      <div class="plataforma_input_group">
        <label class="plataforma_label">CPF (Somente números)</label>
        <input type="text" class="plataforma_input cpf-input" id="plataforma_input_cpf" placeholder="000.000.000-00" maxlength="14">
        <small style="color: rgba(255,255,255,0.5); font-size: 0.8rem; display: block; margin-top: 5px;">
          Digite seu CPF no formato: 000.000.000-00
        </small>
      </div>

      <div style="display: flex; gap: 10px; margin-top: 25px;">
        <button class="plataforma_btn plataforma_btn_secondary" style="flex: 1;" onclick="plataforma_fecharLoginModal()">
          <i class="fas fa-arrow-left"></i> Voltar
        </button>
        <button class="plataforma_btn plataforma_btn_primary" style="flex: 2;" onclick="plataforma_login()">
          <i class="fas fa-sign-in-alt"></i> Entrar
        </button>
      </div>

      <div style="text-align: center; margin-top: 20px; color: rgba(255, 255, 255, 0.5); font-size: 0.85rem;">
        <i class="fas fa-info-circle"></i> Acesso exclusivo para clientes Legacy Platform
      </div>
    </div>
  </div>
</div>

<div id="plataforma_admin_modal">
  <div class="plataforma_modal_box plataforma_fade_in">
    <div style="text-align: center; margin-bottom: 30px;">
      <div style="width: 80px; height: 80px; background: rgba(239, 68, 68, 0.2); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto 20px;">
        <i class="fas fa-user-shield" style="font-size: 2rem; color: #ef4444;"></i>
      </div>
      <h2 style="color: #fff; margin-bottom: 10px;">Acesso Administrativo</h2>
      <p style="color: rgba(255, 255, 255, 0.7);">Área restrita para administradores</p>
    </div>

    <div class="plataforma_input_group">
      <label class="plataforma_label">Senha de Administrador</label>
      <input type="password" class="plataforma_input" id="plataforma_admin_senha" placeholder="Digite a senha administrativa">
    </div>

    <button class="plataforma_btn plataforma_btn_primary" style="width: 100%; background: #ef4444;" onclick="plataforma_admin_login()">
      <i class="fas fa-lock"></i> Acessar
    </button>

    <div style="text-align: center; margin-top: 20px;">
      <button class="plataforma_btn plataforma_btn_secondary" onclick="plataforma_admin_fecharModal()">
        <i class="fas fa-times"></i> Cancelar
      </button>
    </div>
  </div>
</div>

<div id="paymentModal">
  <div class="modal-box">
    <div style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;">
      <i class="fas fa-shopping-cart"></i>
    </div>
    <h3>Confirmar Assinatura</h3>
    <p style="margin: 10px 0; color: rgba(255,255,255,0.7);">Você selecionou o plano:</p>
    <h2 id="modalPlanName" style="color: #fff; margin-bottom: 5px;"></h2>
    <strong id="modalPrice" style="font-size: 1.5rem; color: var(--success); display: block; margin-bottom: 20px;"></strong>
    <p style="font-size: 0.8rem; margin-bottom: 20px;">Você será redirecionado para finalizar a contratação via WhatsApp.</p>
    <div style="display: flex; gap: 10px; justify-content: center;">
      <button onclick="closePayment()" style="background: transparent; border: 1px solid rgba(255,255,255,0.3);">Cancelar</button>
      <button onclick="confirmarAssinatura()">Confirmar</button>
    </div>
  </div>
</div>
<script>
  // ==================== LÓGICA DE INTERFACE (MODAL PAGAMENTO) ====================
  let planoSelecionado = "";
  let valorSelecionado = "";

  function abrirPopup(url) {
    const width = window.innerWidth * 0.9;
    const height = window.innerHeight * 0.9;
    const left = (window.innerWidth - width) / 2;
    const top = (window.innerHeight - height) / 2;
    const features = `width=${width},height=${height},top=${top},left=${left},resizable=yes,scrollbars=yes`;
    window.open(url, 'LegacySystemPopup', features);
  }

  const modal = document.getElementById('paymentModal');
  const modalName = document.getElementById('modalPlanName');
  const modalPrice = document.getElementById('modalPrice');

  function openPayment(name, price) {
    planoSelecionado = name;
    valorSelecionado = price;
    modalName.innerText = name;
    modalPrice.innerText = 'Total: R$ ' + price + ',00';
    modal.style.display = 'flex';
  }

  function closePayment() {
    modal.style.display = 'none';
  }

  function confirmarAssinatura() {
    const telefone = "5522992497662";
    const mensagem = encodeURIComponent(`Olá! Gostaria de assinar o plano ${planoSelecionado} no valor de R$ ${valorSelecionado},00.`);
    window.open(`https://wa.me/${telefone}?text=${mensagem}`, '_blank');
    closePayment();
  }

  window.onclick = function(event) {
    if (event.target == modal) closePayment();
  }

  // ==================== LÓGICA DO BANCO DE DADOS (CORRIGIDA) ====================
  // Centraliza as operações no banco 'lg_crmDB' usando sufixo '_plataforma'
  
  const plataforma = {
    db: null,
    dbName: 'lg_crmDB', // Banco principal compartilhado
    dbVersion: 9,       // Versão para garantir atualização da estrutura
    adminPassword: 'admin@legacy2024',
    currentUser: null,
    isAdmin: false,
    configAlertas: {
      diasAntecedencia: 3,
      mensagemPadrao: `Olá {nome}! Este é um lembrete sobre o prazo: {titulo}\nVencimento: {data}\nAcesse seu portal para mais detalhes: {link_portal}`
    }
  };

  // Máscara para CPF
  function formatarCPF(cpf) {
    cpf = cpf.replace(/\D/g, '');
    cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
    cpf = cpf.replace(/(\d{3})(\d)/, '$1.$2');
    cpf = cpf.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    return cpf;
  }

  // Inicialização dos inputs
  document.addEventListener('DOMContentLoaded', function() {
    const cpfInputs = document.querySelectorAll('.cpf-input');
    cpfInputs.forEach(input => {
      input.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length > 11) value = value.substring(0, 11);
        e.target.value = formatarCPF(value);
      });
    });
  });

  // Inicialização do IndexedDB
  function plataforma_initDB() {
    return new Promise((resolve, reject) => {
      // Abre o banco compartilhado lg_crmDB
      const request = indexedDB.open(plataforma.dbName, plataforma.dbVersion);
      
      request.onerror = (event) => {
        console.error('Erro ao abrir o banco de dados:', event.target.error);
        reject(event.target.error);
      };
      
      request.onsuccess = (event) => {
        plataforma.db = event.target.result;
        console.log(`Banco de dados ${plataforma.dbName} conectado.`);
        
        // Carregar configurações iniciais
        plataforma_carregarConfigAlertas();
        
        resolve(plataforma.db);
      };
      
      // Criação das tabelas com sufixo _plataforma
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        
        // Cria tabelas apenas se não existirem (Safe Check)
        const createStore = (name, keyPath, indexes = []) => {
          if (!db.objectStoreNames.contains(name)) {
            const store = db.createObjectStore(name, { keyPath: keyPath, autoIncrement: true });
            indexes.forEach(idx => store.createIndex(idx.name, idx.key, { unique: idx.unique || false }));
            console.log(`Tabela criada: ${name}`);
          }
        };

        createStore('clientes_plataforma', 'id', [{name: 'cpf', key: 'cpf', unique: true}, {name: 'status', key: 'status'}]);
        createStore('projetos_plataforma', 'id', [{name: 'clienteId', key: 'clienteId'}, {name: 'status', key: 'status'}]);
        createStore('etapas_plataforma', 'id', [{name: 'projetoId', key: 'projetoId'}, {name: 'data', key: 'data'}]);
        createStore('links_plataforma', 'id', [{name: 'clienteId', key: 'clienteId'}]);
        createStore('orientacoes_plataforma', 'id', [{name: 'clienteId', key: 'clienteId'}]);
        createStore('prazos_plataforma', 'id', [{name: 'clienteId', key: 'clienteId'}, {name: 'data', key: 'data'}, {name: 'statusAlerta', key: 'statusAlerta'}]);
        createStore('lembretes_plataforma', 'id', [{name: 'clienteId', key: 'clienteId'}]);
        createStore('alertas_plataforma', 'id', [{name: 'clienteId', key: 'clienteId'}, {name: 'prazoId', key: 'prazoId'}, {name: 'status', key: 'status'}]);
        createStore('config_plataforma', 'id', [{name: 'chave', key: 'chave', unique: true}]);
        createStore('usuarios_plataforma', 'id', [{name: 'tipo', key: 'tipo'}]);
        
        // Dados de demonstração/inicialização
        const transaction = event.target.transaction;
        
        // Config Padrão
        const configStore = transaction.objectStore('config_plataforma');
        configStore.add({ chave: 'alertas_config', valor: JSON.stringify(plataforma.configAlertas) });

        // Cliente Demo (opcional, para teste)
        const clientesStore = transaction.objectStore('clientes_plataforma');
        clientesStore.add({
            nome: 'Cliente Demonstração',
            email: 'demo@legacyplatform.com',
            cpf: '12345678900',
            whatsapp: '5522999999999',
            status: 'ativo',
            dataCadastro: new Date().toISOString()
        });
      };
    });
  }

  // --- Funções Auxiliares de Banco de Dados ---

  async function plataforma_carregarConfigAlertas() {
    if(!plataforma.db) return;
    try {
      const transaction = plataforma.db.transaction(['config_plataforma'], 'readonly');
      const store = transaction.objectStore('config_plataforma');
      const index = store.index('chave');
      const request = index.get('alertas_config');
      
      request.onsuccess = (event) => {
        const config = event.target.result;
        if (config && config.valor) {
          plataforma.configAlertas = JSON.parse(config.valor);
          const diasInput = document.getElementById('plataforma_alerta_dias');
          const mensagemInput = document.getElementById('plataforma_alerta_mensagem');
          if (diasInput) diasInput.value = plataforma.configAlertas.diasAntecedencia;
          if (mensagemInput) mensagemInput.value = plataforma.configAlertas.mensagemPadrao;
        }
      };
    } catch (e) { console.log('Config ainda não carregada'); }
  }

  async function plataforma_admin_salvarConfigAlertas() {
    const dias = parseInt(document.getElementById('plataforma_alerta_dias').value);
    const mensagem = document.getElementById('plataforma_alerta_mensagem').value.trim();
    
    plataforma.configAlertas.diasAntecedencia = dias;
    plataforma.configAlertas.mensagemPadrao = mensagem;
    
    const transaction = plataforma.db.transaction(['config_plataforma'], 'readwrite');
    const store = transaction.objectStore('config_plataforma');
    const index = store.index('chave');
    
    index.get('alertas_config').onsuccess = (e) => {
      const data = e.target.result || { chave: 'alertas_config' };
      data.valor = JSON.stringify(plataforma.configAlertas);
      store.put(data);
      alert('Configurações salvas!');
    };
  }

  // --- Autenticação ---

  async function plataforma_login() {
    let cpf = document.getElementById('plataforma_input_cpf').value.replace(/\D/g, '');
    
    if (cpf.length !== 11) { alert('CPF inválido'); return; }
    
    const transaction = plataforma.db.transaction(['clientes_plataforma'], 'readwrite');
    const store = transaction.objectStore('clientes_plataforma');
    const index = store.index('cpf');
    
    index.get(cpf).onsuccess = (e) => {
      const cliente = e.target.result;
      if (cliente && cliente.status === 'ativo') {
        plataforma.currentUser = cliente;
        cliente.ultimoAcesso = new Date().toISOString();
        store.put(cliente); // Atualiza último acesso
        plataforma_showClientPortal();
      } else {
        alert('Cliente não encontrado ou inativo.');
      }
    };
  }

  function plataforma_logout() {
    plataforma.currentUser = null;
    plataforma.isAdmin = false;
    plataforma_showLoginModal();
  }

  function plataforma_showLoginModal() {
    document.getElementById('plataforma_overlay').style.display = 'block';
    document.getElementById('plataforma_login_modal').style.display = 'block';
    document.getElementById('plataforma_client_portal').style.display = 'none';
    document.getElementById('plataforma_admin_portal').style.display = 'none';
    document.getElementById('plataforma_input_cpf').value = '';
  }

  function plataforma_fecharLoginModal() {
    document.getElementById('plataforma_overlay').style.display = 'none';
    document.getElementById('plataforma_login_modal').style.display = 'none';
  }

  // --- Portal do Cliente ---

  function plataforma_showClientPortal() {
    document.getElementById('plataforma_overlay').style.display = 'block';
    document.getElementById('plataforma_client_portal').style.display = 'block';
    document.getElementById('plataforma_login_modal').style.display = 'none';
    plataforma_carregarDadosCliente();
  }

  function plataforma_carregarDadosCliente() {
    const user = plataforma.currentUser;
    if(!user) return;

    document.getElementById('plataforma_client_name').innerHTML = `<i class="fas fa-user-circle"></i> ${user.nome}`;
    document.getElementById('plataforma_client_cpf').textContent = formatarCPF(user.cpf);
    document.getElementById('plataforma_last_access').textContent = new Date().toLocaleDateString('pt-BR');

    // Carregar Projeto
    const tx = plataforma.db.transaction(['projetos_plataforma', 'etapas_plataforma', 'links_plataforma', 'orientacoes_plataforma', 'prazos_plataforma', 'lembretes_plataforma'], 'readonly');
    
    // Projeto
    const projStore = tx.objectStore('projetos_plataforma').index('clienteId');
    projStore.get(user.id).onsuccess = (e) => {
        const proj = e.target.result;
        if(proj) {
            document.getElementById('plataforma_project_title').textContent = proj.titulo;
            document.getElementById('plataforma_project_desc').textContent = proj.descricao;
            document.getElementById('plataforma_project_status').className = `plataforma_status ${proj.status}`;
            document.getElementById('plataforma_project_status').textContent = proj.status;
            document.getElementById('plataforma_progress_bar').style.width = `${proj.progresso}%`;
            document.getElementById('plataforma_progress_text').textContent = `${proj.progresso}%`;
            
            // Etapas
            const etapasStore = tx.objectStore('etapas_plataforma').index('projetoId');
            etapasStore.getAll(proj.id).onsuccess = (ev) => {
                const timeline = document.getElementById('plataforma_timeline');
                timeline.innerHTML = '';
                const etapas = ev.target.result || [];
                etapas.sort((a,b) => new Date(a.data) - new Date(b.data)).forEach(etapa => {
                    timeline.innerHTML += `
                        <div class="plataforma_timeline_item">
                          <div class="plataforma_timeline_date">${new Date(etapa.data).toLocaleDateString()}</div>
                          <div style="color: rgba(255, 255, 255, 0.9);">${etapa.titulo}</div>
                          <div style="color: rgba(255, 255, 255, 0.6); font-size: 0.9rem;">${etapa.descricao}</div>
                        </div>`;
                });
            };
        } else {
            document.getElementById('plataforma_project_title').textContent = "Nenhum projeto ativo";
        }
    };

    // Links
    tx.objectStore('links_plataforma').index('clienteId').getAll(user.id).onsuccess = (e) => {
        const list = document.getElementById('plataforma_links_list');
        list.innerHTML = e.target.result.map(l => `<li><a href="${l.url}" target="_blank" class="plataforma_link_item"><i class="fas fa-link"></i> ${l.nome}</a></li>`).join('') || '<li>Sem links</li>';
    };

    // Prazos
    tx.objectStore('prazos_plataforma').index('clienteId').getAll(user.id).onsuccess = (e) => {
        const container = document.getElementById('plataforma_prazos');
        container.innerHTML = '';
        e.target.result.forEach(p => {
            const diff = Math.ceil((new Date(p.data) - new Date()) / (1000*60*60*24));
            const cls = diff < 0 ? 'vencido' : (diff < 3 ? 'proximo' : 'ok');
            container.innerHTML += `<div class="vencimento-item ${cls}"><div><strong>${p.titulo}</strong><br><small>${new Date(p.data).toLocaleDateString()}</small></div></div>`;
        });
    };
  }

  // --- Área Administrativa ---

  document.getElementById('plataforma_admin_access').addEventListener('click', () => {
    document.getElementById('plataforma_admin_modal').style.display = 'flex';
  });

  function plataforma_admin_fecharModal() {
    document.getElementById('plataforma_admin_modal').style.display = 'none';
  }

  function plataforma_admin_login() {
    const senha = document.getElementById('plataforma_admin_senha').value;
    if (senha === plataforma.adminPassword) {
      plataforma.isAdmin = true;
      plataforma_admin_fecharModal();
      plataforma_showAdminPortal();
    } else {
      alert('Senha incorreta');
    }
  }

  function plataforma_showAdminPortal() {
    document.getElementById('plataforma_overlay').style.display = 'block';
    document.getElementById('plataforma_admin_portal').style.display = 'block';
    plataforma_admin_carregarDashboard();
    plataforma_admin_carregarClientesSelect();
  }

  function plataforma_admin_logout() {
    plataforma.isAdmin = false;
    document.getElementById('plataforma_overlay').style.display = 'none';
    document.getElementById('plataforma_admin_portal').style.display = 'none';
  }

  function plataforma_admin_showSection(section) {
    ['dashboard', 'clientes', 'notificacoes'].forEach(s => {
        const el = document.getElementById(`plataforma_admin_${s}`);
        if(el) el.style.display = 'none';
    });
    
    if (section === 'clientes') document.getElementById('plataforma_admin_clientes').style.display = 'block';
    else if (section === 'notificacoes') {
        document.getElementById('plataforma_admin_notificacoes').style.display = 'block';
        plataforma_admin_carregarAlertas();
    }
    else document.getElementById('plataforma_admin_dashboard').style.display = 'block';
  }

  function plataforma_admin_showDashboard() {
    plataforma_admin_showSection('dashboard');
    plataforma_admin_carregarDashboard();
  }

  async function plataforma_admin_carregarDashboard() {
    const tx = plataforma.db.transaction(['clientes_plataforma', 'projetos_plataforma', 'prazos_plataforma'], 'readonly');
    
    tx.objectStore('clientes_plataforma').count().onsuccess = (e) => 
        document.getElementById('plataforma_admin_total_clientes').textContent = e.target.result;
    
    tx.objectStore('projetos_plataforma').count().onsuccess = (e) => 
        document.getElementById('plataforma_admin_total_projetos').textContent = e.target.result;
        
    plataforma_admin_carregarListaClientes();
  }

  function plataforma_admin_carregarListaClientes() {
    const tx = plataforma.db.transaction(['clientes_plataforma', 'projetos_plataforma'], 'readonly');
    const tbody = document.getElementById('plataforma_admin_clientes_list');
    tbody.innerHTML = '';
    
    tx.objectStore('clientes_plataforma').openCursor().onsuccess = (e) => {
      const cursor = e.target.result;
      if (cursor) {
        const c = cursor.value;
        tbody.innerHTML += `
            <tr>
                <td><strong>${c.nome}</strong><br><small>${c.email}</small></td>
                <td>${formatarCPF(c.cpf)}</td>
                <td>${c.whatsapp}</td>
                <td>${c.status}</td>
                <td>-</td>
                <td><button class="plataforma_btn_small" onclick="alert('Funcionalidade em desenvolvimento')"><i class="fas fa-edit"></i></button></td>
            </tr>`;
        cursor.continue();
      }
    };
  }

  function plataforma_admin_carregarClientesSelect() {
    const select1 = document.getElementById('plataforma_projeto_cliente');
    const select2 = document.getElementById('plataforma_conteudo_cliente');
    if(!select1) return;
    
    select1.innerHTML = '<option value="">Selecione...</option>';
    select2.innerHTML = '<option value="">Selecione...</option>';
    
    const store = plataforma.db.transaction(['clientes_plataforma'], 'readonly').objectStore('clientes_plataforma');
    store.openCursor().onsuccess = (e) => {
        const cursor = e.target.result;
        if(cursor) {
            const opt = `<option value="${cursor.value.id}">${cursor.value.nome}</option>`;
            select1.innerHTML += opt;
            select2.innerHTML += opt;
            cursor.continue();
        }
    };
  }

  function plataforma_admin_salvarCliente() {
    const nome = document.getElementById('plataforma_novo_nome').value;
    const cpf = document.getElementById('plataforma_novo_cpf').value.replace(/\D/g, '');
    const email = document.getElementById('plataforma_novo_email').value;
    const whatsapp = document.getElementById('plataforma_novo_whatsapp').value;
    const status = document.getElementById('plataforma_novo_status').value;

    if(!nome || cpf.length !== 11) { alert('Dados inválidos'); return; }

    const store = plataforma.db.transaction(['clientes_plataforma'], 'readwrite').objectStore('clientes_plataforma');
    store.add({ nome, cpf, email, whatsapp, status, dataCadastro: new Date().toISOString() }).onsuccess = () => {
        alert('Cliente salvo!');
        plataforma_admin_showDashboard();
    };
  }

  // --- Funções de Projeto e Conteúdo ---
  // (Mantêm a mesma lógica, apenas garantindo o uso de store '_plataforma')

  function plataforma_admin_salvarProjeto() {
    const clienteId = parseInt(document.getElementById('plataforma_projeto_cliente').value);
    const titulo = document.getElementById('plataforma_projeto_titulo').value;
    const status = document.getElementById('plataforma_projeto_status').value;
    const progresso = document.getElementById('plataforma_projeto_progresso').value;
    
    if(!clienteId) return alert('Selecione um cliente');

    const tx = plataforma.db.transaction(['projetos_plataforma', 'etapas_plataforma'], 'readwrite');
    const store = tx.objectStore('projetos_plataforma');
    
    // Verifica se já existe projeto para atualizar
    const index = store.index('clienteId');
    index.get(clienteId).onsuccess = (e) => {
        const proj = e.target.result || { clienteId, dataCriacao: new Date().toISOString() };
        proj.titulo = titulo;
        proj.status = status;
        proj.progresso = progresso;
        proj.descricao = document.getElementById('plataforma_projeto_desc').value;
        
        store.put(proj).onsuccess = (ev) => {
            // Adiciona etapa automática de atualização
            tx.objectStore('etapas_plataforma').add({
                projetoId: proj.id || ev.target.result,
                titulo: `Status: ${status}`,
                descricao: `Progresso atualizado para ${progresso}%`,
                data: new Date().toISOString()
            });
            alert('Projeto salvo!');
        };
    };
  }

  function plataforma_admin_adicionarLink() {
      const clienteId = parseInt(document.getElementById('plataforma_conteudo_cliente').value);
      const nome = document.getElementById('plataforma_novo_link_nome').value;
      const url = document.getElementById('plataforma_novo_link_url').value;
      if(!clienteId || !url) return;
      
      plataforma.db.transaction(['links_plataforma'], 'readwrite')
        .objectStore('links_plataforma')
        .add({ clienteId, nome, url })
        .onsuccess = () => alert('Link adicionado');
  }

  // Inicialização Geral
  window.addEventListener('DOMContentLoaded', async () => {
    try {
      await plataforma_initDB();
      // Slider listener
      const slider = document.getElementById('plataforma_projeto_progresso');
      if(slider) slider.addEventListener('input', (e) => document.getElementById('plataforma_projeto_progresso_text').textContent = e.target.value + '%');
    } catch (e) { console.error(e); }
  });

</script>

<script>
  const SUPABASE_URL = 'https://rjyxkouegrropsarrhje.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqeXhrb3VlZ3Jyb3BzYXJyaGplIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk1NjYxNjcsImV4cCI6MjA4NTE0MjE2N30.UjNPnVBVhQcUSirXeWZ3RmYmAhDMqqbbVUChG_Mv57U';

  window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // Sistema Admin Supabase
  const supabase_admin = {
    init: function() {
        // Verifica botão existente e injeta modal se necessário
        const btn = document.getElementById('plataforma_admin_access');
        if(btn) {
            btn.onclick = (e) => {
                // Se já estiver logado admin local, abre portal
                if(plataforma.isAdmin) return;
                // Senão, abre modal local (simplificado para manter funcionalidade pedida)
                document.getElementById('plataforma_admin_modal').style.display = 'flex';
            }
        }
    }
  };
  document.addEventListener('DOMContentLoaded', supabase_admin.init);
</script>

<script>
/**
 * 🚀 UNIVERSAL IDB SYNC - ADAPTADO PARA LG_CRMDB
 * Sincroniza tabelas com sufixo _plataforma automaticamente
 */
(function () {
    const SYNC_TABLE = 'lg_crm_supadb';
    const CANONICAL_DB = 'lg_crmDB'; // Força o uso do banco correto
    
    let storedId = sessionStorage.getItem('sync_device_id');
    if (!storedId) {
        storedId = crypto.randomUUID();
        sessionStorage.setItem('sync_device_id', storedId);
    }
    const DEVICE_ID = storedId;
    let isReplicating = false; 
    const syncCache = new Map();

    const getClient = () => window.supabase;
    const waitForSupabase = () => new Promise(resolve => {
        const check = () => getClient() ? resolve(getClient()) : setTimeout(check, 100);
        check();
    });

    // Funções de Sync
    async function scheduleRealtimeUpload(storeName, method, key, value) {
        if (isReplicating) return; 
        const client = getClient();
        // Upload genérico sem user_id estrito para demonstração, 
        // ou pegue da sessão se houver auth implementado.
        const userId = 'admin_system_user'; 

        const cacheKey = `${storeName}-${key}`;
        if (method === 'delete') syncCache.delete(cacheKey);
        else syncCache.set(cacheKey, JSON.stringify(value));

        client.from(SYNC_TABLE).upsert({
            user_id: userId,
            db_name: CANONICAL_DB,
            store_name: storeName,
            record_key: String(key),
            record_value: method === 'delete' ? null : value,
            is_deleted: method === 'delete',
            device_id: DEVICE_ID,
            updated_at: new Date().toISOString()
        }, { onConflict: 'user_id,db_name,store_name,record_key' }).then(({ error }) => {
            if (error) console.warn(`Sync Warn:`, error.message);
        });
    }

    // Intercepta IndexedDB para Upload
    const original = { put: IDBObjectStore.prototype.put, add: IDBObjectStore.prototype.add, delete: IDBObjectStore.prototype.delete };

    IDBObjectStore.prototype.put = function (v, k) {
        const req = original.put.apply(this, arguments);
        const storeName = this.name;
        // Sincroniza apenas tabelas da plataforma
        if(storeName.includes('_plataforma')) {
            req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'put', k || e.target.result, v);
        }
        return req;
    };

    IDBObjectStore.prototype.add = function (v, k) {
        const req = original.add.apply(this, arguments);
        const storeName = this.name;
        if(storeName.includes('_plataforma')) {
            req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'add', k || e.target.result, v);
        }
        return req;
    };

    IDBObjectStore.prototype.delete = function (k) {
        const req = original.delete.apply(this, arguments);
        const storeName = this.name;
        if(storeName.includes('_plataforma')) {
            req.onsuccess = (e) => scheduleRealtimeUpload(storeName, 'delete', k, null);
        }
        return req;
    };

    // Download Loop (Simplificado)
    async function smartDownloadLoop() {
        const client = getClient();
        const userId = 'admin_system_user'; // Mock ID para manter sync ativo
        
        const { data, error } = await client.from(SYNC_TABLE).select('*').eq('db_name', CANONICAL_DB);
        if (error || !data || !data.length) return;

        const req = indexedDB.open(CANONICAL_DB);
        req.onsuccess = (e) => {
            const db = e.target.result;
            const tx = db.transaction(db.objectStoreNames, 'readwrite');
            isReplicating = true;

            data.forEach(r => {
                if (r.device_id === DEVICE_ID || !db.objectStoreNames.contains(r.store_name)) return;
                const store = tx.objectStore(r.store_name);
                const key = !isNaN(r.record_key) ? Number(r.record_key) : r.record_key;
                
                if (r.is_deleted) store.delete(key);
                else store.put(r.record_value);
            });
            
            tx.oncomplete = () => { isReplicating = false; };
        };
    }

    // Inicia Sync
    waitForSupabase().then(() => {
        console.log('Sync System Active for lg_crmDB');
        setInterval(smartDownloadLoop, 15000); // Sync a cada 15s
    });

})();
</script>
</body>
</html>
